# Nginx SSL reverse proxy for ApexMediation
# Requires certs issued at /etc/letsencrypt/live/{api.apexmediation.ee,console.apexmediation.ee}/
# NOTE: Common proxy headers and resolver are already defined in the HTTP config; do not duplicate here.

# API over HTTPS
server {
  listen 443 ssl http2;
  server_name api.apexmediation.ee;

  ssl_certificate     /etc/letsencrypt/live/api.apexmediation.ee/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/api.apexmediation.ee/privkey.pem;
  include /etc/nginx/snippets/ssl-params.conf;

  # OCSP stapling (optional)
  ssl_stapling on;
  ssl_stapling_verify on;

  # include /etc/nginx/snippets/metrics-basic-auth.conf;
  location /health { proxy_pass http://backend:8080/health; }
  location /metrics { proxy_pass http://backend:8080/metrics; }
  location / {
    proxy_pass http://backend:8080;
    proxy_read_timeout 60s;
    proxy_connect_timeout 5s;
  }
}

# Console over HTTPS (optional; will 502 if console service not running)
server {
  listen 443 ssl http2;
  server_name console.apexmediation.ee;

  ssl_certificate     /etc/letsencrypt/live/console.apexmediation.ee/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/console.apexmediation.ee/privkey.pem;
  include /etc/nginx/snippets/ssl-params.conf;

  ssl_stapling on;
  ssl_stapling_verify on;

  location / {
    proxy_pass http://console:3000;
    proxy_read_timeout 60s;
    proxy_connect_timeout 5s;
  }
}

# Website (marketing/landing page) over HTTPS
server {
  listen 443 ssl http2;
  server_name apexmediation.ee www.apexmediation.ee;

  ssl_certificate     /etc/letsencrypt/live/apexmediation.ee/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/apexmediation.ee/privkey.pem;
  include /etc/nginx/snippets/ssl-params.conf;

  ssl_stapling on;
  ssl_stapling_verify on;

  location / {
    proxy_pass http://website:3001;
    proxy_read_timeout 60s;
    proxy_connect_timeout 5s;
  }
}