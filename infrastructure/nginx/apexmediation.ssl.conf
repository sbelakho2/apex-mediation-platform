# Nginx HTTPS server blocks for ApexMediation (enable only after certs exist)
#
# Mount this file into /etc/nginx/conf.d/apexmediation.ssl.conf when certificates
# are present under /etc/letsencrypt/live/<domain>/ inside the container.
# See infrastructure/docker-compose.prod.yml for the optional mount line.

server {
  listen 443 ssl http2;
  server_name api.apexmediation.ee;

  # Certbot-managed paths on the droplet (mounted read-only into the container)
  ssl_certificate /etc/letsencrypt/live/api.apexmediation.ee/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/api.apexmediation.ee/privkey.pem;
  include /etc/nginx/snippets/ssl-params.conf;

  location /health {
    proxy_pass http://api_upstream/health;
  }

  location /metrics {
    # Optional: restrict by IP or add basic auth / mTLS (see infra plan)
    # Example 1 — IP allowlist
    # allow 127.0.0.1; deny all;
    # Example 2 — Basic Auth (create htpasswd and mount in compose)
    # include /etc/nginx/snippets/metrics-basic-auth.conf;
    proxy_pass http://api_upstream/metrics;
  }

  location / {
    proxy_pass http://api_upstream;
    proxy_read_timeout 60s;
    proxy_connect_timeout 5s;
  }
}

server {
  listen 443 ssl http2;
  server_name console.apexmediation.ee;

  # Certbot-managed paths on the droplet (mounted read-only into the container)
  ssl_certificate /etc/letsencrypt/live/console.apexmediation.ee/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/console.apexmediation.ee/privkey.pem;
  include /etc/nginx/snippets/ssl-params.conf;

  location / {
    proxy_pass http://console_upstream;
    proxy_read_timeout 60s;
    proxy_connect_timeout 5s;
  }
}
