networks:
  apex-net:
    driver: bridge

services:
  backend:
    build:
      context: ../backend
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - NODE_ENV=production
      - PORT=8080
      # Local default points to the local postgres service; override with real DO URL on droplet
      - DATABASE_URL=${DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/apexmediation}
      - DATABASE_SSL=${DATABASE_SSL:-false}
      # Local default points to the internal redis service with password
      - REDIS_URL=${REDIS_URL:-redis://:${REDIS_PASSWORD:-local-strong-password}@redis:6379/0}
      - CORS_ALLOWLIST=https://console.apexmediation.ee,https://apexmediation.ee
      # Minimal secrets required to satisfy backend env validation in local prod-like runs
      - JWT_SECRET=${JWT_SECRET:-local-secret-0123456789abcdef0123456789abcd}
      - COOKIE_SECRET=${COOKIE_SECRET:-local-cookie-0123456789abcdef0123456789}
    expose:
      - "8080"
    networks:
      - apex-net

  console:
    profiles:
      - ui
    build:
      context: ../console
      args:
        # Provide the public API URL at build time for Next.js static configuration
        NEXT_PUBLIC_API_URL: https://api.apexmediation.ee/api/v1
        # Gate type-checker during infra verification builds to avoid blocking on dev-only TS issues
        NEXT_IGNORE_TS_ERRORS: "1"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=https://api.apexmediation.ee/api/v1
    expose:
      - "3000"
    networks:
      - apex-net
    depends_on:
      - backend

  redis:
    image: redis:7-alpine
    command: [
      "redis-server",
      "--requirepass", "${REDIS_PASSWORD:-local-strong-password}",
      "--maxmemory", "512mb",
      "--maxmemory-policy", "allkeys-lru",
      "--appendonly", "yes"
    ]
    healthcheck:
      test: ["CMD", "sh", "-c", "redis-cli -a ${REDIS_PASSWORD:-local-strong-password} ping | grep PONG"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - apex-net
    expose:
      - "6379"

  # Optional local Postgres for pre‑DO validation (private bridge only)
  postgres:
    image: postgres:16-alpine
    environment:
      - POSTGRES_DB=apexmediation
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d apexmediation"]
      interval: 5s
      timeout: 5s
      retries: 12
    networks:
      - apex-net
    expose:
      - "5432"

  nginx:
    image: nginx:1.27-alpine
    depends_on:
      - backend
    ports:
      - "${NGINX_PORT:-8080}:80"
      # - "443:443" # Enable only after certificates exist and SSL config is mounted
    volumes:
      - ./nginx/apexmediation.conf:/etc/nginx/conf.d/apexmediation.conf:ro
      # Optional: enable HTTPS only after certs exist on the droplet
      # - ./nginx/apexmediation.ssl.conf:/etc/nginx/conf.d/apexmediation.ssl.conf:ro
      - ./nginx/snippets:/etc/nginx/snippets:ro
      # Optional: Basic Auth for /metrics — mount htpasswd directory
      - ./nginx/htpasswd:/etc/nginx/htpasswd:ro
      # Bind-mount host certs issued by certbot (run certbot on the droplet host)
      - /etc/letsencrypt:/etc/letsencrypt:ro
    networks:
      - apex-net
