openapi: 3.0.3
info:
  title: Billing API
  version: 1.0.0
  description: |
    RESTful API for usage tracking, invoice management, and billing reconciliation.
    Protected by JWT authentication with feature flag gating (BILLING_ENABLED).

servers:
  - url: https://api.rivalapex.com/v1
    description: Production
  - url: http://localhost:3000/v1
    description: Local development

security:
  - bearerAuth: []

tags:
  - name: Usage
    description: Real-time usage tracking and limits
  - name: Invoices
    description: Invoice retrieval and PDF generation
  - name: Reconciliation
    description: Manual reconciliation workflows
  - name: Meta
    description: Feature flags and billing metadata

paths:
  /billing/usage/current:
    get:
      summary: Get current billing period usage
      description: Returns aggregated usage metrics for the current billing cycle
      operationId: getCurrentUsage
      tags:
        - Usage
      parameters:
        - name: organizationId
          in: query
          required: true
          schema:
            type: string
            format: uuid
          description: Organization UUID
      responses:
        '200':
          description: Usage data retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CurrentUsage'
              example:
                period:
                  start: "2025-01-01T00:00:00Z"
                  end: "2025-01-31T23:59:59Z"
                metrics:
                  impressions: 1250000
                  clicks: 37500
                  videostarts: 18000
                  revenue: 12500.75
                limits:
                  impressions: 2000000
                  clicks: 100000
                  videostarts: 50000
                percentUsed:
                  impressions: 62.5
                  clicks: 37.5
                  videostarts: 36.0
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          description: Organization not found or no active subscription
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

  /billing/invoices:
    get:
      summary: List invoices
      description: Paginated list of invoices for an organization
      operationId: listInvoices
      tags:
        - Invoices
      parameters:
        - name: organizationId
          in: query
          required: true
          schema:
            type: string
            format: uuid
        - name: status
          in: query
          required: false
          schema:
            type: string
            enum: [draft, open, paid, void, uncollectible]
          description: Filter by invoice status
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        '200':
          description: Invoice list retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InvoiceList'
              example:
                invoices:
                  - id: in_1ABCD2
                    number: "INV-2025-001"
                    status: paid
                    amount_due: 12500
                    amount_paid: 12500
                    currency: usd
                    period_start: "2025-01-01T00:00:00Z"
                    period_end: "2025-01-31T23:59:59Z"
                    created: "2025-02-01T00:00:00Z"
                    due_date: "2025-02-15T00:00:00Z"
                    pdf_url: "https://api.rivalapex.com/v1/billing/invoices/in_1ABCD2/pdf"
                pagination:
                  current_page: 1
                  total_pages: 5
                  total_count: 93
                  has_more: true
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '500':
          $ref: '#/components/responses/InternalError'

  /billing/invoices/{invoiceId}/pdf:
    get:
      summary: Download invoice PDF
      description: Generates and streams a PDF invoice with usage breakdown
      operationId: downloadInvoicePdf
      tags:
        - Invoices
      parameters:
        - name: invoiceId
          in: path
          required: true
          schema:
            type: string
          description: Stripe invoice ID (e.g., in_1ABCD2)
      responses:
        '200':
          description: PDF generated successfully
          content:
            application/pdf:
              schema:
                type: string
                format: binary
          headers:
            Content-Disposition:
              schema:
                type: string
                example: 'attachment; filename="invoice-in_1ABCD2.pdf"'
            Content-Length:
              schema:
                type: integer
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          description: Invoice not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

  /billing/reconcile:
    post:
      summary: Trigger manual reconciliation
      description: |
        Reconciles Stripe usage records against internal ClickHouse data.
        Returns discrepancies and generates audit logs. Idempotent via request ID.
      operationId: reconcileUsage
      tags:
        - Reconciliation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReconcileRequest'
            example:
              organization_id: "550e8400-e29b-41d4-a716-446655440000"
              period_start: "2025-01-01T00:00:00Z"
              period_end: "2025-01-31T23:59:59Z"
              idempotency_key: "reconcile-550e8400-2025-01"
      responses:
        '200':
          description: Reconciliation completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReconcileResponse'
              example:
                status: completed
                summary:
                  impressions_stripe: 1250000
                  impressions_clickhouse: 1250000
                  clicks_stripe: 37500
                  clicks_clickhouse: 37501
                  videostarts_stripe: 18000
                  videostarts_clickhouse: 18000
                discrepancies:
                  - metric: clicks
                    stripe_value: 37500
                    clickhouse_value: 37501
                    diff: 1
                    diff_percent: 0.003
                audit_log_id: "audit_1234567890"
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '409':
          description: Reconciliation already in progress
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

  /meta/features:
    get:
      summary: Get feature flags
      description: Returns enabled feature flags for the current user/organization
      operationId: getFeatureFlags
      tags:
        - Meta
      responses:
        '200':
          description: Feature flags retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeatureFlags'
              example:
                billing_enabled: true
                usage_limits_enabled: true
                invoice_pdf_generation: true
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from authentication endpoint

  schemas:
    CurrentUsage:
      type: object
      required:
        - period
        - metrics
        - limits
        - percentUsed
      properties:
        period:
          type: object
          required:
            - start
            - end
          properties:
            start:
              type: string
              format: date-time
            end:
              type: string
              format: date-time
        metrics:
          type: object
          required:
            - impressions
            - clicks
            - videostarts
            - revenue
          properties:
            impressions:
              type: integer
              minimum: 0
            clicks:
              type: integer
              minimum: 0
            videostarts:
              type: integer
              minimum: 0
            revenue:
              type: number
              format: double
              minimum: 0
        limits:
          type: object
          required:
            - impressions
            - clicks
            - videostarts
          properties:
            impressions:
              type: integer
              minimum: 0
            clicks:
              type: integer
              minimum: 0
            videostarts:
              type: integer
              minimum: 0
        percentUsed:
          type: object
          required:
            - impressions
            - clicks
            - videostarts
          properties:
            impressions:
              type: number
              format: float
              minimum: 0
              maximum: 100
            clicks:
              type: number
              format: float
              minimum: 0
              maximum: 100
            videostarts:
              type: number
              format: float
              minimum: 0
              maximum: 100

    InvoiceList:
      type: object
      required:
        - invoices
        - pagination
      properties:
        invoices:
          type: array
          items:
            $ref: '#/components/schemas/Invoice'
        pagination:
          $ref: '#/components/schemas/Pagination'

    Invoice:
      type: object
      required:
        - id
        - status
        - amount_due
        - amount_paid
        - currency
        - created
      properties:
        id:
          type: string
          description: Stripe invoice ID
        number:
          type: string
          description: Human-readable invoice number
        status:
          type: string
          enum: [draft, open, paid, void, uncollectible]
        amount_due:
          type: integer
          description: Amount due in cents
        amount_paid:
          type: integer
          description: Amount paid in cents
        currency:
          type: string
          pattern: '^[a-z]{3}$'
          example: usd
        period_start:
          type: string
          format: date-time
        period_end:
          type: string
          format: date-time
        created:
          type: string
          format: date-time
        due_date:
          type: string
          format: date-time
          nullable: true
        pdf_url:
          type: string
          format: uri
          description: URL to download PDF

    ReconcileRequest:
      type: object
      required:
        - organization_id
        - period_start
        - period_end
      properties:
        organization_id:
          type: string
          format: uuid
        period_start:
          type: string
          format: date-time
        period_end:
          type: string
          format: date-time
        idempotency_key:
          type: string
          description: Optional idempotency key for safe retries

    ReconcileResponse:
      type: object
      required:
        - status
        - summary
      properties:
        status:
          type: string
          enum: [completed, in_progress, failed]
        summary:
          type: object
          additionalProperties:
            type: integer
          description: Metric counts from both systems
        discrepancies:
          type: array
          items:
            $ref: '#/components/schemas/Discrepancy'
        audit_log_id:
          type: string

    Discrepancy:
      type: object
      required:
        - metric
        - stripe_value
        - clickhouse_value
        - diff
        - diff_percent
      properties:
        metric:
          type: string
        stripe_value:
          type: integer
        clickhouse_value:
          type: integer
        diff:
          type: integer
        diff_percent:
          type: number
          format: float

    FeatureFlags:
      type: object
      properties:
        billing_enabled:
          type: boolean
        usage_limits_enabled:
          type: boolean
        invoice_pdf_generation:
          type: boolean

    Pagination:
      type: object
      required:
        - current_page
        - total_pages
        - total_count
        - has_more
      properties:
        current_page:
          type: integer
          minimum: 1
        total_pages:
          type: integer
          minimum: 0
        total_count:
          type: integer
          minimum: 0
        has_more:
          type: boolean

    Error:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          example: not_found
        message:
          type: string
          example: Invoice not found
        details:
          type: object
          additionalProperties: true

  responses:
    UnauthorizedError:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: unauthorized
            message: Missing or invalid JWT token

    ForbiddenError:
      description: Insufficient permissions or feature disabled
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: forbidden
            message: Billing feature not enabled for this organization

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: internal_error
            message: An unexpected error occurred
