openapi: 3.0.3
info:
  title: Apex Mediation API
  version: 1.0.0
servers:
  - url: http://localhost:4000/api/v1
paths:
  /placements:
    get:
      summary: List placements
      description: Returns a paginated list of placements for the authenticated publisher. Includes the `config` document when present.
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
          description: Page number (1-based)
        - in: query
          name: pageSize
          schema:
            type: integer
            minimum: 1
            maximum: 200
          description: Page size (default 50, max 200)
        - in: query
          name: format
          schema:
            type: string
            enum: [banner, interstitial, rewarded, native]
          description: Optional filter by placement type/format
      responses:
        '200':
          description: Paginated placement list
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/PlacementListResponse'
    post:
      summary: Create a placement
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PlacementCreateRequest'
      responses:
        '201':
          description: Placement created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Placement'
        '400':
          description: Invalid input
  /placements/{id}:
    get:
      summary: Get placement
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Placement details
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Placement'
        '404':
          description: Not found
    put:
      summary: Update placement
      description: Updates top-level fields and optionally replaces the full `config` document.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PlacementUpdateRequest'
      responses:
        '200':
          description: Updated placement
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Placement'
        '400':
          description: Invalid input
        '404':
          description: Not found
    patch:
      summary: Patch placement (deep-merge config)
      description: |
        Partially updates a placement. Top-level fields like `name`/`status` are updated directly. When a `config` object is provided, it is deep-merged with the existing config using non-destructive semantics: nested objects are merged; arrays replace existing arrays; primitives replace existing values.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PlacementUpdateRequest'
            examples:
              updatePricing:
                summary: Update floor price
                value:
                  config:
                    pricing:
                      floorPriceCents: 75
                      currency: "USD"
              addSdkIds:
                summary: Add SDK unit IDs
                value:
                  config:
                    sdk:
                      unitIdIos: "com.app.ios.banner.home"
                      unitIdAndroid: "com.app.android.banner.home"
      responses:
        '200':
          description: Patched placement
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Placement'
        '400':
          description: Invalid input
        '404':
          description: Not found
    delete:
      summary: Delete placement
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Deletion acknowledgement
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
  /auth/login:
    post:
      summary: Authenticate user and return JWT token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
      responses:
        '200':
          description: Successful authentication
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid credentials
  /revenue/summary:
    get:
      summary: Get revenue summary
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Revenue summary data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RevenueSummary'
  /rtb/bid:
    post:
      summary: Execute RTB bid request
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BidRequest'
      responses:
        '200':
          description: Winning bid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BidResponse'
        '204':
          description: No eligible bids
  /migration/experiments:
    get:
      summary: List migration experiments for the authenticated publisher
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: status
          schema:
            type: string
            enum: [draft, active, paused, completed, archived]
          description: Optional status filter
        - in: query
          name: placement_id
          schema:
            type: string
          description: Filter by placement identifier
      responses:
        '200':
          description: List of migration experiments
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MigrationExperimentListResponse'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
    post:
      summary: Create a new migration experiment
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MigrationExperimentCreateRequest'
      responses:
        '201':
          description: Experiment created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MigrationExperimentResponse'
        '400':
          description: Invalid input
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
  /migration/experiments/{experimentId}:
    get:
      summary: Get details for a specific migration experiment
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: experimentId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Experiment details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MigrationExperimentResponse'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Experiment not found
    put:
      summary: Update a migration experiment
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: experimentId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MigrationExperimentUpdateRequest'
      responses:
        '200':
          description: Updated experiment information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MigrationExperimentResponse'
        '400':
          description: Invalid payload
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Experiment not found
    delete:
      summary: Archive a migration experiment
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: experimentId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Experiment archived
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Experiment not found
  /migration/experiments/{experimentId}/activate:
    post:
      summary: Activate a migration experiment with a mirror percentage
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: experimentId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MigrationExperimentActivateRequest'
      responses:
        '200':
          description: Experiment activated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MigrationExperimentResponse'
        '400':
          description: Invalid input
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Experiment not found
  /migration/experiments/{experimentId}/pause:
    post:
      summary: Pause an active migration experiment
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: experimentId
          required: true
          schema:
            type: string
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MigrationExperimentPauseRequest'
      responses:
        '200':
          description: Experiment paused
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MigrationExperimentResponse'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Experiment not found
  /migration/experiments/{experimentId}/guardrails/evaluate:
    post:
      summary: Evaluate guardrails for an experiment
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: experimentId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Guardrail evaluation result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MigrationGuardrailEvaluationResponse'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Experiment not found
  /migration/import:
    post:
      summary: Create or update a migration import job
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/MigrationImportRequest'
            encoding:
              credentials:
                contentType: application/json
      responses:
        '201':
          description: Import created or updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MigrationImportResponse'
        '400':
          description: Invalid import payload
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
  /migration/import/{importId}/finalize:
    post:
      summary: Finalize an import after mappings are reviewed
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: importId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Finalized import details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MigrationImportResponse'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Import not found
  /migration/mappings/{mappingId}:
    put:
      summary: Update mapping resolution details
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: mappingId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MigrationMappingUpdateRequest'
      responses:
        '200':
          description: Updated mapping and summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MigrationMappingUpdateResponse'
        '400':
          description: Invalid payload
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Mapping not found
  /migration/assign:
    post:
      summary: Retrieve assignment metadata for a device placement pair
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MigrationAssignmentRequest'
      responses:
        '200':
          description: Assignment metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MigrationAssignmentResponse'
        '400':
          description: Invalid payload
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    AuthResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            token:
              type: string
            user:
              type: object
              properties:
                id:
                  type: string
                email:
                  type: string
                publisherId:
                  type: string
    RevenueSummary:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            today:
              type: number
            yesterday:
              type: number
            thisMonth:
              type: number
            lastMonth:
              type: number
            lifetime:
              type: number
    BidRequest:
      type: object
      required:
        - requestId
        - placementId
        - adFormat
        - floorCpm
        - device
        - user
        - app
      properties:
        requestId:
          type: string
          format: uuid
        placementId:
          type: string
        adFormat:
          type: string
          enum: [banner, interstitial, rewarded, native]
        floorCpm:
          type: number
        device:
          type: object
          properties:
            platform:
              type: string
            osVersion:
              type: string
            model:
              type: string
        user:
          type: object
          properties:
            country:
              type: string
            language:
              type: string
        app:
          type: object
          properties:
            id:
              type: string
            name:
              type: string
            bundle:
              type: string
            version:
              type: string
        signal:
          type: object
          description: Arbitrary SDK runtime signals forwarded with the auction request.
          additionalProperties: true
          properties:
            migration:
              type: object
              description: Migration Studio experiment labels attached by the SDK.
              properties:
                experiment_id:
                  type: string
                arm:
                  type: string
                  enum: [control, test]
                assignment_ts:
                  type: string
                  format: date-time
                mirror_percent:
                  type: number
                mode:
                  type: string
                  enum: [shadow, mirroring]
                feature_flag_source:
                  type: string
                  description: Scope where the migration feature flag was enabled.
                  enum: [placement, app, publisher, default]

    BidResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            bidId:
              type: string
            adapter:
              type: string
            cpm:
              type: number
            currency:
              type: string
            creativeUrl:
              type: string
    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
    MigrationGuardrails:
      type: object
      properties:
        latency_budget_ms:
          type: integer
          format: int32
        revenue_floor_percent:
          type: number
        max_error_rate_percent:
          type: number
        min_impressions:
          type: integer
          format: int32
      required: [latency_budget_ms, revenue_floor_percent, max_error_rate_percent, min_impressions]
    MigrationExperiment:
      type: object
      properties:
        id:
          type: string
        publisher_id:
          type: string
        name:
          type: string
        description:
          type: string
        app_id:
          type: string
          nullable: true
        placement_id:
          type: string
          nullable: true
        objective:
          type: string
          enum: [revenue_comparison, fill_rate, latency]
        seed:
          type: string
        mirror_percent:
          type: number
        mode:
          type: string
          enum: [shadow, mirroring]
        status:
          type: string
          enum: [draft, active, paused, completed, archived]
        activated_at:
          type: string
          format: date-time
          nullable: true
        paused_at:
          type: string
          format: date-time
          nullable: true
        completed_at:
          type: string
          format: date-time
          nullable: true
        last_guardrail_check:
          type: string
          format: date-time
          nullable: true
        guardrails:
          $ref: '#/components/schemas/MigrationGuardrails'
        created_by:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      required:
        - id
        - publisher_id
        - name
        - objective
        - seed
        - mirror_percent
        - mode
        - status
        - guardrails
        - created_at
        - updated_at
    MigrationExperimentCreateRequest:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        app_id:
          type: string
        placement_id:
          type: string
        objective:
          type: string
          enum: [revenue_comparison, fill_rate, latency]
        seed:
          type: string
        guardrails:
          type: object
          description: Optional overrides for default guardrails
          additionalProperties: true
      required: [name]
    MigrationExperimentUpdateRequest:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        mirror_percent:
          type: number
        guardrails:
          type: object
          additionalProperties: true
    MigrationExperimentActivateRequest:
      type: object
      properties:
        mirror_percent:
          type: number
          minimum: 0
          maximum: 20
        mode:
          type: string
          enum: [shadow, mirroring]
      required: [mirror_percent]
    MigrationExperimentPauseRequest:
      type: object
      properties:
        reason:
          type: string
    MigrationExperimentResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          $ref: '#/components/schemas/MigrationExperiment'
    MigrationExperimentListResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: array
          items:
            $ref: '#/components/schemas/MigrationExperiment'
    MigrationAssignmentRequest:
      type: object
      properties:
        user_identifier:
          type: string
        placement_id:
          type: string
      required: [user_identifier, placement_id]
    MigrationAssignmentPayload:
      type: object
      properties:
        has_experiment:
          type: boolean
        experiment_id:
          type: string
          nullable: true
        arm:
          type: string
          enum: [control, test]
        mirror_percent:
          type: number
          nullable: true
        assignment_ts:
          type: string
          format: date-time
          nullable: true
        mode:
          type: string
          enum: [shadow, mirroring]
          nullable: true
        feature_flag_source:
          type: string
          enum: [placement, app, publisher, default]
          nullable: true
      required: [has_experiment, arm]
    MigrationAssignmentResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          $ref: '#/components/schemas/MigrationAssignmentPayload'
    MigrationImportSummary:
      type: object
      properties:
        total_mappings:
          type: integer
        status_breakdown:
          type: object
          properties:
            pending:
              type: integer
            confirmed:
              type: integer
            skipped:
              type: integer
            conflict:
              type: integer
          additionalProperties: false
        confidence_breakdown:
          type: object
          properties:
            high:
              type: integer
            medium:
              type: integer
            low:
              type: integer
          additionalProperties: false
        unique_networks:
          type: integer
      required: [total_mappings, status_breakdown, confidence_breakdown, unique_networks]
    MigrationMapping:
      type: object
      properties:
        id:
          type: string
        experiment_id:
          type: string
        incumbent_network:
          type: string
        incumbent_instance_id:
          type: string
        incumbent_instance_name:
          type: string
          nullable: true
        incumbent_waterfall_position:
          type: integer
          nullable: true
        incumbent_ecpm_cents:
          type: integer
          nullable: true
        our_adapter_id:
          type: string
          nullable: true
        our_adapter_name:
          type: string
          nullable: true
        mapping_status:
          type: string
          enum: [pending, confirmed, skipped, conflict]
        mapping_confidence:
          type: string
          enum: [high, medium, low]
        conflict_reason:
          type: string
          nullable: true
        resolved_by:
          type: string
          nullable: true
        resolved_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      required:
        - id
        - experiment_id
        - incumbent_network
        - incumbent_instance_id
        - mapping_status
        - mapping_confidence
        - created_at
        - updated_at
    MigrationSignedComparisonMetric:
      type: object
      properties:
        label:
          type: string
        unit:
          type: string
          enum: [currency_cents, percent, milliseconds]
        control:
          type: number
        test:
          type: number
        uplift_percent:
          type: number
      required: [label, unit, control, test, uplift_percent]
    MigrationSignedComparison:
      type: object
      properties:
        generated_at:
          type: string
        sample_size:
          type: object
          properties:
            control_impressions:
              type: integer
            test_impressions:
              type: integer
          required: [control_impressions, test_impressions]
        metrics:
          type: object
          properties:
            ecpm:
              $ref: '#/components/schemas/MigrationSignedComparisonMetric'
            fill:
              $ref: '#/components/schemas/MigrationSignedComparisonMetric'
            latency_p50:
              $ref: '#/components/schemas/MigrationSignedComparisonMetric'
            latency_p95:
              $ref: '#/components/schemas/MigrationSignedComparisonMetric'
            ivt_adjusted_revenue:
              $ref: '#/components/schemas/MigrationSignedComparisonMetric'
        confidence_band:
          type: object
          properties:
            lower:
              type: number
            upper:
              type: number
            confidence_level:
              type: number
            method:
              type: string
        signature:
          type: object
          properties:
            key_id:
              type: string
            algo:
              type: string
            payload_base64:
              type: string
            signature_base64:
              type: string
            public_key_base64:
              type: string
    MigrationImportRequest:
      type: object
      properties:
        source:
          type: string
          enum: [csv, ironSource, applovin]
        placement_id:
          type: string
        experiment_id:
          type: string
        credentials:
          type: string
          description: JSON credentials payload when using API connectors
        api_key:
          type: string
        account_id:
          type: string
        file:
          type: string
          format: binary
      required: [source, placement_id]
    MigrationImportPayload:
      type: object
      properties:
        import_id:
          type: string
        experiment_id:
          type: string
          nullable: true
        placement_id:
          type: string
        source:
          type: string
        status:
          type: string
        created_at:
          type: string
          format: date-time
        summary:
          $ref: '#/components/schemas/MigrationImportSummary'
        mappings:
          type: array
          items:
            $ref: '#/components/schemas/MigrationMapping'
        signed_comparison:
          $ref: '#/components/schemas/MigrationSignedComparison'
          nullable: true
      required:
        - import_id
        - experiment_id
        - placement_id
        - source
        - status
        - created_at
        - summary
        - mappings
    MigrationImportResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          $ref: '#/components/schemas/MigrationImportPayload'
    MigrationMappingUpdateRequest:
      type: object
      properties:
        our_adapter_id:
          type: string
        status:
          type: string
          enum: [pending, confirmed, skipped, conflict]
        notes:
          type: string
    MigrationMappingUpdateResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            mapping:
              $ref: '#/components/schemas/MigrationMapping'
            summary:
              $ref: '#/components/schemas/MigrationImportSummary'
    MigrationGuardrailEvaluationResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            shouldPause:
              type: boolean
            violations:
              type: array
              items:
                type: string

    # Placements schemas (added)
    Placement:
      type: object
      properties:
        id:
          type: string
        app_id:
          type: string
        name:
          type: string
        type:
          type: string
          enum: [banner, interstitial, rewarded, native]
        status:
          type: string
          enum: [active, paused]
        created_at:
          type: string
          format: date-time
        config:
          $ref: '#/components/schemas/PlacementConfig'
      required: [id, app_id, name, type, status, created_at]

    PlacementConfig:
      type: object
      description: Placement configuration for targeting, delivery, pricing, SDK unit IDs, and metadata.
      properties:
        targeting:
          type: object
          properties:
            geos:
              type: array
              items:
                type: string
                pattern: '^[A-Z]{2}$'
            platforms:
              type: array
              items:
                type: string
                enum: [ios, android, unity, web]
            osVersions:
              type: object
              additionalProperties:
                type: string
            appVersions:
              type: array
              items:
                type: string
        delivery:
          type: object
          properties:
            frequencyCap:
              type: object
              properties:
                count:
                  type: integer
                  minimum: 0
                per:
                  type: string
                  enum: [minute, hour, day]
            pacing:
              type: object
              properties:
                impressionsPerMinute:
                  type: integer
                  minimum: 0
        pricing:
          type: object
          properties:
            floorPriceCents:
              type: integer
              minimum: 0
            currency:
              type: string
              pattern: '^[A-Z]{3}$'
        sdk:
          type: object
          properties:
            unitIdIos:
              type: string
            unitIdAndroid:
              type: string
            unitIdUnity:
              type: string
            unitIdWeb:
              type: string
        metadata:
          type: object
          properties:
            labels:
              type: array
              items:
                type: string
            notes:
              type: string

    PlacementListResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Placement'
        total:
          type: integer
        page:
          type: integer
        pageSize:
          type: integer
      required: [items, total, page, pageSize]

    PlacementCreateRequest:
      type: object
      properties:
        name:
          type: string
        type:
          type: string
          enum: [banner, interstitial, rewarded, native]
        appId:
          type: string
        platform:
          type: string
          enum: [ios, android, unity, web]
        config:
          $ref: '#/components/schemas/PlacementConfig'
      required: [name, type, appId, platform]

    PlacementUpdateRequest:
      type: object
      properties:
        name:
          type: string
        status:
          type: string
          enum: [active, paused]
        config:
          $ref: '#/components/schemas/PlacementConfig'
