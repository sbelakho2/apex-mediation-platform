# AD-Project File-by-File Analysis

_Last updated: 2025-11-14 00:00 UTC_
_Owner: Platform Engineering 

## Objectives
- Provide a repeatable, auditable record of what every file in the repository does, its dependencies, and its current health.
- Capture follow-up actions (defects, debt, docs gaps) as we review individual files.
- Enable incremental updates as the codebase evolves by organizing the analysis by top-level areas.

## Scope & Order of Operations
We will progress directory by directory so that work remains reviewable and can be parallelized later if needed. Each section below mirrors the repo’s top-level layout and will be checked off once **every file** within that section has been captured in the log.

1. Root files (repository top level)
2. `backend/`
3. `console/`
4. `data/` & `ML Data/`
5. `docs/`
6. `infrastructure/`, `monitoring/`, `logs/`
7. `ML/`
8. `models/`
9. `packages/` & `Packages/`
10. `quality/`
11. `scripts/`
12. `sdk/` & `sdks/`
13. `services/`
14. `website/`
15. Remaining folders (`packages/web-sdk`, vendor SDKs, etc.)

> ⚠️ **Expectation:** Each section must contain an entry for every file (source, config, schema, migration, etc.). Generated artifacts (lockfiles, build caches) will be summarized if they are deterministic.

## Data Capture Template
For every file we will record the following fields:

| Field | Description |
| --- | --- |
| Path | Absolute path within repo |
| Type | Source / Config / Doc / Script / Asset / Generated |
| Summary | Short description of purpose and key behaviors |
| Dependencies | Notable internal/external deps referenced |
| Risks / TODOs | Bugs, debt, missing tests, stale docs, etc. |
| Evidence | Links to tests, docs, or commands validating behavior |

## Recording Method
- Use this Markdown file as the canonical log. Each top-level section below contains nested subsections mirroring the directory tree.
- Whenever we finish reviewing a file, add a bullet under its directory with the template above (concise inline format is acceptable to keep the document readable).
- Cross-link to existing docs (e.g., `docs/Internal/Development/DEVELOPMENT_TODO_CHECKLIST.md`) instead of duplicating detail.

## Progress Tracker
The following checklist mirrors the TODO list maintained in `DEVELOPMENT_TODO_CHECKLIST.md`. Update both places as you progress to keep stakeholders in sync.

- [ ] Root-level files analyzed
- [ ] `backend/`
- [ ] `console/`
- [ ] `data/` & ML datasets
- [ ] `docs/`
- [ ] `infrastructure/`, `monitoring/`, `logs/`
- [ ] `ML/`
- [ ] `models/`
- [ ] `packages/`, `Packages/`
- [ ] `quality/`
- [ ] `scripts/`
- [ ] `sdk/`, `sdks/`
- [ ] `services/`
- [ ] `website/`
- [ ] Remaining folders / verification

## Section Logs

### Root-Level Files

- `docker-compose.yml` — **Type:** Config (Docker Compose v3.9). **Summary:** Spins up backend (Node), console (Next.js), Postgres 16, Redis 7, ClickHouse 23.9, plus optional ML CPU/GPU training workers sharing the repo via bind mounts. **Dependencies:** Backend migrations auto-run via `/backend/migrations`, ML containers depend on `Dockerfile.ml*`. **Risks/TODOs:** Secrets (JWT, DB creds) are placeholder defaults; ClickHouse lacks a persistent volume; only backend is exposed to console (no website). **Evidence:** File reviewed 2025‑11‑14; run `docker compose up` for integrated stack.
- `Dockerfile.ml` — **Type:** Config (Docker image). **Summary:** Python 3.12 slim image installing `ML/requirements.txt`, copies ML + scripts, sets entrypoint to `scripts/ml/train_models.py`. **Dependencies:** Pip requirements; host repo volume when used via compose. **Risks/TODOs:** No caching between installs; CPU-only so heavy torch jobs may be slow. **Evidence:** Compose profile `ml` references this file.
- `Dockerfile.ml-gpu` — **Type:** Config. **Summary:** Based on `pytorch/pytorch:2.5.1-cuda12.4-cudnn9-runtime`, installs `requirements-gpu`, same entrypoint as CPU image, requires GPU reservations. **Dependencies:** CUDA 12 drivers on host; ML GPU requirements file. **Risks/TODOs:** No healthcheck; make sure host has matching NVIDIA runtime. **Evidence:** Compose service `ml-train-gpu` references this file.
- `Makefile` — **Type:** Build tooling. **Summary:** Provides four ML-focused phony targets: `ml.fetch`, `ml.prepare`, `ml.train`, `ml.train.gpu`; wraps Python scripts and docker compose runs with overridable dataset/output vars. **Dependencies:** `PYTHON` binary, `scripts/ml/*.py`, `docker compose`. **Risks/TODOs:** No general frontend/backend targets; consider adding lint/test aggregators later. **Evidence:** Reviewed file 2025‑11‑14.
- `package.json` — **Type:** Config (npm workspace root). **Summary:** Defines workspaces (`backend`, `console`, `packages/*`, `sdk/*`, `quality/*`, `tools/*`), shared scripts for build/test/lint/migrate/dev, devDependencies (TypeScript, Jest, ESLint, Prettier, Husky). **Dependencies:** Node ≥18/NPM ≥9, husky hooks, k6 for perf tests. **Risks/TODOs:** Root scripts run `npm run build --workspaces`, which can be slow; consider pnpm/turbo for scaling. **Evidence:** File reviewed 2025‑11‑14.
- `package-lock.json` — **Type:** Generated lockfile. **Summary:** Ensures deterministic installs for root tooling + shared devDependencies. **Dependencies:** npm; covers multi-workspace tree. **Risks/TODOs:** Very large; keep updated when new deps added to avoid drift. **Evidence:** Present at root, last regenerated 2025‑11‑12 (per git log – verify when diffing).
- `start-dev.sh` — **Type:** Script. **Summary:** Bash helper that prints friendly status and launches `console` dev server with mock data using `npm run dev`. **Dependencies:** Node/npm, console workspace. **Risks/TODOs:** Only starts console (no API); consider flag to boot backend via docker compose too. **Evidence:** Script reviewed 2025‑11‑14; shebang bash.
- `local.properties` — **Type:** Config (Android SDK path). **Summary:** Points Gradle to `/home/aaron/Android/Sdk`; standard Android studio artifact, intentionally not version-controlled (ignored via `.gitignore`). **Dependencies:** Android build tooling when working on native SDK. **Risks/TODOs:** Local-only; ensure devs don’t commit updates. **Evidence:** File timestamp 2025‑11‑12.
- `.gitignore` — **Type:** Config. **Summary:** Comprehensive ignore list covering Node, Python, Android, Unity, Terraform, Docker, ML datasets (Criteo, Avazu), SBOM outputs, bundle reports, etc. **Dependencies:** Git. **Risks/TODOs:** Currently ignores `gradlew` (but re-adds `sdk/core/android/gradlew.sh`); verify no required binaries are skipped. **Evidence:** Reviewed 2025‑11‑14.
- `Logo.jpg` — **Type:** Asset. **Summary:** Brand/logo image used in docs? (binary). **Dependencies:** Consumed by marketing materials. **Risks/TODOs:** No source PSD provided; ensure licensing tracked.
- `Solo_Execution_Business_Plan_AdStack_Bel_Consulting_OU.docx` — **Type:** Doc asset. **Summary:** Business plan reference; likely external facing. **Dependencies:** MS Word. **Risks/TODOs:** This belongs in repo and should be updated with most recent state of software.
- `Website.docx` — **Type:** Doc asset. **Summary:** Likely legacy website content plan; verify currency vs docs/Website sections. **Risks/TODOs:** Consider migrating into Markdown for easier diffing.
- `node_modules/` — **Type:** Generated directory. **Summary:** Root dependency install location (currently committed in workspace for caching but should stay ignored). **Risks/TODOs:** Ensure `.gitignore` prevents accidental commits; prefer per-workspace installs if size grows.

### backend/

- `.env.example` — **Type:** Config template. **Summary:** Minimal dev defaults for DB, ClickHouse, Redis, JWT, transparency knobs. **Dependencies:** Local Postgres/Redis/ClickHouse; transparency writer. **Risks/TODOs:** Includes placeholder secrets; ensure developers don’t reuse in prod. **Evidence:** Reviewed 2025‑11‑14.
- `.env.sample` — **Type:** Config template (annotated). **Summary:** Extensive sample with sections for DB, Redis, CORS, Stripe, Resend, OpenAI, feature flags, monitoring. **Dependencies:** External providers (Stripe, Resend, AWS, GCP). **Risks/TODOs:** Flags default to true; warn devs before enabling expensive services. **Evidence:** Reviewed 2025‑11‑14.
- `.eslintrc.cjs` — **Type:** Lint config. **Summary:** TS ESLint setup with project-based parser, rules for async misuse, overrides for controllers/tests/services. **Dependencies:** `@typescript-eslint/*`. **Risks/TODOs:** Relies on `tsconfig.eslint.json`; ensure IDE uses same root. **Evidence:** Reviewed file.
- `.gitignore` (backend) — **Type:** Config. **Summary:** Backend-specific ignore (dist, logs, coverage, env files). **Dependencies:** Git. **Risks/TODOs:** Verify `dist/` remains excluded in CI artifacts.
- `.transparency-metrics.log` — **Type:** Log artifact. **Summary:** Captures transparency writer test run (connections, breaker trips, ClickHouse errors). **Dependencies:** Observability scripts. **Risks/TODOs:** Contains timestamps/error messages; rotate or move to logs/ to avoid repo bloat.
- `BACKGROUND_JOBS.md` — **Type:** Doc. **Summary:** 600+ line deep dive into BullMQ queues (analytics, export, reports, metrics, cache warming, cleanup) with configs, payloads, schedules. **Dependencies:** `src/queues/**/*.ts`. **Risks/TODOs:** Need to confirm queue naming issue (“Queue name cannot contain :” seen in logs) is documented with fix. **Evidence:** Reviewed overview + queue sections.
- `Dockerfile` — **Type:** Build config (broken). **Summary:** Intended to be multi-stage Node build to distroless runtime, but file is badly corrupted with Kubernetes Deployment YAML interleaved (invalid Docker syntax). **Dependencies:** Node 20, distroless runtime. **Risks/TODOs:** HIGH – cannot build as-is; needs restoration (likely missing newline separators). Blocks container builds + fly deploy. **Evidence:** File inspection shows `metadata:`/`spec:` lines inside Dockerfile.
- `Dockerfile` referenced in `fly.toml` & `deploy-backend.sh`; fix required before deployments resume.
- `deploy-backend.sh` — **Type:** Script. **Summary:** Automates Fly.io deploy (staging/prod) with CLI checks, app creation, secret prompts, region scaling, post-deploy health checks. **Dependencies:** Fly CLI, curl, sed. **Risks/TODOs:** Mutation of `fly.toml` via `sed -i` for production may dirty repo; consider using env overlays. Requires manual confirmation for secrets.
- `fly.toml` — **Type:** Infra config. **Summary:** Fly.io app config (SJC region, docker build, HTTP checks, TLS, autoscaling triggers, log volume mount). **Dependencies:** Fly platform. **Risks/TODOs:** `PORT` mismatches (8080 here vs 4000 default). Ensure runtime `CMD` binds 8080 when deployed via Fly.
- `IMPLEMENTATION_SUMMARY.md` — **Type:** Doc. **Summary:** Tracks completion of exports, A/B tests, caching, background jobs, metrics; lists files/tests/perf impacts. **Dependencies:** Various services + migrations. **Risks/TODOs:** States “All features complete”; need to keep updated as new work added.
- `REDIS_CACHING.md` — **Type:** Doc. **Summary:** Detailed caching strategy (TTL tiers, vary-by, invalidation patterns, client API). **Dependencies:** `src/utils/redis.ts`, `src/middleware/cache.ts`. **Risks/TODOs:** Example TTL table uses TypeScript pseudo-code; confirm docs match current constants.
- `openapi.yaml` — **Type:** API spec. **Summary:** 900+ line OpenAPI 3.0.3 covering auth, RTB, migration studio, billing, etc., with schemas + security definitions. **Dependencies:** `@asteasolutions/zod-to-openapi`, swagger UI. **Risks/TODOs:** Ensure spec stays aligned with feature-flagged endpoints; consider splitting by domain to reduce merge conflicts.
- `package.json` — **Type:** Config. **Summary:** Scripts for dev/build/start/test/migrations, ClickHouse helpers, transparency verification, infisical-backed secure tasks; dependencies span Express, Stripe, Redis, BullMQ, ClickHouse. **Dependencies:** Node 20, ts-node, jest. **Risks/TODOs:** Some scripts still reference legacy `runMigrations.js` (not V2); verify both paths supported. Observed formatting glitch (indented fields) but JSON valid.
- `package-lock.json` — **Type:** Lockfile. **Summary:** Deterministic dependency tree for backend service. **Dependencies:** npm. **Risks/TODOs:** Keep in sync with `package.json`; remove unused packages (e.g., `openai` if not shipped).
- `tsconfig.json` / `tsconfig.eslint.json` — **Type:** Config. **Summary:** ES2020 target, `rootDir`=repo, includes `src/services/scripts`, outputs `dist`, excludes tests from build. ESLint variant narrows include to src/tests. **Dependencies:** `typescript` 5.5. **Risks/TODOs:** Build currently skips `tests` folder entirely; OK if tests compile via jest.
- `jest.config.cjs` — **Type:** Test config. **Summary:** `ts-jest` preset, node env, serialized runs (maxWorkers=1) to avoid DB contention, setup file `src/__tests__/setup.ts`, 10s timeout. **Dependencies:** jest, ts-jest. **Risks/TODOs:** Serial tests slow; consider DB container per worker.
- `.transparency-metrics.log` indicates queue init failures due to colon in queue names; action item to sanitize queue IDs.
- `deploy-backend.sh` & `fly.toml` rely on `Dockerfile`; unresolved corruption blocks release pipeline.
- `src/index.ts` — **Type:** Source. **Summary:** Express bootstrap wiring helmet, cors allowlist, CSRF double-submit, Redis-backed auth limiter, request context + Prometheus RED metrics, `/health`/`/metrics`, OpenAPI serve, and graceful shutdown. Initializes Postgres, ClickHouse, Redis, BullMQ queues sequentially with fallbacks. **Dependencies:** `initializeDatabase`, `initializeClickHouse`, `redis`, `initializeQueues`, `authRateLimiter`, `csrfProtection`, `promRegister`. **Risks/TODOs:** Health check always reports Postgres healthy without runtime check; `app.listen` always uses env `PORT` which conflicts with Fly config (8080 vs 4000). **Evidence:** File reviewed 2025‑11‑14.
- `src/routes/index.ts` — **Type:** Source. **Summary:** Central router mounting ~20 feature routers (revenue, analytics, RTB, billing, migration, etc.) behind `killSwitchGuard`. **Dependencies:** Each `*.routes.ts` module plus feature flags middleware. **Risks/TODOs:** Ordering matters for overlapping paths (e.g., `/admin` vs `/migration`); ensure new routes are added here and to OpenAPI spec. **Evidence:** Reviewed file 2025‑11‑14.
- `src/config/env.ts` — **Type:** Source. **Summary:** Zod schema validating env vars (DB, Redis, Stripe, feature flags, AWS/GCP). Automatically loads `.env` and throws with helpful tips when validation fails. **Dependencies:** `dotenv`, `zod`. **Risks/TODOs:** `CLICKHOUSE_URL` optional but `initializeClickHouse` expects URL; align defaults. **Evidence:** File reviewed 2025‑11‑14.
- `src/utils/logger.ts` — **Type:** Source. **Summary:** Winston logger with AsyncLocalStorage context injection, aggressive redaction, colorized dev output, JSON prod logs, plus file transports for `logs/error.log` & `logs/combined.log`. **Dependencies:** `winston`, `async_hooks`. **Risks/TODOs:** File transports write inside container; ensure writable volume in distroless image. **Evidence:** Reviewed 2025‑11‑14.
- `src/middleware/requestContext.ts` — **Type:** Source. **Summary:** Generates/propagates `x-request-id`, stores user/tenant context in async local storage, logs each request with context, exposes helper to retrieve context or create child loggers. **Dependencies:** `asyncLocalStorage`, `logger`. **Risks/TODOs:** Logging every request at info may be noisy; consider sampling for high-traffic RTB endpoints. **Evidence:** Reviewed 2025‑11‑14.
- `src/middleware/errorHandler.ts` — **Type:** Source. **Summary:** Express error handler distinguishing AppError vs unexpected, increments Prometheus counters, handles CSRF-specific errors with 403 response. **Dependencies:** `logger`, `errorCounter`. **Risks/TODOs:** Unexpected errors always return generic message (good), but AppError messages leak internal wording—audit before prod. **Evidence:** Reviewed 2025‑11‑14.
- `src/utils/prometheus.ts` — **Type:** Source. **Summary:** Initializes prom-client register and defines histograms/counters for HTTP, RTB, DB, billing, migration guardrails, auth, tracking, etc.; exposes `promRegister` for `/metrics`. **Dependencies:** `prom-client`. **Risks/TODOs:** Metric cardinality (`route` label on http_requests_total) can explode if paths contain IDs; consider templating. **Evidence:** Reviewed 2025‑11‑14.
- `src/middleware/redisRateLimiter.ts` — **Type:** Source. **Summary:** Redis sliding window limiter for sensitive routes; keys by route+IP, respects `RATE_LIMIT_AUTH_*`, fails open when Redis unavailable. **Dependencies:** `redis` util. **Risks/TODOs:** Throws if Redis not connected when increment called (but code guards). Rate window uses process env; ensure defaults align with global limiter. **Evidence:** Reviewed 2025‑11‑14.
- `src/middleware/csrf.ts` — **Type:** Source. **Summary:** `csurf` wrapper implementing double-submit cookie, customizing cookie flags, skipping for auth acquisition endpoints, exposing helper to issue tokens. **Dependencies:** `csurf`. **Risks/TODOs:** `bool` helper expects `.toLowerCase()` on string; undefined check done but `v.toLowerCase` may throw if not string—should guard. **Evidence:** Reviewed 2025‑11‑14.
- `src/utils/redis.ts` — **Type:** Source. **Summary:** Singleton Redis client with exponential backoff, connection lifecycle logging, typed helper methods (get/set/del pattern, TTL, incr, getOrSet) plus key builders and TTL constants. **Dependencies:** `redis` npm client, `logger`. **Risks/TODOs:** `incr` throws when redis not ready (caller must catch). Consider instrumentation to avoid noisy warn logs when Redis intentionally disabled. **Evidence:** Reviewed 2025‑11‑14.
- `src/routes/billing.routes.ts` — **Type:** Source. **Summary:** Billing API router gating all endpoints behind `requireFeature('billingEnabled')`, `authenticate`, and RBAC for reconcile POST. Maps to controller methods for usage, invoices, PDF download. **Dependencies:** `middleware/auth`, `utils/featureFlags`, `billing.controller`. **Risks/TODOs:** Doesn’t throttle expensive endpoints; consider additional limiter for PDF downloads. **Evidence:** Reviewed 2025‑11‑14.
- `src/controllers/billing.controller.ts` — **Type:** Source. **Summary:** Implements billing endpoints (current usage, invoice list/detail/PDF, admin reconcile) using `UsageMeteringService`, `invoiceService`, `reconciliationService`, with AppError-based validation and audit logging. **Dependencies:** services modules, `AppError`, `logger`. **Risks/TODOs:** `idempotencyKey` read from body but spec says header; align to avoid confusion. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/billing/UsageMeteringService.ts` — **Type:** Source. **Summary:** Core billing usage service interfacing with Postgres, ClickHouse, and Stripe. Handles telemetry ingestion, plan limit calculations, overage pricing, Stripe meter events, limit alerts, and cron jobs. **Dependencies:** `pg`, `@clickhouse/client`, `stripe`. **Risks/TODOs:** Uses global Pool/ClickHouse clients per import (fine) but logs via `console` instead of `logger`; also references hard-coded plan tiers—consider moving to DB. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/invoiceService.ts` — **Type:** Source. **Summary:** Manages invoices (list/get, Stripe sync, PDF generation, ETag creation). Streams custom PDF via PDFKit and interacts with Stripe to create/finalize invoices. **Dependencies:** `pg`, `stripe`, `pdfkit`, `crypto`. **Risks/TODOs:** Hard-coded customer info placeholder in PDF; ensures compliance before prod. Need to ensure DB line_items column uses JSON. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/reconciliationService.ts` — **Type:** Source. **Summary:** Compares internal usage vs Stripe records, enforces 0.5% tolerance, records idempotent results, writes billing_audit entries, emits alerts for large discrepancies. **Dependencies:** `pg`, `stripe`, `logger`. **Risks/TODOs:** `stripe.subscriptionItems.listUsageRecordSummaries` typed as `any`; ensure API available in current Stripe SDK version. **Evidence:** Reviewed 2025‑11‑14.
- `src/controllers/auth.controller.ts` — **Type:** Source. **Summary:** Full auth lifecycle (login, register, refresh, logout, 2FA flows) with zod validation, JWT access/refresh tokens, cookie helpers, Prometheus metrics, feature-flagged 2FA enforcement, and refresh token persistence. **Dependencies:** `bcryptjs`, `jsonwebtoken`, `ms`, `zod`, repositories (`userRepository`, `refreshTokenRepository`), `twofa.service`, `setAuthCookies`. **Risks/TODOs:** Large file (~550 LOC) mixing many concerns; consider splitting per area. `authAttemptsTotal` increments may double-count due to catch block increments. **Evidence:** Reviewed 2025‑11‑14.
- `src/controllers/consent.controller.ts` — **Type:** Source. **Summary:** CRUD + validation endpoints for CMP consent artifacts (store/get/delete consent tied to `req.user`, validation for vendor/purposes, plus utility parsers for TCF 2.2 and GPP strings). **Dependencies:** `consentManagementService`, dynamic parser exports (`TCFv2Parser`, `GPPParser`), `logger`. **Risks/TODOs:** Parser endpoints skip auth entirely (could be intentional but document); relies on `req.user` injection—consider explicit guard middleware for consistency. **Evidence:** Reviewed 2025‑11‑14.
- `src/controllers/dashboard.controller.ts` — **Type:** Source (placeholder). **Summary:** File exists but empty—no exports implemented yet. **Dependencies:** None. **Risks/TODOs:** Dead stub likely intended for future dashboard API; implement planned handlers. **Evidence:** Reviewed 2025‑11‑14 (0-byte file).
- `src/controllers/dataExport.controller.ts` — **Type:** Source. **Summary:** Handles data export + warehouse sync lifecycle (create/list jobs, status lookup, manual sync, local download) with zod validation and fs streaming for completed local exports. **Dependencies:** `dataExportService`, `zod`, Node `fs`, `logger`. **Risks/TODOs:** Minor lint issues (mis-indented `const body` declarations); download streams arbitrary filesystem path from job record—ensure paths are sanitized and storage isolation enforced. **Evidence:** Reviewed 2025‑11‑14.
- `src/controllers/fraud.controller.ts` — **Type:** Source. **Summary:** Thin Express handlers exposing fraud stats, alerts, and breakdown by type; enforces `publisherId` presence and delegates to `fraudDetection` service helpers. **Dependencies:** `AppError`, `getFraudStatistics`, `listFraudAlerts`, `getFraudByType`. **Risks/TODOs:** `limit` query param only validated to be positive but lacks upper bound—add cap to prevent large result sets; relies on middleware to populate `req.user`. **Evidence:** Reviewed 2025‑11‑14.
- `src/controllers/migration.controller.ts` — **Type:** Source. **Summary:** 550+ line controller powering “Migration Studio” (experiments CRUD, imports/mappings, guardrails, activation/pause/delete, SDK assignment endpoint, signed reporting). Mixes service calls with direct SQL queries via `pool`. **Dependencies:** `MigrationStudioService`, Postgres pool, `AppError`, `ExperimentMode`. **Risks/TODOs:** File has many concerns—ripe for modularization; `getAssignment` exposes unauthenticated endpoint (expected for SDK) but logs via `console.error` not `logger`; import endpoints accept arbitrary file buffers/credentials without size validation; consider rate limits + retry/backoff for expensive operations. **Evidence:** Reviewed 2025‑11‑14.
- `src/controllers/payout.controller.ts` — **Type:** Source. **Summary:** Provides payout history/upcoming/settings endpoints plus zod-validated settings update for publishers. **Dependencies:** `payoutProcessor` service helpers (`listPayoutHistory`, `getUpcomingPayouts`, etc.), `zod`, `AppError`. **Risks/TODOs:** `limit` query param lacks upper bound similar to fraud controller; no auditing/logging around settings changes. **Evidence:** Reviewed 2025‑11‑14.
- `src/controllers/placement.controller.ts` — **Type:** Source (stub). **Summary:** Placeholder CRUD for ad placements with zod validation but all handlers return mocked data / TODO comments. **Dependencies:** `logger`, `AppError`, `zod`. **Risks/TODOs:** Not production-ready (no DB integration, uses static IDs). Implement or wire to actual persistence. **Evidence:** Reviewed 2025‑11‑14.
- `src/controllers/reporting.controller.ts` — **Type:** Source. **Summary:** 775-line reporting surface powering dashboard metrics (overview, time series, adapters/apps/countries, realtime stats, fraud & quality metrics, SLOs, anomalies, aggregated dashboard). Heavy use of shared date-range parsing feeding `reportingService` + `qualityMonitoringService`. **Dependencies:** `zod`, `reportingService`, `qualityMonitoringService`, `AppError`, `logger`. **Risks/TODOs:** Monolithic file ripe for modularization; query params allow large windows/hours with minimal caps, risking expensive ClickHouse/Postgres scans; ensures `parseDateRange` gracefully handles timezone offsets. **Evidence:** Reviewed 2025‑11‑14.
- `src/controllers/revenue.controller.ts` — **Type:** Source (stub). **Summary:** Two placeholder endpoints for revenue summary + timeseries returning hard-coded mock data and ignoring auth/validation. **Dependencies:** None beyond Express types. **Risks/TODOs:** Needs real data access, publisher scoping, validation, and caching; remove temporary mocks before exposing publicly. **Evidence:** Reviewed 2025‑11‑14.
- `src/controllers/rtb.controller.ts` — **Type:** Source. **Summary:** Handles OpenRTB bid requests with feature flag gating—falls back to legacy mock engine when production RTB disabled, otherwise calls `runAuction` with consent/migration metadata and returns JSON or 204; status endpoint lists registered adapters. **Dependencies:** `runAuction`, `getAllAdapters`, `AuctionRequestBody`, `logger`, `crypto`. **Risks/TODOs:** No schema validation on POST payload (`body.requestId!` assumes presence); error responses always 204 with no metadata, making debugging hard; consider instrumentation for circuit breaker stats in status response. **Evidence:** Reviewed 2025‑11‑14.
- `src/controllers/rtbTracking.controller.ts` — **Type:** Source. **Summary:** Token-based tracking endpoints—serves creative redirects, records impressions/clicks by verifying signed tokens, dedupes via Redis, and either enqueues analytics events or inserts directly to ClickHouse. **Dependencies:** `verifyToken`, `TrackingTokenSchema`, `redis`, `queueManager` (BullMQ), `getClickHouseClient`, `analyticsEventsEnqueuedTotal`, `crypto`. **Risks/TODOs:** Click redirect currently hard-coded to `/` unless token includes URL; lack of rate limiting could allow abuse; silent catch blocks hide dedupe failures—consider structured logging. **Evidence:** Reviewed 2025‑11‑14.
- `src/controllers/skadnetwork.controller.ts` — **Type:** Source. **Summary:** Handles Apple SKAdNetwork postbacks plus campaign CRUD, conversion value calculations/updates, signature generation, and version metadata via `skadnetworkService`. **Dependencies:** `skadnetworkService`, `logger`, service types (`SKAdNetworkPostback`, `ConversionValueMapping`). **Risks/TODOs:** Endpoints lack authentication/authorization—any caller could modify campaign schemas or conversion values; add signing/secret validation especially for postbacks. **Evidence:** Reviewed 2025‑11‑14.
- `src/controllers/transparency.controller.ts` — **Type:** Source. **Summary:** 675-line transparency API covering auction listings/detail, summaries, metrics, signer key retrieval, and integrity verification with Prometheus instrumentation + ClickHouse queries; enforces publisher scoping and canonicalization for signature checks. **Dependencies:** `executeQuery` (ClickHouse), `AppError`, `crypto`, `canonicalizeForSignature`, `transparencyWriter`, validation utils, `prom-client` histograms, env flag `TRANSPARENCY_API_ENABLED`. **Risks/TODOs:** Large surface area—consider splitting; ClickHouse queries built via string interpolation but rely on typed parameters (ensure no injection); canonical responses truncated at 32 KB—document behavior; add caching for `/auctions` when limit high to avoid repeated heavy joins. **Evidence:** Reviewed 2025‑11‑14.
- `src/controllers/FinancialReportingController.ts` — **Type:** Source (class-based). **Summary:** Compliance reporting download endpoints for Estonian regulators (transaction log, VAT quarters, P&L, cashflow, customer revenue, summary metadata) invoking `FinancialReportingService` to emit Excel buffers. **Dependencies:** `FinancialReportingService`, Postgres `Pool`. **Risks/TODOs:** Uses `console.error` instead of shared logger; directly accesses `reportingService['pool']` for queries (breaks encapsulation); endpoints lack auth/authorization and stream entire workbooks synchronously—add scope checks + streaming safeguards. **Evidence:** Reviewed 2025‑11‑14.
- `src/controllers/HealthCheckController.ts` — **Type:** Source (class). **Summary:** Provides liveness, readiness, startup, and detailed status endpoints leveraging Postgres `Pool` for checks plus system metrics. **Dependencies:** Postgres `Pool`, `process` stats. **Risks/TODOs:** Uses `console.error` instead of logger; readiness only checks DB latency but not Redis/ClickHouse; startup loops sequential table checks per request (potentially heavy). Consider caching results or using health service. **Evidence:** Reviewed 2025‑11‑14.
- `src/controllers/abTesting.controller.ts` — **Type:** Source. **Summary:** CRUD + analytics for AB experiments (create/start/stop, record events, significance test, bandit recommendation) with zod validation and publisher scope enforcement. **Dependencies:** `abTestingService`, `zod`, `logger`. **Risks/TODOs:** `recordEvent` endpoint skips auth/publisher guard—anyone could post events; some parsed query bodies not sanitized for size; consider moving `interpretSignificanceResult` to shared util. **Evidence:** Reviewed 2025‑11‑14.
- `src/controllers/adapter.controller.ts` — **Type:** Source. **Summary:** Adapter configuration CRUD endpoints scoped to publisher, validating payloads with zod and delegating to `adapterConfigService`. **Dependencies:** `adapterConfigService`, `zod`, `AppError`, `logger`. **Risks/TODOs:** Config blobs accepted as arbitrary JSON without schema validation—high chance of invalid adapter credentials reaching runtime; consider per-adapter schema enforcement + audit logging. **Evidence:** Reviewed 2025‑11‑14.
- `src/controllers/analytics.controller.ts` — **Type:** Source. **Summary:** Provides analytics dashboards (overview/time-series/performance) plus bulk ingestion endpoints for impressions/clicks/revenue with zod validation and buffer stats endpoint. **Dependencies:** `analyticsPipeline` helpers (`getAnalyticsOverview`, etc.), `analyticsService`, `zod`, `AppError`, `logger`. **Risks/TODOs:** Event ingestion endpoints appear unauthenticated and accept publisher IDs in payload—need auth and rate limiting; synchronous schema parsing on large batches could block event loop; consider streaming validation. **Evidence:** Reviewed 2025‑11‑14.
- `src/controllers/apiKeys.controller.ts` — **Type:** Source. **Summary:** Simple API key CRUD for sandbox readiness storing keys in an in-memory map keyed by user, generating secrets with prefixes and returning redacted metadata. **Dependencies:** Node `crypto`, `logger`. **Risks/TODOs:** In-memory storage means keys vanish on restart and aren’t shared between instances; no persistence or encryption-at-rest; unauthorized users default to `anon` bucket allowing cross-tenant key leakage. **Evidence:** Reviewed 2025‑11‑14.
- `src/controllers/twofa.controller.ts` — **Type:** Source. **Summary:** Exposes 2FA enroll/verify/backup-code regeneration/disable flows backed by `twofaService`, incrementing Prometheus counters and requiring password confirmation to disable. **Dependencies:** `twofaService`, `twofaEventsTotal`, `logger`, dynamic imports for `userRepository` + `bcryptjs`. **Risks/TODOs:** Most handlers fall back to `anon` user if auth missing, enabling unauthorized enrollments; no rate limiting on verify/regenerate; disable endpoint depends on email stored in `req.user` but doesn’t ensure same user as `userId`. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/abTestingService.ts` — **Type:** Source. **Summary:** 650+ line service managing AB experiments (CRUD via Postgres, variant metrics aggregation, two-sample t-tests, Thompson Sampling bandit, custom statistical helpers). **Dependencies:** `utils/postgres` query helper, `logger`. **Risks/TODOs:** Implements homegrown statistics (betaCDF returns `x`, p-values approximated) which may be inaccurate; IDs derived from `Date.now()+Math.random()` lack UUID guarantees; event writes accept arbitrary metadata without size limit. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/adapterConfigService.ts` — **Type:** Source. **Summary:** Thin service layer around `adapterConfigRepository` providing CRUD for adapter configs and ensuring unique adapter per publisher. **Dependencies:** `adapterConfigRepository`. **Risks/TODOs:** No schema validation or masking of secrets; errors thrown as generic `Error` strings, which bubble up to Express without proper AppError classification. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/__tests__/adapterConfigService.test.ts` — **Type:** Test. **Summary:** Jest suite mocking `adapterConfigRepository` to exercise `adapterConfigService` CRUD helpers (list/get/create/update/delete) including duplicate detection and failure paths. **Dependencies:** Jest, `../adapterConfigService`, `../../repositories/adapterConfigRepository`. **Risks/TODOs:** Pure unit mock tests—don’t hit Postgres or validate schema shapes, so serialization/transaction bugs can slip through; request payload coverage limited to happy path plus minimal error cases (no large configs, secret masking, or concurrent writes). **Evidence:** Reviewed 2025‑11‑14.
- `src/services/analyticsPipeline.ts` — **Type:** Source. **Summary:** Delegates analytics overview/time-series/performance queries to repository functions, defaulting to 30-day window. **Dependencies:** `analyticsRepository`, `date-fns`. **Risks/TODOs:** No validation of date inputs (passing invalid string yields `Invalid Date`); metric switch only affects single numeric field while still returning raw revenue/impressions/clicks. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/__tests__/analyticsPipeline.test.ts` — **Type:** Test. **Summary:** Mocks `analyticsRepository` to verify `analyticsPipeline` delegates correctly, applies default 30-day window, formats time-series values per metric, and passes through performance breakdown rows. **Dependencies:** Jest, `date-fns.subDays`, `../analyticsPipeline`, `../../repositories/analyticsRepository`. **Risks/TODOs:** Uses fake timers but only validates single data point per case; doesn’t assert error handling or invalid date parsing, so regressions in validation would go unnoticed; repository mock expectations mirror implementation, making it easy for tests to pass while forgetting metric rounding rules for non-revenue metrics. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/analyticsService.ts` — **Type:** Source. **Summary:** In-memory buffering service that batches impression/click/revenue DTOs and flushes to ClickHouse via `insertBatch`, with periodic timer and stats helper. **Dependencies:** `utils/clickhouse`, `logger`, analytics DTO types. **Risks/TODOs:** Buffers stored in-process → events lost on crash; retries simply re-queue same array without backoff or dead-letter; no high-water mark leading to potential unbounded memory use if ClickHouse down. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/analyticsQueryService.ts` — **Type:** Source (placeholder). **Summary:** File exists but empty—no query helpers implemented. **Dependencies:** None. **Risks/TODOs:** Implement specialized ClickHouse query helpers referenced elsewhere to avoid runtime import errors. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/analyticsReportingService.ts` — **Type:** Source (placeholder). **Summary:** Empty file intended for reporting-specific analytics logic. **Dependencies:** None. **Risks/TODOs:** Populate to prevent dead imports; confirm nothing tries to require it at runtime. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/bidLandscapeService.ts` — **Type:** Source. **Summary:** Logs detailed bid landscape data to ClickHouse (all bids, clearing price calculations, adapters) and exposes aggregate/timeline queries plus health checks. **Dependencies:** `utils/clickhouse`, `types/openrtb.types`, `logger`. **Risks/TODOs:** `logger` import uses named export though module exports default logger (verify to avoid undefined); clearing price math assumes second-price auction even if `result` indicates otherwise; `getClient` memoizes first failure only—subsequent ClickHouse recovery won’t log until restart. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/consentManagementService.ts` — **Type:** Source. **Summary:** Comprehensive CMP service parsing TCF 2.2/GPP strings, validating consent, persisting per-user state, and exposing helpers for SDK/OpenRTB integration plus utility parsers exported for controllers. **Dependencies:** `utils/postgres`, `logger`. **Risks/TODOs:** Homegrown parsers partially implemented (publisher restrictions TODO, GPP sections simplified) so correctness uncertain; heavy file (600+ LOC) mixing parsing, DB, validation—consider splitting; lacks rate limiting/logging sanitization for large consent payloads. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/__tests__/consentManagementService.test.ts` — **Type:** Test. **Summary:** Large Jest suite mocking `utils/postgres` + logger to cover consent storage/retrieval/validation flows, OpenRTB `regs`/`user` builders, parsers (TCF v2, GPP), and singleton export wiring. **Dependencies:** Jest, `../consentManagementService`, `../../utils/postgres`, `../../utils/logger`. **Risks/TODOs:** Still pure unit tests—DB interactions are mocked so schema drift or SQL errors won’t be caught; tests mostly happy-path for parsers and don’t validate edge-case decoding (publisher restrictions, custom purpose logic); uses shared singleton and mutates logger mocks, which can leak state into other suites if run in parallel. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/dataExportService.ts` — **Type:** Source. **Summary:** Orchestrates ClickHouse data extraction, file generation (CSV/JSON/Parquet), compression, and delivery to S3/GCS/BigQuery/local for analytics exports and scheduled warehouse syncs. **Dependencies:** AWS SDK, GCP Storage & BigQuery, `fs`, `zlib`, `executeQuery`, `dataExportRepository`, `logger`. **Risks/TODOs:** Builds SQL via string interpolation with publisherId/date inserted (risk of injection); writes entire dataset to memory when generating CSV/JSON; uses synchronous `fs` calls and stores generated files under `/tmp` without cleanup; upload credentials not scoped per publisher. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/enrichment/enrichmentService.ts` — **Type:** Source. **Summary:** Loads offline enrichment manifests (abuse IP ranges, Tor exits, cloud/vpn CIDRs, ASN geo data, user-agent regexes) from `data/enrichment/<version>` into `IPRangeIndex` structures, exposes `initialize` with snapshot writing plus runtime lookups for IP/user-agent metadata. **Dependencies:** Node `fs/promises`, `path`, shared `logger`, `./ipRangeIndex`. **Risks/TODOs:** Entire dataset is read synchronously at startup and stored in memory with no streaming/chunking; only IPv4 is supported, so IPv6 traffic can’t be enriched; manifest inputs are trusted blindly (no schema validation or size limits) so a bad file could exhaust memory or crash parse; lookup errors throw if `initialize` wasn’t called, but nothing auto-initializes in prod. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/enrichment/ipRangeIndex.ts` — **Type:** Source. **Summary:** Provides a minimal IPv4 CIDR/range index with binary search lookup and convenience parsers for CIDR/single IP/range notation, storing arbitrary metadata per prefix. **Dependencies:** None beyond builtin math helpers. **Risks/TODOs:** IPv6 unsupported; ranges accumulate in an unsorted array until lookup, so a large manifest causes repeated sort work; duplicates are de-duplicated only when start/end match exactly, meaning overlapping ranges aren’t coalesced and could explode memory. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/enrichment/index.ts` — **Type:** Source. **Summary:** Barrel file exporting the enrichment service singleton + types for consumers (`VPNProxyDetectionService`, fraud tooling). **Dependencies:** `./enrichmentService`. **Risks/TODOs:** Re-export only—callers still import side-effectful singleton, so tests need helpers to reset state. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/__tests__/enrichmentService.test.ts` — **Type:** Test. **Summary:** Boots `EnrichmentService` against the real `data/enrichment/v1` snapshot to verify lookupIp/user-agent parsing/snapshot persistence behavior using deterministic fixture IPs and UA strings. **Dependencies:** Jest, Node `fs/promises`, `path`, `../enrichment/enrichmentService`. **Risks/TODOs:** Reads large fixture files into memory during tests and assumes `data/enrichment` exists on CI; covers only happy-path lookups (no corrupt manifest, invalid IPs, or concurrent initialization). **Evidence:** Reviewed 2025‑11‑14.
- `src/services/fraudDetection.ts` — **Type:** Source. **Summary:** Adapter over `fraudRepository` converting raw stats/breakdowns into controller-friendly DTOs (totals, detection rate, top types). **Dependencies:** `fraudRepository`. **Risks/TODOs:** No caching; repeated calls re-query DB; `blockedRevenue.toFixed` assumes numeric fields always present—add null guards. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/__tests__/fraudDetection.test.ts` — **Type:** Test. **Summary:** Mocks `fraudRepository` fetchers to verify that `getFraudStatistics`, `listFraudAlerts`, and `getFraudByType` format counts, percentages, blocked revenue rounding, and alert pagination correctly, including zero-alert guard rails. **Dependencies:** Jest, `../fraudDetection`, `../../repositories/fraudRepository`. **Risks/TODOs:** Only checks happy-path formatting—doesn’t simulate repository exceptions, missing fields, or localization requirements; precision rounding hard-coded to two decimals so floating-point drift isn’t tested; alerts test covers only single-row sample, not pagination/order edge cases. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/fraud/weakSupervision/WeakSupervisionService.ts` — **Type:** Source. **Summary:** Orchestrates offline “weak supervision” labeling by loading JSON manifests (supply-chain corpus + synthetic scenarios), wiring enrichment lookups, and executing multiple heuristics (supply chain, network origin, CTIT, OMSDK, synthetic telemetry) to emit label function outcomes + quality reports. **Dependencies:** Node `fs/promises`, `path`, `../../enrichment/enrichmentService`, `./supplyChainCorpus`, `./syntheticScenarios`, shared `logger`. **Risks/TODOs:** Initialization eagerly loads entire corpora into memory with no eviction and blocks each request if not pre-initialized; relies on external JSON quality—no schema validation or signature checking; concurrent `initialize()` calls share a single promise but errors leave the service partially initialized; heuristics encode fixed thresholds (5s CTIT, timezone matches) without configuration hooks, so tuning requires redeploy. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/fraud/weakSupervision/supplyChainCorpus.ts` — **Type:** Source. **Summary:** Loads app-ads.txt derived corpus + sellers directory JSON and evaluates whether a seller/domain/appStoreId combination is authorized, returning directory metadata for context. **Dependencies:** Node `fs/promises`, `path`, weak supervision types. **Risks/TODOs:** Corpus entirely in memory and case-sensitive (domains converted to lower-case but sellers not), so updates require full reload; no caching/TTL or background refresh; JSON parsing errors aren’t handled—bad data crashes initialization; statuses from sellers directory aren’t considered in authorization decisions. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/fraud/weakSupervision/syntheticScenarios.ts` — **Type:** Source. **Summary:** Loads a JSON array of synthetic fraud scenario thresholds and filters incoming telemetry for matching thresholds (RPM, unique devices, creative swaps, bundles/request) to emit canned labels/confidence. **Dependencies:** Node `fs/promises`. **Risks/TODOs:** Threshold comparisons assume all metrics present and numeric—missing fields default to `0` and may produce false negatives; no support for upper bounds beyond two metrics, and scenario definition file isn’t validated before use; evaluating linearly over entire list could be slow if scenarios grow large. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/fraud/weakSupervision/types.ts` — **Type:** Source (types). **Summary:** Declares the weak supervision data model (contexts, label function outcomes, quality reports, synthetic scenario definitions) shared across service + controllers/tests. **Dependencies:** None. **Risks/TODOs:** File ends with stray backticks (typo) and lacks runtime validation helpers, so upstream inputs must guard themselves; type unions hardcode strings, making it easy for implementation to drift without compiler errors when new label classes needed. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/fraud/weakSupervision/index.ts` — **Type:** Source. **Summary:** Barrel re-export for weak supervision types + service to simplify imports. **Dependencies:** `./types`, `./WeakSupervisionService`. **Risks/TODOs:** Re-exporting the singleton encourages shared state between tests/server; consider exposing factory to enable isolated instances. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/FinancialReportingService.ts` — **Type:** Source. **Summary:** Generates Excel exports for Estonian compliance workflows (transaction logs, quarterly VAT, annual P&L, cash flow, customer revenue) by querying Postgres, mapping rows to typed DTOs, and assembling `ExcelJS` workbooks with formatting and summary math. **Dependencies:** `pg` Pool, `exceljs`, `date-fns`. **Risks/TODOs:** Runs full-table scans per export and builds workbooks entirely in memory—huge fiscal years may exhaust memory/CPU; queries interpolate fiscal period into SQL but otherwise rely on positional params; service lacks pagination/streaming and could expose PII if called without tenant scoping. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/VPNProxyDetectionService.ts` — **Type:** Source. **Summary:** Multi-factor geographic validation for discounted pricing; correlates IP-derived country (MaxMind), Stripe payment method country, and optional app-store country, applies scoring/heuristics, checks enrichment+reverse DNS for VPN signals, logs audit history, and exposes last 10 validation results. **Dependencies:** `pg` Pool, `@maxmind/geoip2-node`, Node `dns`, shared `enrichmentService`. **Risks/TODOs:** Loads GeoIP DB from filesystem on startup without retries; heavy reliance on in-process caches and console logging; reverse DNS lookups and async scoring run sequentially per request (potential latency spikes) and there’s no rate limiting or batching; ENV `GEOIP_DATABASE_PATH` must be provisioned in containers. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/__tests__/VPNProxyDetectionService.test.ts` — **Type:** Test. **Summary:** Light integration-style Jest test that boots `VPNProxyDetectionService` with a real `EnrichmentService` snapshot (v1 under `data/enrichment`) and stubbed Pool/GeoIP/dns dependencies to ensure VPN IPs are flagged via enrichment datasets. **Dependencies:** Jest, Node `path`, `../VPNProxyDetectionService`, `../enrichment/enrichmentService`. **Risks/TODOs:** Only asserts a single positive case (VPN detected) and doesn’t cover negative paths, GeoIP failures, ClickHouse writes, or alerting; relies on fixture data existing at `data/enrichment` so CI needs those files, but test still mocks Postgres so it can’t catch SQL regressions.
- `src/services/migrationComparisonSigner.ts` — **Type:** Source. **Summary:** Generates signed “Migration Studio” comparison payloads either from raw mapping samples or real experiment metrics, canonicalizes the JSON, and signs it with Ed25519 keys for downstream verification, while synthesizing uplift/latency/IVT metrics and confidence bands. **Dependencies:** Node `crypto`, `../utils/logger`, migration type definitions, env-provided PEM keypair (`MIGRATION_STUDIO_SIGNING_*`). **Risks/TODOs:** Falls back to generating ephemeral keys when env vars missing (undermines trust chain); metrics are mostly simulated heuristics (e.g., 5% uplift, hard-coded fill/latency formulas) so reports may mislead if treated as real; uses console logger but never rotates keys or enforces KID rotation; no input validation on experiment data. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/__tests__/migrationComparisonSigner.test.ts` — **Type:** Test. **Summary:** Calls `generateSignedComparison` with a single mocked mapping to assert that uplift metrics, fill unit metadata, and signature payload/base64 encoding are generated consistently, including parsing and comparing the signed payload to the returned metrics. **Dependencies:** Jest, `../migrationComparisonSigner`, `../../types/migration`. **Risks/TODOs:** Only validates deterministic happy-path structure (no signature verification, multi-mapping scenarios, or env-driven key IDs); doesn’t simulate missing PEM keys or payload tampering; uses live `Date` objects so results depend on runtime clock but expectations don’t assert timestamps. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/migrationImportConnectors.ts` — **Type:** Source. **Summary:** Provides stubbed connectors for incumbent mediation platforms (ironSource/AppLovin) used by Migration Studio imports, validating credentials and returning deterministic normalized mapping rows (network, instance, eCPM, confidence) derived from the account ID so end-to-end flows/tests stay stable. **Dependencies:** None beyond built-in `Error`. **Risks/TODOs:** Purely mocked—no actual API integration, no rate limiting, and credential validation only checks for non-empty strings; must be replaced with real HTTP clients + secure storage before production imports. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/migrationStudioService.ts` — **Type:** Source. **Summary:** 1.5k‑line domain service powering Migration Studio: owns experiment CRUD (with transactions/audit logs), import flows (CSV + ironSource/AppLovin connectors), mapping summaries, deterministic assignment + feature-flag resolution, guardrail evaluation/pausing, event logging, signed comparison generation, and mirroring/shadow activation. **Dependencies:** `pg` Pool, Node `crypto`, `../utils/logger`, `../utils/migrationCsvParser`, migration connectors + signer modules, Prometheus counters. **Risks/TODOs:** Extremely monolithic and mixes SQL, business logic, and IO—hard to test or evolve; imports rely on buffered file parsing with minimal validation and no size limits; guardrail evaluation scans raw tables every call and could lock rows (`FOR UPDATE`) under load; deterministic assignment depends on mirror percent but lacks central config/rate limiting; error handling mostly rethrows so partial transactions risk leaving orphaned temp data if exceptions occur outside BEGIN/COMMIT scope. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/__tests__/migrationStudioService.test.ts` — **Type:** Test. **Summary:** Spins up `MigrationStudioService` with mocked PG pool/logger/crypto to exercise experiment lifecycle (create/get/update/activate/pause/delete), guardrails validation, feature flag resolution, deterministic arm assignment/logging, and error handling/transactions/rollback paths. **Dependencies:** Jest, dynamic imports of `../migrationStudioService`, `../../middleware/errorHandler`, mocked `crypto` + `../../utils/logger`. **Risks/TODOs:** Heavy suite still mocks all SQL so it can’t catch query regressions; async `beforeAll` imports add coupling and may hide race conditions; coverage skips CSV import/mirroring flows, guardrail metrics, and Prometheus counters; deterministic assignment tests rely on seeded UUID but don’t assert distribution or hashing collisions. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/openrtbEngine.ts` — **Type:** Source. **Summary:** Mock OpenRTB 2.6 auction engine: defines static adapter catalog + simple circuit breaker, validates requests, fans out “calls” (simulated responses) in parallel, runs second-price clearing, enforces floors, logs to bidLandscape/transparency writers, and exposes adapter/circuit stats. **Dependencies:** Node `crypto`, `../utils/logger`, `./bidLandscapeService`, `./transparencyWriter`, OpenRTB type defs. **Risks/TODOs:** Adapter calls are fully simulated (no HTTP, no per-adapter config storage) so engine can’t reach real demand; clearing price/floor enforcement uses only first impression; no timeout accounting (adapterTimeouts counter never increments) and logging happens even on validation failures which could flood ClickHouse; circuit breaker state is in-memory only so restarts reset health data. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/transparencyWriter.ts` — **Type:** Source. **Summary:** Samples completed auctions, canonicalizes payloads, signs them with Ed25519, and writes auction/candidate rows to ClickHouse with retry + breaker logic and Prometheus counters/gauges for breaker state and failures. **Dependencies:** Node `crypto`, `prom-client`, `../utils/clickhouse`, OpenRTB types, `./transparency/canonicalizer`, `./openrtbEngine`. **Risks/TODOs:** Requires PEM private key + ClickHouse connectivity at runtime; when client missing it silently drops samples after first warning; breaker/counters are in-process so multi-instance deployments won’t share cooldowns; metadata hash only includes a subset of bid fields—could be insufficient for full auditing; sampling is deterministic per publisher/request but rate is global and not per-tenant configurable. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/__tests__/transparencyWriter.test.ts` — **Type:** Test. **Summary:** Uses generated Ed25519 keys + mocked ClickHouse client to validate sampling skip, successful auction + candidate persistence (signature metadata, payload contents), retry behavior, breaker open/close, partial failure metrics, canonicalization helper, and ClickHouse error handling with metrics counters. **Dependencies:** Jest, Node `crypto`, `../transparencyWriter`, `../../types/openrtb.types`. **Risks/TODOs:** Doesn’t mock prom-client metrics or actual ClickHouse responses beyond insert stub; breaker tests manipulate wall-clock manually but don’t assert concurrent writers; canonicalization test only inspects subset of fields; no coverage for configuration reload, redaction, or large candidate batches. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/transparency/canonicalizer.ts` — **Type:** Source. **Summary:** Defines the deterministic JSON canonicalization logic shared by transparency writer/controller/CLI—sorts object keys lexicographically, stringifies arrays recursively, and normalizes primitives (finite numbers, booleans, `null`). **Dependencies:** None beyond built-in JSON/string helpers; consumed by transparency stack. **Risks/TODOs:** Treats `NaN`/`Infinity` as `null`, which may hide bad data rather than failing; lacks bounds on recursion depth so malicious payloads could cause stack overflows; doesn’t escape BigInt/special types, so callers must pre-sanitize. Consider exporting a streaming version to avoid building huge strings in memory. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/payoutProcessor.ts` — **Type:** Source. **Summary:** Defines a multi-provider payout processor with in-memory Tipalti/Wise/Payoneer stubs, double-entry ledger helper (`payout_ledger` table) with balance validation, payout status updater, failed payout retry loop, and thin wrappers around `payoutRepository` fetch/update helpers. **Dependencies:** `../repositories/payoutRepository`, `../utils/postgres` query helper, shared `logger`, env-provided API keys/endpoints for each provider. **Risks/TODOs:** Provider “APIs” are simulated (no HTTP clients, request signing, or reconciliation), yet payouts are marked processed and ledgered, so system will claim money moved when nothing happened; ledger inserts/status updates aren’t wrapped in a DB transaction—midway failures could leave duplicate or unbalanced rows; `retryFailedPayouts` runs synchronously without rate limits or exponential backoff; transaction IDs are derived from `Date.now()+Math.random()` which are predictable and may collide. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/__tests__/paymentProcessor.test.ts` — **Type:** Test. **Summary:** Mocks Postgres + logger to cover `PaymentProcessor` payout flow (Tipalti happy path, Wise/Payoneer failover when env keys missing), ledger entry creation/validation, payout status updates, retrying failed payouts, and the helper `PayoutLedgerService` (create/get entries, balance tolerance) plus singleton exports. **Dependencies:** Jest, `../payoutProcessor`, `../../utils/postgres`, `../../utils/logger`. **Risks/TODOs:** Providers are still simulated, so tests only assert log + DB calls—not real HTTP payloads or retries; env mutation for failover could leak between tests; ledger balance validation only checks ±0.01 tolerance and doesn’t simulate long-running imbalance or concurrency; retry test doesn’t assert behavior when ledger inserts fail mid-loop. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/__tests__/payoutProcessor.test.ts` — **Type:** Test. **Summary:** Stubs `payoutRepository` helpers to verify `listPayoutHistory`, `getUpcomingPayouts`, `getPayoutSettings`, and `updatePayoutSettings` pass through parameters and format payloads when updating thresholds/method/currency schedules. **Dependencies:** Jest, `../payoutProcessor`, `../../repositories/payoutRepository`. **Risks/TODOs:** Missing coverage for repository errors, pagination, or empty-state defaults; doesn’t validate scheduler cron translation or currency filtering; mocks always resolve so tests won’t catch thrown AppErrors or logging side effects. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/qualityMonitoringService.ts` — **Type:** Source. **Summary:** Aggregates ClickHouse data (`impressions`, `creative_scans`, `sdk_telemetry`, `creative_compliance`) to deliver viewability, brand safety, compliance, ANR, and SLO/alert reports, including helper functions that combine metrics into quality alerts with canned remediation guidance. **Dependencies:** `../utils/clickhouse.executeQuery`, shared `logger`, ClickHouse tables for impressions/telemetry/scans/compliance. **Risks/TODOs:** Heavy synchronous queries fan out multiple aggregations per request without caching—large date ranges could hammer ClickHouse; SQL uses publisherId interpolation via parameter binding but still builds strings with inline arithmetic—ensure identifiers stay sanitized; SLO error-budget math divides by `(100 - target)` and will blow up when target=100 (availability) leading to `Infinity`; quality alerts trigger network-bound subcalls sequentially and may return duplicates when Date.now is used for IDs; no rate limiting or background job offload, so dashboard hits re-run expensive analytics each time. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/__tests__/qualityMonitoringService.test.ts` — **Type:** Test. **Summary:** Heavily mocks `executeQuery` to cover every public method: viewability metrics (by format + zero impression handling), brand safety reports, creative compliance, ANR/crash stats, SLO aggregation/error budget states, alert generation (SLO breach, ANR spike, viewability drop, severity sorting), and no-issue scenario. **Dependencies:** Jest, `../qualityMonitoringService`, `../../utils/clickhouse`, `../../utils/logger`. **Risks/TODOs:** Still unit-level with ClickHouse fully mocked so SQL or schema drift won’t be caught; tests expect stringified numbers to parse cleanly but don’t assert type conversion failures; ANR alert cases rely on manual data ordering and could miss concurrency or pagination issues; no coverage for Prometheus instrumentation or error-handling branches when queries reject. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/reportingService.ts` — **Type:** Source. **Summary:** 1.1k‑line ClickHouse analytics layer powering dashboards (revenue stats/time series, adapter/app/country breakdowns, realtime + health scoring, fraud/quality metrics, revenue projections, cohort analysis, anomaly detection) with dozens of raw SQL strings and light post-processing helpers. **Dependencies:** `../utils/clickhouse.executeQuery`, shared `logger`, ClickHouse tables `revenue_events`, `impressions`, `fraud_events`, `quality_events`, `sdk_telemetry`, `user_events`, `user_installs`, plus downstream controllers. **Risks/TODOs:** Many calculations divide by `count(*)` or `countIf(...)` without guarding zero denominators (e.g., `completion_rate`, `ctr`, adapter uptime) → NaN/Infinity leaks to API; fill rate is hard-coded to 100 despite TODO; adapter health shares revenue by cross-joining a single `total`—when total revenue is 0 the query divides by zero and fails; linear regression/projection ignores seasonality and doesn’t clamp slopes leading to negative projections despite `Math.max`; anomaly detection cross joins baseline stats even when baseline empty (results null) and spawns duplicate alerts per metric hour; service fires multiple heavy ClickHouse queries per request without caching or pagination, so large date ranges can overwhelm CH and API latency. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/__tests__/reportingService.test.ts` — **Type:** Test. **Summary:** Fully mocks ClickHouse to exercise adapter health scoring, fraud metrics, quality metrics (bounds + defaults), revenue projections (upward/declining trends, insufficient data), cohort analysis, anomaly detection (revenue drop, performance degradation, fraud spikes, traffic anomalies, severity bands), and a simple integration correlation between adapter health + quality stats. **Dependencies:** Jest, `../reportingService`, `../../utils/clickhouse`, `../../utils/logger`. **Risks/TODOs:** Heavy reliance on mocked arrays means SQL regressions or schema mismatches won’t surface; projections tests use Math.random noise which could cause flakiness; anomaly tests don’t verify deduplication/time window overlaps; integration test merely compares two sequential calls with separate mocks rather than ensuring combined pipeline behavior. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/rtbEngine.ts` — **Type:** Source. **Summary:** Minimal mock RTB executor that filters a hard-coded `DEMAND_PARTNERS` array, picks the highest CPM above floor, and emits a synthetic `BidResponse` with tracking URLs plus Prometheus auction timing; also exposes a diagnostics helper returning adapter count and average CPM. **Dependencies:** Node `crypto` (UUID), `../utils/prometheus.auctionLatencySeconds`. **Risks/TODOs:** Not production-ready—no actual bidder network calls, no consent/device validation, no creative metadata beyond static URLs; CPM/floor comparison uses fixed USD numbers so cannot support per-geo pricing or currencies; hard-coded adapters mean config changes require code deploy; `executeBid` never logs or exposes reasons for `null` bids, and tracking URLs are unauthenticated/public meaning anyone can spam them. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/rtb/adapterRegistry.ts` — **Type:** Source. **Summary:** Tiny registry that lazily registers mock adapters (AdMob/AppLovin/Unity) and exposes helpers to list all adapters or filter by ad format to support the mock RTB engine. **Dependencies:** `./adapters/mockAdmob`, `./adapters/mockAppLovin`, `./adapters/mockUnityAds`, shared adapter type defs. **Risks/TODOs:** Registry is process-local and never reloads, so hot-reloading real adapter configs isn’t possible; only mock adapters exist—no dynamic discovery or configuration persistence; `registerDefaultAdapters` silently no-ops after first call, so tests must reset state manually to avoid cross-test leakage. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/rtb/orchestrator.ts` — **Type:** Source. **Summary:** Main mock RTB auction runner: seeds adapters, dispatches concurrent bid requests with per-adapter timeouts, samples winners, and wraps results with signed delivery/impression/click tokens while recording Prometheus metrics and optional Migration Studio shadow/mirroring outcomes. **Dependencies:** `./adapterRegistry`, `./adapters/*`, `../../utils/prometheus`, `../../utils/signing`, `./shadowRecorder`, migration type defs, Node `crypto`. **Risks/TODOs:** Entire auction logic depends on synchronous `Promise.all` without early-short circuit beyond manual abort, so slow adapters can still consume resources; auction inputs/tracking tokens trust in-process secrets—no replay protection beyond TTL; migration shadow recording runs per request and could amplify latency if ClickHouse/DB writes slow; lacks validation or caps on adapter count/payload sizes; uses process env for TTL but no config reload, so long-running instances can’t adjust without restart. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/rtb/shadowRecorder.ts` — **Type:** Source. **Summary:** Persists Migration Studio “shadow” auction outcomes into `migration_shadow_outcomes`, serializing candidate bid snapshots + metadata to JSONB and swallowing insert errors to keep the RTB request fast. **Dependencies:** `../../types/migration`, shared Postgres helper `query`, shared `logger`. **Risks/TODOs:** Inserts fire inline on the request thread with no batching/backpressure so DB hiccups could still cascade despite the catch; JSON serialization takes arbitrary metadata with no schema or size limits; failures only log a warning and aren’t surfaced to Prometheus, so silent data gaps are likely. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/rtb/adapters/types.ts` — **Type:** Source (types). **Summary:** Defines the adapter contract (supported ad formats, bid request payload including consent/migration metadata, bid vs no-bid responses, AbortSignal context) used by all mock bidders. **Dependencies:** `../../../types/migration`. **Risks/TODOs:** Type-only layer doesn’t enforce runtime validation so callers can emit malformed requests (e.g., negative floor CPM, missing consent structures); relies on DOM `AbortSignal` availability in Node without polyfill notes. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/rtb/adapters/mockAdmob.ts` — **Type:** Source. **Summary:** Mock AdMob adapter that waits a random 20‑60 ms, rejects floors above 1.2 CPM, and emits canned creatives while instrumenting Prometheus latency + timeout counters. **Dependencies:** Adapter types, `rtbAdapterLatencySeconds`, `rtbAdapterTimeoutsTotal`. **Risks/TODOs:** Uses `Math.random()` for CPM/jitter (non-deterministic tests) and never logs errors, so adapter failures are invisible beyond metrics; static creative URLs + TTL mean creatives aren’t scoped per publisher; timeout handling simply returns `nobid` without propagating structured diagnostics. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/rtb/adapters/mockAppLovin.ts` — **Type:** Source. **Summary:** Mock AppLovin adapter similar to AdMob but with 30‑100 ms jitter and 1.8 CPM floor, producing canned creatives conditioned on AbortSignals. **Dependencies:** Adapter types, `rtbAdapterLatencySeconds`, `rtbAdapterTimeoutsTotal`. **Risks/TODOs:** Relies on DOMException availability in Node (not always standard) and never surfaces unexpected errors beyond returning `nobid`; timeout thresholds come solely from env vars with no sanity checks; no per-request logging or tracing makes debugging adapter behavior difficult. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/rtb/adapters/mockUnityAds.ts` — **Type:** Source. **Summary:** Mock Unity Ads adapter with 15‑70 ms jitter, CPM floor 1.4, emits canned creative URLs/metadata, and instruments Prometheus timers. **Dependencies:** Adapter types, `rtbAdapterLatencySeconds`, `rtbAdapterTimeoutsTotal`. **Risks/TODOs:** Shares same deterministic creative assets and TTL for all requests (risking cache poisoning in real world), and exception handling collapses all non-timeout errors into `ERROR` with no logging, so faults can’t be triaged; adapter never validates request fields (e.g., adFormat) beyond simple floor check. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/skadnetworkService.ts` — **Type:** Source. **Summary:** In-memory SKAdNetwork helper providing campaign schemas, nonce/signature generation (placeholder HMAC), postback ingestion, conversion value calculation/update, and lightweight stats across stored postbacks for SKAN 2.2‑4.0 features. **Dependencies:** Node `crypto`, shared `logger`, env `SKADNETWORK_SECRET`. **Risks/TODOs:** Stores campaigns/postbacks in process memory so data is lost on restart and cannot scale horizontally; signature handling is stubbed (no Apple public key verification), making fraud trivial; conversion schemas default to hard-coded example arrays and lack persistence/validation; `processPostback` accepts any payload without rate limiting or replay detection; `createCampaign`/`updateConversionValue` log but don’t enforce SKAN lock windows or coarse RV guardrails. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/__tests__/skadnetworkService.test.ts` — **Type:** Test. **Summary:** Instantiates `SKAdNetworkService` to validate supported versions, nonce/signature generation, default vs custom campaign schemas, postback processing success/failure, conversion value calculations (event count/revenue thresholds), conversion updates bounds, and campaign stats/aggregations across recorded postbacks. **Dependencies:** Jest, `../skadnetworkService`. **Risks/TODOs:** Still pure unit tests without crypto verification or concurrency; signature tests only check non-empty strings, not deterministic values; postback processing never asserts rate limiting, replay prevention, or secret rotation; tests rely on in-memory state and could bleed between cases without explicit resets. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/thompsonSamplingService.ts` — **Type:** Source. **Summary:** Thompson Sampling engine for dynamic bid floor optimization keyed by adapter/geo/format, seeded with default floor buckets, using Gamma-sampled Beta distributions to pick exploration vs exploitation floors, persisting alpha/beta parameters in `thompson_sampling_experiments`, and exposing stats/reset helpers. **Dependencies:** `../utils/logger`, `../utils/postgres`, Node `Math.random`. **Risks/TODOs:** Shared state lives in a per-process Map so multi-instance fleets drift unless restarts reload frequently; RNG/sampleGamma implementations rely on `Math.random()` with no seeding or reproducibility guarantees and may have numerical issues for small shapes; updates treat auctions as binary win/loss ignoring bid amount or revenue so it may optimize high win rate over yield; candidate lookup only supports predefined price buckets (±0.01) so external floor adjustments are ignored; no validation/rate limiting on `updateBidFloor`, letting bad data poison priors quickly. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/__tests__/thompsonSamplingService.test.ts` — **Type:** Test. **Summary:** Mocks Postgres + logger to exercise bid floor selection/exploration, experiment initialization/loading, winner/loser updates (alpha/beta), missing candidate handling, stats aggregation (best floor, confidence, success rate), reset deletion, Beta sampling convergence, retry loops, and singleton export. **Dependencies:** Jest, `../thompsonSamplingService`, `../../utils/postgres`, `../../utils/logger`. **Risks/TODOs:** Uses real `Math.random()` inside tests making outcomes non-deterministic (flaky Beta convergence); DB mocks don’t simulate contention or failures; doesn’t assert persistence format or TTL; concurrency/race behavior for `loadExperiments` unresolved. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/twofa.service.ts` — **Type:** Source. **Summary:** Ephemeral 2FA manager that stores per-user TOTP secrets and hashed backup codes in an in-process `Map`, supports enrollment (QR/otpauth generation), verification/enablement, token or backup-code validation, regeneration, and disable flows. **Dependencies:** `otplib.authenticator`, `bcryptjs`, `qrcode`, shared `logger`. **Risks/TODOs:** Secrets/backup codes live only in memory → lost on restart and vulnerable to multi-instance drift; no persistence, encryption-at-rest, or rate limiting; backup codes generated with `Math.random()` (predictable) and stored until used; service exposes no revocation/audit logs beyond info statements; callers must ensure authenticated context since service performs no authorization checks. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/waterfallService.ts` — **Type:** Source. **Summary:** Provides fallback auction orchestration layered on `openrtbEngine` (executeWithWaterfall, executeWithPriority, executeSmartWaterfall) plus in-memory stats tracking; implements exponential backoff, adapter-priority filtering via `wseat`, and optional performance-aware ordering. **Dependencies:** `./openrtbEngine` (`executeAuction`, `getAdapterConfig`), OpenRTB types, shared `logger`. **Risks/TODOs:** Waterfall/backoff uses `sleep` inside the Node event loop, delaying the request handler without cancellation or timeout awareness; adapters + stats are in-process so multi-instance runners will diverge, and there’s no protection against large adapter lists causing long sequential waits; on failure it always returns the last attempt’s `AuctionResult` but doesn’t annotate consolidated errors/reasons; `executeSmartWaterfall` silently reuses default config instead of caller-provided overrides; logging every attempt at info level could flood logs under load. **Evidence:** Reviewed 2025‑11‑14.
- `src/services/__tests__/waterfallService.test.ts` — **Type:** Test. **Summary:** Mocks `openrtbEngine` + bidLandscape to validate baseline waterfall execution, fallback attempts, maxAttempts enforcement, exponential backoff delays, disabled mode, adapter-priority targeting, performance-aware ordering, and stats accumulator/reset behavior. **Dependencies:** Jest, `../waterfallService`, `../openrtbEngine`, `../bidLandscapeService`, `../../types/openrtb.types`. **Risks/TODOs:** Async delays/backoff aren’t awaited with timers—tests just inspect returned metadata; no verification of actual sleep or concurrency; mocks only cover success/failure booleans, leaving request mutation and logging untested; lacks coverage for smart waterfall error paths or metrics exported to Prometheus. **Evidence:** Reviewed 2025‑11‑14.

### console/

- `console/README.md` — **Type:** Doc. **Summary:** High-level overview of the Next.js 14 console (tech stack, features, architecture tree, environment setup, API integrations, auth, styling system, performance practices, deployment paths). **Dependencies:** References backend services (config/fraud/analytics), NextAuth, Tailwind. **Risks/TODOs:** “Components (To Be Built)” section lists several TODO widgets/forms that still appear unimplemented—ensure roadmap aligns with reality; deployment guidance assumes Vercel/Docker but doesn’t mention Fly. **Evidence:** Reviewed 2025‑11‑14.
- `console/BACKEND_INTEGRATION.md` — **Type:** Doc. **Summary:** Detailed guide for wiring the console to backend `/api/v1` endpoints—env vars, exhaustive endpoint catalog, axios client configuration, auth flow, caching, job schedules, troubleshooting. **Dependencies:** Backend services on port 4000, Redis, ClickHouse, NextAuth. **Risks/TODOs:** Assumes `/api/v1` proxied under same host even though console env defaults to mixed service URLs; keep in sync with backend route changes to avoid bitrot. **Evidence:** Reviewed 2025‑11‑14.
- `console/BILLING_README.md` — **Type:** Doc. **Summary:** Module-focused spec for billing UI (usage, invoices, reconciliation) covering routes, feature flags, API calls, env vars, frontend/backend architecture, schema, Stripe webhook setup, testing, roadmap. **Dependencies:** Backend billing routes, Stripe API, ClickHouse usage data. **Risks/TODOs:** Feature list includes future phases (payment method management, dunning) not yet implemented—ensure navigation hides unfinished pages. **Evidence:** Reviewed 2025‑11‑14.
- `console/DESIGN_STANDARDS.md` — **Type:** Doc. **Summary:** Authoritative Aurora Slate design system (palette tokens, typography, layout rhythm, interaction + accessibility rules, component patterns, transparency UI guidelines). **Dependencies:** Tailwind theme definitions, lucide-react, recharts. **Risks/TODOs:** Mentions Storybook as “planned”; enforce updates whenever Tailwind config changes to avoid divergence. **Evidence:** Reviewed 2025‑11‑14.
- `console/.env.local.example` — **Type:** Config template. **Summary:** Minimal env skeleton for public API/Fraud/Analytics URLs plus NextAuth + optional OAuth IDs. **Dependencies:** Backend endpoints, NextAuth secret. **Risks/TODOs:** Only includes public URLs; lacks flags like `NEXT_PUBLIC_USE_MOCK_API` referenced elsewhere—devs must cross-check BACKEND_INTEGRATION doc. **Evidence:** Reviewed 2025‑11‑14.
- `console/.eslintrc.json` — **Type:** Config. **Summary:** Next.js core-web-vitals + jsx-a11y profile with strict accessibility rules, react performance linting, server-component safeguards, and TS project-aware parser. **Dependencies:** `eslint`, `eslint-config-next`, `eslint-plugin-jsx-a11y`. **Risks/TODOs:** Disallows `console.log` except warn/error; ensure observability strategy documented for client debugging. **Evidence:** Reviewed 2025‑11‑14.
- `console/package.json` — **Type:** Config. **Summary:** Scripts for dev/build/lint/type-check/test, Playwright E2E, bundle-size and Lighthouse budgets; dependencies include Next 14, NextAuth, Zustand, TanStack Query/Table, RHF, Zod; dev deps cover Testing Library, Jest, axe, MSW, Tailwind, Playwright. **Dependencies:** Node 18+, npm. **Risks/TODOs:** `npm test` passes with no tests (flag) so CI may miss regressions; consider wiring coverage + workspace-level lint hooking. **Evidence:** Reviewed 2025‑11‑14.
- `console/package-lock.json` — **Type:** Generated lockfile. **Summary:** Deterministic dependency tree for console workspace (Next 14, Playwright, Testing Library, etc.). **Dependencies:** npm. **Risks/TODOs:** Keep in sync when updating deps; large file (~MB) but required for reproducible builds. **Evidence:** Exists alongside package.json.
- `console/Dockerfile` — **Type:** Build config. **Summary:** Three-stage Node 20 Alpine pipeline (deps install, build, production runner with `npm run start` on port 3000). **Dependencies:** Node 20, Next build output, npm. **Risks/TODOs:** Final stage runs `npm install --omit=dev` after copying package files but not lockfile—risk of version drift; also duplicates dependency install instead of using `npm ci`. **Evidence:** Reviewed 2025‑11‑14.
- `console/next.config.js` — **Type:** Config. **Summary:** Enables React strict mode, swc minify, allows `localhost` images, and inlines fallback env defaults for backend URLs. **Dependencies:** Next.js runtime. **Risks/TODOs:** Using `env` section bakes values at build time—changes require rebuild; consider runtime config for env-specific deployments. **Evidence:** Reviewed 2025‑11‑14.
- `console/tsconfig.json` — **Type:** Config. **Summary:** Strict TS config w/ bundler resolution, Next plugin, path aliases for app/components/lib/hooks/types. **Dependencies:** TypeScript 5.5, Next. **Risks/TODOs:** `allowJs` true but repo is TS; ensure JS files don’t slip in accidentally. **Evidence:** Reviewed 2025‑11‑14.
- `console/tailwind.config.ts` — **Type:** Config. **Summary:** Points Tailwind to pages/components/app dirs, extends fonts/colors (Sweden palette + legacy tokens), defines animations, imports forms/typography plugins. **Dependencies:** Tailwind 3.3, PostCSS pipeline. **Risks/TODOs:** Content globs still include `src/pages` even though project uses App Router—safe but redundant; ensure palette matches DESIGN_STANDARDS to avoid drift. **Evidence:** Reviewed 2025‑11‑14.
- `console/postcss.config.js` — **Type:** Config. **Summary:** Default PostCSS stack (tailwindcss + autoprefixer). **Dependencies:** PostCSS toolchain. **Risks/TODOs:** None; consider adding cssnano for production builds if bundle size critical. **Evidence:** Reviewed 2025‑11‑14.
- `console/jest.config.js` — **Type:** Test config. **Summary:** JSDOM environment, Next babel transform with class-fields plugins, module aliasing for `@/*`, identity-obj for CSS, ignores node_modules except msw interceptors, roots at `src`. **Dependencies:** Jest 29, babel-jest, next/babel. **Risks/TODOs:** `jest --passWithNoTests` default may mask missing suites; ensure at least smoke tests exist. **Evidence:** Reviewed 2025‑11‑14.
- `console/jest.setup.ts` — **Type:** Test bootstrap. **Summary:** Configures env defaults, polyfills TextEncoder/Decoder, mocks Recharts ResponsiveContainer + canvas/IntersectionObserver/BroadcastChannel/WritableStream, swaps axios adapter for fetch, wires MSW server, mocks next-auth, loads Testing Library + jest-axe. **Dependencies:** axios, jest-axe, msw, Testing Library. **Risks/TODOs:** Custom axios adapter duplicates logic—keep in sync with browser behavior; ensure MSW handlers stay updated. **Evidence:** Reviewed 2025‑11‑14.
- `console/playwright.config.ts` — **Type:** Test config. **Summary:** Defines Playwright suite targeting `./tests`, 30s timeout, Desktop Chrome project, baseURL env override, traces on first retry. **Dependencies:** `@playwright/test`. **Risks/TODOs:** No Firefox/WebKit coverage; consider enabling for cross-browser parity. **Evidence:** Reviewed 2025‑11‑14.
- `console/lighthouse.config.cjs` — **Type:** Tooling config. **Summary:** Lighthouse CI script evaluating billing/transparency routes with strict ≥0.9 scores, budgets for FID/CLS/LCP, outputs JSON reports to `.lighthouse`. **Dependencies:** Lighthouse CLI. **Risks/TODOs:** Focuses only on billing/transparency; other critical pages (dashboard, fraud) not measured. **Evidence:** Reviewed 2025‑11‑14.
- `console/scripts/check-bundle-size.js` — **Type:** Script. **Summary:** Node CLI scanning `.next/static` bundle sizes against hard-coded KB budgets; outputs report, writes JSON summary, fails CI on exceed/warns at 90%. **Dependencies:** Node fs/path, built Next artifacts. **Risks/TODOs:** Budget keys reference `pages/*` even though App Router is used—needs update for `app/` chunk naming; script requires `npm run build` first or exits 1. **Evidence:** Reviewed 2025‑11‑14.
- `console/.next/` — **Type:** Generated build output. **Summary:** Next.js build cache containing compiled server/client bundles, route manifests, prerender data, and static assets under `static/` used by `npm run build/start`. **Dependencies:** Produced by Next build tooling (`next build`), consumed by the Dockerfile and bundle-size script. **Risks/TODOs:** Directory should stay untracked except for inspection; stale caches can mask config changes (clear before benchmarking). Ensure secrets never land in prerender JSON. **Evidence:** Observed via repo listing 2025‑11‑14.
- `console/.swc/` — **Type:** Generated cache. **Summary:** SWC transform cache storing incremental compile artifacts for faster dev builds/tests. **Dependencies:** Managed automatically by Next/SWC compiler. **Risks/TODOs:** Safe to delete when diagnosing weird transpilation bugs; should remain gitignored. **Evidence:** Observed via repo listing 2025‑11‑14.
- `console/node_modules/` — **Type:** Generated dependency tree. **Summary:** Workspace-specific npm install target housing Next.js, React, Testing Library, Playwright, Tailwind, etc., as declared in `console/package.json`. **Dependencies:** `npm install`/`npm ci`. **Risks/TODOs:** Large tree—never commit; delete/reinstall when lockfile changes to avoid mixed versions; ensure optional deps needed for Playwright are installed via postinstall. **Evidence:** Observed via repo listing 2025‑11‑14.
- `console/src/app/globals.css` — **Type:** Stylesheet. **Summary:** Imports Tailwind layers and defines the Study in Sweden palette, typography, and component utility classes (buttons, cards, inputs, badges) with square-corner motif plus light/dark foreground settings. **Dependencies:** Tailwind 3 layer system, global Inter font stack. **Risks/TODOs:** Custom classes must be mirrored in DESIGN_STANDARDS; lacks automatic dark-mode variants beyond root colors. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/layout.tsx` — **Type:** Source (App Router root layout). **Summary:** Wraps every page with Inter font, shared `Providers`, and `Navigation` chrome; exports metadata title/description for the console. **Dependencies:** Next.js App Router, `next/font/google`, `@/components/Navigation`. **Risks/TODOs:** Always renders navigation even on unauthenticated routes (e.g., `/login`); consider conditional shell when session absent. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/providers.tsx` — **Type:** Source (client component). **Summary:** Hydrates React Query client with 60s stale windows, wraps app in NextAuth `SessionProvider`, and eagerly fetches CSRF token via `getCsrfToken()` effect to prime cookie. **Dependencies:** `@tanstack/react-query`, `next-auth/react`, custom `lib/csrf`. **Risks/TODOs:** No query cache dehydrate support, so SSR data always re-fetches; CSRF bootstrap assumes API endpoint available even for anonymous sessions. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/page.tsx` — **Type:** Source (home page). **Summary:** Minimal landing call-to-action that links to `/login` inside a centered hero, primarily for redirecting root traffic. **Dependencies:** Tailwind utility classes. **Risks/TODOs:** Static copy ignores session state—authenticated users still see CTA instead of dashboard redirect. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/error.tsx` — **Type:** Source (global error boundary). **Summary:** Client component that renders semantic alert with digest ID and retry button by calling provided `reset()`. **Dependencies:** Next.js App Router error handling. **Risks/TODOs:** Lacks brand styling (uses bare button) and doesn’t report errors to telemetry; consider hooking into logging service. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/403/page.tsx` — **Type:** Source (client route). **Summary:** Simple forbidden screen with Study in Sweden styling reminding users to contact admin. **Dependencies:** Tailwind. **Risks/TODOs:** No navigation link back or auto-redirect; consider hooking into RBAC guard responses to send here automatically. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/api/auth/[...nextauth]/route.ts` — **Type:** Source (NextAuth route). **Summary:** Credentials-only auth provider that either returns mock identities when `NEXT_PUBLIC_USE_MOCK_API=true` or proxies to backend `/auth/login`, enriches JWT tokens with role/publisherId/sessionVersion, shortens admin session max-age, and exposes `/login` as sign-in/error pages. **Dependencies:** NextAuth, `next-auth/providers/credentials`, custom Axios `apiClient`. **Risks/TODOs:** Only credentials auth implemented; no OAuth/social providers; mock mode trusts any email containing “demo” which must be gated from production. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/api/auth/__tests__/session.security.test.ts` — **Type:** Test. **Summary:** Jest suite that mocks NextAuth to assert secure cookies in production and ensures session callback tightens admin session lifetimes plus sessionVersion rotation when roles change. **Dependencies:** Jest, dynamic import of auth route. **Risks/TODOs:** Limited coverage (doesn’t assert authorize path, CSRF, or error events); relies on jest.resetModules which can mask caching issues elsewhere. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/api/mock/route.ts` — **Type:** Source (mock API). **Summary:** Force-dynamic edge handler returning randomized dashboard data (revenue summary/time series, placements, adapters, fraud stats/alerts, payout history/upcoming, analytics breakdowns) with simulated latency and endpoint switch via `?endpoint=`. **Dependencies:** NextResponse, Math random helpers. **Risks/TODOs:** Mock payload shapes must stay in sync with UI expectations; randomness plus limited pagination could mask frontend bugs; should be disabled in production builds. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/api/test/route.ts` — **Type:** Source (test API). **Summary:** Minimal GET handler returning plain text for environment checks. **Dependencies:** Web Response API. **Risks/TODOs:** Exposes static string publicly; ensure route is removed or locked down before shipping. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/login/page.tsx` — **Type:** Source (client page). **Summary:** Full-screen login experience that pre-fills demo credentials, posts to NextAuth credentials provider via `signIn`, handles error states, and redirects to `/dashboard` on success while showing demo notice CTA. **Dependencies:** React hooks, NextAuth `signIn`, Next.js router, lucide-react `Shield`, Tailwind utilities. **Risks/TODOs:** Logs emails/password attempts to console (security risk) and exposes demo instructions even in production; no password managers/csrf tokens or CAPTCHA/rate limiting on UI side—ensure backend guards brute force. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/dashboard/page.tsx` — **Type:** Source (client page). **Summary:** Main publisher dashboard fetching revenue summaries via React Query + `revenueApi`, rendering KPI cards, charts, fraud/payout widgets, date-range presets, CSV export, and quick links—all personalized with session data. **Dependencies:** NextAuth session hook, TanStack Query, `@/lib/api` revenue client, `@/components/dashboard/*`, util formatters, lucide-react icons, browser Blob APIs. **Risks/TODOs:** CSV export happens client-side without i18n/escaping; KPI fallbacks use hard-coded defaults so real outages could mislead users; no loading/error states for Fraud/Payout widgets. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/analytics/page.tsx` — **Type:** Source (client page). **Summary:** Advanced analytics view layering date-range + granularity controls atop React Query calls to `revenueApi` time series/summary endpoints, rendering multiple Recharts visualizations plus CSV export. **Dependencies:** TanStack Query, Recharts (LineChart/BarChart components), lucide-react icons, `@/lib/api`, utility formatters, browser Blob APIs. **Risks/TODOs:** CSV export is generated client-side without escaping or localization; charts rely on browser locale conversion and skip accessibility descriptions; no explicit empty/error states beyond silent null renders, so failed API calls leave blank sections. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/fraud/page.tsx` — **Type:** Source (client page). **Summary:** Fraud monitoring dashboard querying `fraudApi` for stats/alerts per publisher, offering time-window filters, detection breakdown, alert list, and top pattern chips using lucide icons + Tailwind components. **Dependencies:** NextAuth session (publisherId), TanStack Query, `@/lib/api` fraud client, utility formatters, lucide-react. **Risks/TODOs:** Falls back to hard-coded `demo-pub-1` when session missing (risk of cross-tenant leakage); no Pagination or severity filtering on alerts; severity colors embedded in component rather than Tailwind theme, making them hard to update centrally. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/billing/layout.tsx` — **Type:** Source (client layout). **Summary:** Billing section shell that renders a credit-card header and sticky sub-nav linking to usage, invoices, and settings, highlighting the active tab via pathname checks. **Dependencies:** Next.js App Router `usePathname`, `next/link`, lucide-react icons, Tailwind utilities. **Risks/TODOs:** No authorization guard—users without billing access could still hit nested routes if server doesn’t block; nav labels/hrefs are hard-coded so new subsections require manual edits. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/billing/page.tsx` — **Type:** Source (client page). **Summary:** Acts as `/billing` index that immediately redirects to `/billing/usage` using `router.replace` and shows a skeleton while navigation completes. **Dependencies:** Next.js router. **Risks/TODOs:** Uses `useEffect` redirect (client-only) so route briefly flashes; consider server-side redirect or `redirect()` helper for better UX/accessibility. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/billing/usage/page.tsx` — **Type:** Source (client page). **Summary:** Fetches billing usage from `getCurrentUsage` helper, shows loading/error/empty states, then renders cards for impressions/API/data transfer, overage summary, and informational guidance with color-coded progress bars. **Dependencies:** `@/lib/billing`, lucide-react icons, browser Intl formatters. **Risks/TODOs:** All usage data is client-side without React Query caching, so component refetches per mount; formatting functions assume en-US locale and duplicate logic from `@/lib/utils`; overage detection exposes raw plan limits on client (ensure acceptable). **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/billing/invoices/page.tsx` — **Type:** Source (client page). **Summary:** Invoice list view pulling paginated data via `listInvoices`, supporting status filters, empty/error skeletons, and linking to detail pages with StatusBadge + Pagination components. **Dependencies:** `@/lib/billing`, `@/components/ui/{StatusBadge,Pagination,Filters}`, lucide-react, Next Link. **Risks/TODOs:** Fetch logic runs on every filter/page change but lacks AbortController, so stale responses might win; Filters component props typed as `any`; currency/date formatting hard-coded to en-US. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/billing/invoices/[id]/page.tsx` — **Type:** Source (client page). **Summary:** Invoice detail view that loads a single invoice via `getInvoice`, supports PDF download via `downloadInvoicePDF`, displays line items, status callouts, and contextual guidance for pending/paid invoices. **Dependencies:** Next `useParams`, `@/lib/billing`, lucide-react icons, browser Intl formatters. **Risks/TODOs:** Download fallback uses `alert` for errors; no guard for unauthorized access (depends on backend); `useEffect` has no cleanup so multiple rapid route changes could leave race conditions. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/billing/settings/page.tsx` — **Type:** Source (client page). **Summary:** Billing settings surface using React Query + mutations to update billing email, receipt preferences, and open Stripe portal via `/billing/portal`, while showing plan quotas and preference toggles with optimistic UI. **Dependencies:** `@tanstack/react-query`, `@/lib/api-client`, lucide-react icons. **Risks/TODOs:** Mutations fire immediately on checkbox toggle without confirmation or debounce; toast status stored locally so message disappears on navigation reload; no form validation for email beyond HTML5; assumes backend endpoints exist even for anonymous users. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/payouts/page.tsx` — **Type:** Source (client page). **Summary:** Payout dashboard combining React Query calls to `payoutApi` for history + upcoming transfers, renders summary card, tables with status badges, manual pagination, and client-side CSV export. **Dependencies:** `@tanstack/react-query`, `@/lib/api`, `@/lib/utils` formatters, lucide-react icons, browser Blob APIs. **Risks/TODOs:** CSV export lacks escaping/localization; pagination is stateless (no total pages so “Next” may overshoot); method/status configs repeated here instead of shared constants; no auth state use—relies on API to scope publisher. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/settings/page.tsx` — **Type:** Source (client page). **Summary:** Settings hub that renders five semantic cards (fraud, payouts, team, notifications, compliance) with lucide icons and deep links into nested routes. **Dependencies:** Next App Router, `next/link`, lucide-react icons, Tailwind utility classes. **Risks/TODOs:** Page is always client-rendered and assumes downstream routes enforce auth/feature gates; consider server-side redirect if user lacks access. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/settings/fraud/page.tsx` — **Type:** Source (client page). **Summary:** React Hook Form + Zod-driven fraud configuration editor that loads/saves alert emails, webhook, warning/block thresholds, and auto-block toggle via `settingsApi`. **Dependencies:** `react-hook-form`, `@tanstack/react-query`, `zod`, `@hookform/resolvers/zod`, `@/lib/api`. **Risks/TODOs:** Email field only enforces non-empty string—no validation per recipient; thresholds expect 0–1 decimals but UI captions call them “percent,” so users may input 90 instead of 0.9; no dirty-state warning before navigating away. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/settings/compliance/page.tsx` — **Type:** Source (client page). **Summary:** Comprehensive privacy/compliance form covering GDPR/CCPA/COPPA toggles, consent provider + auto-block, data retention durations, and regional restrictions mapped to backend via `settingsApi`. **Dependencies:** `react-hook-form`, `@tanstack/react-query`, `zod`, lucide icons, Tailwind. **Risks/TODOs:** Blocked countries/categories stored as bare comma-separated strings with no ISO validation; `consentString` is stored client-side without encryption and could leak if browser history inspected; no debouncing so repeated checkbox toggles fire full mutation. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/settings/notifications/page.tsx` — **Type:** Source (client page). **Summary:** Notification center UI that edits email/slack/webhook/digest channels, manages dynamic webhook endpoint list, and allows ad-hoc webhook creation before persisting through `settingsApi`. **Dependencies:** `@tanstack/react-query`, `react-hook-form`, `zod`, lucide icons, custom `settingsApi`. **Risks/TODOs:** Newly-added webhook entries live only in local state until Save with no validation of URL uniqueness or event selection; removing an endpoint has no confirmation; digest/slack toggles immediately show inputs but there’s no guard against submitting empty recipient lists. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/settings/team/page.tsx` — **Type:** Source (client page). **Summary:** Team management surface fetching members via `teamApi`, inviting/removing/resending via React Query mutations, and rendering role cards + contextual menus. **Dependencies:** `@tanstack/react-query`, `@/lib/api` (team endpoints), lucide-react icons, Tailwind. **Risks/TODOs:** Context menu state is stored by member ID but there’s no outside-click handler, so menus stay open indefinitely; removing members lacks confirmation; roles/descriptions are hard-coded so backend role additions require code changes. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/settings/payout/page.tsx` — **Type:** Source (client page). **Summary:** Finance settings form tied to `settingsApi` for payout method/currency/minimums/autopayout toggles with Zod validation and optimistic card UI. **Dependencies:** `@tanstack/react-query`, `react-hook-form`, `zod`, lucide icons. **Risks/TODOs:** Account reference field is plain text with no masking besides placeholder; backup method dropdown allows same provider as primary without warning; no confirmation modal before saving sensitive banking changes. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/settings/payouts/page.tsx` — **Type:** Source (client page, duplicate). **Summary:** Copy-pasted version of `settings/payout/page.tsx` (even the component name) with only minor indentation differences. **Dependencies:** Same as payout settings. **Risks/TODOs:** Maintaining two identical files will cause drift and confuses routing (`/settings/payout` vs `/settings/payouts`); consolidate into one page or alias route to avoid duplicate logic. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/adapters/page.tsx` — **Type:** Source (client page). **Summary:** Adapter directory that fetches adapter list + placement lookup via React Query, provides search + filters (status/network), and renders metric cards per adapter with placement shortcut links. **Dependencies:** `@tanstack/react-query`, `@/lib/api` (`adapterApi`, `placementApi`), `formatNumber`, lucide-react icons, Next Link. **Risks/TODOs:** No inline error states—API failures leave blank UI; placement lookup requests up to 200 rows on every visit with no caching beyond React Query default; Manage buttons navigate without prefetching data so detail page always waits on new request. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/adapters/new/page.tsx` — **Type:** Source (client page). **Summary:** Adapter creation wizard using RHF/Zod to gather network, placement, status, priority, eCPM, and fill-rate percent before posting to `adapterApi.create`. **Dependencies:** `react-hook-form`, `@tanstack/react-query`, `@hookform/resolvers/zod`, `@/lib/api`, Next Router. **Risks/TODOs:** Fill-rate is accepted as percent but converted to 0–1 by dividing by 100; validation messages don’t clarify units; there’s no optimistic feedback when placement lookup fails, so dropdown can appear empty without explanation. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/adapters/[id]/page.tsx` — **Type:** Source (client page). **Summary:** Adapter detail + editing page that loads adapter + placement, allows updating status/priority/eCPM/fill-rate, deleting adapter, and shows performance snapshot plus linked placement info. **Dependencies:** `@tanstack/react-query`, `react-hook-form`, `@/lib/api`, Next Router, lucide-react icons. **Risks/TODOs:** Delete action is a single click away once confirmation state toggled—no modal or undo, so accidental clicks can remove adapters; placement lookup query runs even while adapter fetch is pending; fill-rate field expects 0–100 but default uses (fillRate * 100). **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/placements/page.tsx` — **Type:** Source (client page). **Summary:** Placement inventory view with search/status filters, React Query pagination, skeletons, and action buttons linking to detail/edit. **Dependencies:** `@tanstack/react-query`, `@/lib/api` (`placementApi`), lucide-react icons, `formatNumber`. **Risks/TODOs:** Status filter depends on placement status string but there’s no fallback if API introduces new states; “Load More” increments `page` but backend `list` already supports pagination with `pageSize`—there’s no `useInfiniteQuery`, so repeated loads override rather than append. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/placements/new/page.tsx` — **Type:** Source (client page). **Summary:** Placement creation form using RHF/Zod to capture name, platform ID, type, and format (with options auto-adjusting by type) before calling `placementApi.create`. **Dependencies:** `react-hook-form`, `@hookform/resolvers/zod`, `@/lib/api`, Next Router. **Risks/TODOs:** Format dropdown options are hard-coded arrays—if backend introduces responsive sizes they must be duplicated here; no duplicate-name check or slug preview, so users may unknowingly create conflicting placements. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/placements/[id]/page.tsx` — **Type:** Source (client page). **Summary:** Placement detail surface showing status, metadata, associated adapters (with metrics + links), and actions to pause/activate/delete placement synchronized via React Query invalidations. **Dependencies:** `@tanstack/react-query`, `@/lib/api` (`placementApi`, `adapterApi`), `formatNumber`, lucide-react icons, Next Router. **Risks/TODOs:** Delete confirmation is a second button press but still occurs inline without modal; adapter list fetch passes placement ID to `adapterApi.list` but there’s no separate loading/error state, so adapter errors silently suppress configuration UI; metadata card exposes publisher ID publicly—ensure acceptable. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/admin/layout.tsx` — **Type:** Source (client layout). **Summary:** Admin shell that calls `useAdminGate()` (auth guard) and renders tabbed navigation (Health, Billing Ops, Audit). **Dependencies:** `useAdminGate` hook, Next Router `usePathname`, `next/link`, Tailwind. **Risks/TODOs:** Tabs rely on `pathname.startsWith` which treats `/admin/sales-automation` as matching `/admin/s`? (no entry) so nav doesn’t highlight advanced routes; consider deriving tab list from route groups to avoid drift. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/admin/page.tsx` — **Type:** Source (server component). **Summary:** Simple redirect that sends `/admin` visitors to `/admin/health`. **Dependencies:** Next.js `redirect()` helper. **Risks/TODOs:** None beyond ensuring `/admin/health` stays accessible; keep for bookmark compatibility. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/admin/health/page.tsx` — **Type:** Source (client page). **Summary:** Live operations dashboard hitting `/meta/info` and `/admin/health/red` via `apiClient`, displaying service metadata and RED metrics with color-coded badges, plus quick links to `/metrics` and `/health`. **Dependencies:** Custom `apiClient`, lucide icons? (none), React hooks, Tailwind. **Risks/TODOs:** Polls RED endpoint every 30s on client without abort; no auth guard aside from upstream layout; thresholds hard-coded so DevOps must edit code to change alert levels. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/admin/billing/page.tsx` — **Type:** Source (client page). **Summary:** Billing ops console exposing manual reconciliation trigger (`reconcileBilling` helper), inputs for resending invoices, and CTA to billing settings. **Dependencies:** `@/lib/billing.reconcileBilling`, React state, Tailwind. **Risks/TODOs:** Invoice/email inputs are unused (button disabled) so UI advertises a feature that doesn’t exist; manual reconcile lacks confirmation and always uses new idempotency key—even double-clicking will fire multiple backend jobs. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/admin/audit/page.tsx` — **Type:** Source (client page). **Summary:** Billing audit log table that pages through `listBillingAudit` results and uses shared `Pagination` component for navigation. **Dependencies:** `@/lib/admin.listBillingAudit`, React state/effect, `@/components/ui/Pagination`. **Risks/TODOs:** Table doesn’t expose CSV download despite audit use cases; `safeSummary` truncates JSON but doesn’t escape HTML, so malicious metadata could inject markup into UI. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/admin/sales-automation/page.tsx` — **Type:** Source (client page). **Summary:** Static “Sales Automation Dashboard” demo visualizing Cialdini principles with custom metric cards, funnel, tables, and actions; no backend calls. **Dependencies:** Pure React/Tailwind, emoji icons. **Risks/TODOs:** Entire page is hard-coded demo data—should be wired to real analytics before exposing to customers; large component (~600 LOC) with inline components makes maintenance difficult. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/admin/value-multipliers/page.tsx` — **Type:** Source (client page). **Summary:** Placeholder dashboard summarizing “Value Multipliers” strategies referencing `VALUE_MULTIPLIER_SUMMARY.md`, providing narrative cards and status callouts. **Dependencies:** Tailwind, static copy. **Risks/TODOs:** Claims features like cron jobs/migrations are in progress but no live data; duplicate source-of-truth between this UI and markdown doc invites drift. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/migration-studio/page.tsx` — **Type:** Source (client page). **Summary:** Migration Studio index that fetches placements + experiments via React Query, shows contextual banners based on experiment status, renders experiment cards with guardrail summaries, and wires up import wizard + guardrail evaluation/activate/pause mutations. **Dependencies:** `@tanstack/react-query`, `@/lib/api` (`migrationApi`, `placementApi`), custom `ImportWizard`, i18n helpers (`t`, `formatDate`), lucide icons. **Risks/TODOs:** Heavy client bundle (~500 LOC) with sizable inline logic; guardrail evaluation triggers network call per click with no debouncing; banner logic assumes only one draft/paused/active experiment and may behave oddly if multiples exist. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/migration-studio/[experimentId]/page.tsx` — **Type:** Source (client page). **Summary:** Detailed experiment control center handling guardrail forms, mirror-percent slider, activation/pause/evaluate mutations, report downloads, share link CRUD, timeseries visualization (Recharts), and canonical payload download flows. **Dependencies:** `@tanstack/react-query`, `@/lib/api.migrationApi`, `recharts`, `@/i18n` formatters, lucide icons, custom components (Spinner). **Risks/TODOs:** File exceeds 1,500 LOC making it hard to reason about; local state stores guardrail numbers as strings and manual parsing may desync with backend precision; share-link copy relies on `navigator.clipboard` (fails on HTTP origins) and there’s no fallback; download/report actions lack progress indicators leading to repeated clicks. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/transparency/summary/page.tsx` — **Type:** Source (client page). **Summary:** Lightweight summary view querying `/transparency/summary/auctions` via `apiClient` and showing simple stat tiles plus winners-by-source list. **Dependencies:** Custom `apiClient`, React hooks. **Risks/TODOs:** Lacks retry or timestamp display, so stale data indistinguishable; errors shown as raw message strings without localization. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/transparency/auctions/page.tsx` — **Type:** Source (client page). **Summary:** Auction explorer that syncs filters to URL query params, debounces inputs, fetches paginated auction rows via `transparencyApi`, and renders accessible table with copy buttons and Verify badge integration. **Dependencies:** Custom `transparencyApi`, helper hooks (`useQueryParams`, `useDebouncedValue`), shared UI components (`VerifyBadge`, `CopyButton`, `Skeleton`), Next Link. **Risks/TODOs:** Fetch runs client-side only with no SSR data, so first paint is always loading state even on fast connections; filter inputs accept any string (no ISO validation) and send raw values to backend; pagination only tracks page number and doesn’t display total count or disable “Next” when API indicates last page. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/transparency/auctions/page.test.tsx` — **Type:** Test. **Summary:** RTL/Jest unit tests mocking Next navigation + transparency API to verify header rendering, skeleton display, table content, filters presence, empty/error states, and copy buttons. **Dependencies:** `@testing-library/react`, Jest, `next/navigation` mocks, custom API mock. **Risks/TODOs:** Tests rely on DOM text like `auc-123` which only appears in truncated link—brittle if UI abbreviates differently; clipboard mock is global and may leak into other suites; no coverage for URL sync behavior or Verify badge interaction. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/transparency/auctions/page.a11y.test.tsx` — **Type:** Test (a11y). **Summary:** Jest + jest-axe suite ensuring page renders without major axe violations and basic keyboard navigation reaches controls, with debounced hook mocked for determinism. **Dependencies:** `@testing-library/react`, `jest-axe`, `@testing-library/user-event`, Next navigation mocks. **Risks/TODOs:** Disables key axe rules (color-contrast, button-name) so violations there won’t be caught; keyboard test only tabs twice and asserts there “are buttons,” so it doesn’t guarantee focus order/accessibility semantics. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/app/transparency/auctions/[auction_id]/page.tsx` — **Type:** Source (client page). **Summary:** Detailed auction inspector that fetches auction + signature verification concurrently, renders overview metadata, cryptographic details (signing key, algorithm, canonical payload), verification badge, and bid candidate table with status pills. **Dependencies:** Custom `transparencyApi`, shared `CopyButton` & `VerifyBadge`, lucide icons, Tailwind. **Risks/TODOs:** Canonical payload is prettified JSON in `<pre>` without truncation—very large auctions could freeze the browser; fetch errors are displayed but there’s no retry; verification call runs even when auction lacks integrity block. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/components/Breadcrumbs.tsx` — **Type:** Source (client component). **Summary:** Reusable breadcrumb trail that either consumes explicit `items` or infers them by splitting the current pathname, normalizing labels, and handling invoice-ID special cases before rendering semantic navigation with Home icon + chevrons. **Dependencies:** Next App Router `usePathname`, `next/link`, lucide-react icons. **Risks/TODOs:** Auto-generated labels simply capitalize path segments and don’t localize or map known route titles, so pages with slugs (e.g., `migration-studio`) show hyphenated casing; inferred invoice IDs truncate to 8 chars but don’t validate UUID vs short ID, which could leak full identifiers; component renders nothing on `/` which is fine but callers must ensure breadcrumbs aren’t required for accessibility. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/components/Navigation.tsx` — **Type:** Source (client layout component). **Summary:** Primary application chrome that conditionally renders a sidebar + top mobile nav with feature-flag-driven links (billing, transparency, migration studio) and admin-only tabs, mobile drawer toggle, and user menu with sign-out. **Dependencies:** Next App Router `usePathname`, NextAuth `signOut`, custom hooks `useSession` + `useFeatures`, lucide-react icons, Tailwind. **Risks/TODOs:** Feature flags fall back to public env vars baked at build time so disabling a feature mid-session still shows nav entry; navigation list uses `splice` to insert items by index which is brittle as routes change; sign-out button lacks loading state so repeated clicks may throw; sidebar renders even during auth loading and only hides on `/login`/root, so unauthorized users briefly see nav links. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/components/Navigation.a11y.test.tsx` — **Type:** Test. **Summary:** jest-axe accessibility smoke test that renders `Navigation` with mocked session/feature flag hooks and asserts zero axe violations. **Dependencies:** React Testing Library, `jest-axe`, mocked `next/navigation`, `@/lib/useSession`, `@/lib/useFeatures`. **Risks/TODOs:** Only covers static rendering on `/dashboard`; doesn’t inspect keyboard focus order, reduced motion, or screen reader labels; a11y coverage limited to default flag combination. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/components/Navigation.feature.test.tsx` — **Type:** Test. **Summary:** Feature-flag regression test mocking `useFeatures`, `useSession`, and `usePathname` to ensure Migration Studio nav link appears/disappears based on flag state using RTL queries. **Dependencies:** React Testing Library, Jest mocks for Next navigation/link + custom hooks. **Risks/TODOs:** Covers only Migration Studio flag—billing/transparency/admin visibility untested; relies on manual mock fetch polyfill that could drift from real hook behavior. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/components/charts/RevenueCharts.tsx` — **Type:** Source (client components). **Summary:** Collection of six Recharts-based visualizations (revenue line/area, impressions bar, eCPM, fill-rate, combined metrics) sharing `formatCurrency/formatNumber` helpers, custom tooltips, and responsive containers for dashboard/analytics pages. **Dependencies:** `recharts`, `@/lib/utils` formatting helpers, browser Intl APIs. **Risks/TODOs:** Charts format dates/numbers with hard-coded `en-US` locale and USD currency, so intl builds will mismatch; fill-rate chart assumes data normalized 0–1 but upstream screens often send percents, risking double-scaling; no SSR fallbacks or loading placeholders so components expect `window`—using them in server components will error. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/components/dashboard/DashboardCharts.tsx` — **Type:** Source (client component). **Summary:** React Query-powered wrapper that fetches revenue time series and renders revenue + eCPM charts with skeleton placeholders during load. **Dependencies:** `@tanstack/react-query`, `revenueApi`, `RevenueAreaChart`, `EcpmLineChart`. **Risks/TODOs:** Query key serializes `dateRange` object directly, so referential equality changes cause duplicate fetches; no explicit error state—API failures show blank cards; time zone conversions rely on browser locale leading to inconsistent X-axis labels across users. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/components/dashboard/FraudWidget.tsx` — **Type:** Source (client component). **Summary:** Fraud KPI card that calls `fraudApi.getStats`, computes severity buckets, and renders multiple stat blocks, badges, and CTA to the fraud dashboard with skeleton fallback. **Dependencies:** `@tanstack/react-query`, `fraudApi`, `@/lib/utils` formatters, lucide-react icons, Next Link. **Risks/TODOs:** Hard-coded thresholds (2%/5%) don’t match backend configuration; widget assumes `fraudStats` shape includes `lastUpdated` string parseable by browser but lacks guard; CTA always points to `/fraud` even if feature disabled. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/components/dashboard/MetricCard.tsx` — **Type:** Source (client component). **Summary:** Generic KPI tile used across dashboard analytics; formats title/value, trend arrows, and includes skeleton generator for loading grids. **Dependencies:** lucide-react icons provided by caller, Tailwind classes. **Risks/TODOs:** Accepts arbitrary React nodes for icons without size enforcement so inconsistent designs possible; `change` displayed as `%` regardless of actual unit; skeleton uses array indices as keys (fine) but duplicates markup across dashboards—consider sharing via UI kit. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/components/dashboard/PayoutWidget.tsx` — **Type:** Source (client component). **Summary:** Upcoming payout card fetching `payoutApi.getUpcoming`, showing amount, scheduled date, method, status badge, and CTA buttons with skeleton fallback when loading or empty-state when no payout scheduled. **Dependencies:** `@tanstack/react-query`, `payoutApi`, `@/lib/utils.formatCurrency`, lucide-react icons, Next Link. **Risks/TODOs:** Days-until calculation assumes browser clock/time zone, so late-night users may see negative numbers; status color map doesn’t cover new statuses from backend; links hard-code `/settings/payouts` which duplicates duplicate settings route bug. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/components/migration-studio/ImportWizard.tsx` — **Type:** Source (client component). **Summary:** 750‑line modal wizard managing Migration Studio imports: handles CSV vs ironSource/AppLovin credential flows, keyboard dismissal, React Query mutations for create/update/finalize, assignment persistence, signed comparison display with copyable signature payload, and success confirmation callbacks. **Dependencies:** `@tanstack/react-query`, `migrationApi`, `@/components/ui/Spinner`, `@/i18n` helpers, browser clipboard API, lucide-react icons. **Risks/TODOs:** Large component mixes state, API calls, and presentation—difficult to test/maintain; assignment persistence fires one mutation per mapping with no batching or error recovery; clipboard copy lacks fallback for insecure origins; summary cards assume `importResult.summary` always present; ESC listener never removes focus trap for screen readers. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/components/migration-studio/ImportWizard.test.tsx` — **Type:** Test. **Summary:** RTL + React Query harness verifying CSV upload path, mapping assignment persistence, finalize success happy path, and guard preventing finalize when assignments unresolved by mocking `migrationApi`. **Dependencies:** React Testing Library, `@tanstack/react-query`, Jest, `migrationApi` mocks. **Risks/TODOs:** Tests cover only CSV (no API connector paths), don’t exercise error states, signed comparison UI, or keyboard dismissal; query client setup disables retries but there’s no coverage for mutation failures; uses real timers which could slow suite. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/components/ui/CopyButton.tsx` — **Type:** Source (client component). **Summary:** Clipboard helper with default/inline/icon variants, tooltip integration, and temporary “Copied” feedback using `navigator.clipboard`. **Dependencies:** Browser clipboard API, lucide-react icons, local `Tooltip`. **Risks/TODOs:** Fails silently when clipboard unavailable (no toast/fallback) and assumes HTTPS context; timers use `setTimeout` without cleanup so component unmount may warn; tooltip text hard-coded to English (no i18n). **Evidence:** Reviewed 2025‑11‑14.
- `console/src/components/ui/Filters.tsx` — **Type:** Source (component). **Summary:** Minimal invoice status select used on billing invoices list; renders label + select and emits `onStatusChange`. **Dependencies:** React only. **Risks/TODOs:** Status options are hard-coded, so backend additions require code changes; no i18n; default `all` option not localized. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/components/ui/Pagination.tsx` — **Type:** Source (component). **Summary:** Simple pager with Previous/Next buttons and “Page X of Y” label controlling state via callbacks. **Dependencies:** React only. **Risks/TODOs:** Doesn’t guard when `totalPages` is 0 (shows “Page 1 of 1” even when empty); lacks first/last buttons or page input; no aria-current attributes for better accessibility. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/components/ui/Spinner.tsx` — **Type:** Source (client component). **Summary:** Provides animated lucide spinner plus shared `Skeleton` placeholder component with variant/size props per design standards. **Dependencies:** lucide-react. **Risks/TODOs:** Spinner wraps label in visually hidden span but still renders `div` with inline-flex (fine). Skeleton accepts arbitrary Tailwind classes but no min width; repeated usage duplicates animation wrappers—consider factoring into UI library. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/components/ui/StatusBadge.tsx` — **Type:** Source (component). **Summary:** Maps billing invoice statuses to color-coded lucide icons and accessible labels. **Dependencies:** lucide-react icons. **Risks/TODOs:** Only supports five statuses; uses hard-coded palette not tied to Tailwind tokens; duplicates `capitalize` helper. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/components/ui/Tooltip.tsx` — **Type:** Source (client component). **Summary:** Custom tooltip handling hover/focus with optional delay, directional arrows, and manual show/hide state. **Dependencies:** React state/effects. **Risks/TODOs:** Doesn’t reposition on viewport edges or portals, so tooltips may overflow; `setTimeout` stored in state but not cleared on unmount; not SSR-safe due to DOM APIs but file is client component. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/components/ui/VerifyBadge.tsx` — **Type:** Source (client component). **Summary:** Lazy-loaded badge that triggers `transparencyApi.verify`, handles loading/error states, compact vs full badges, tooltips per status, and optional autoLoad. **Dependencies:** `@/lib/transparency`, local `Tooltip` + `Spinner`, lucide-react icons, browser clipboard/timeouts. **Risks/TODOs:** No cancellation for in-flight verify requests when component unmounts; error tooltip exposes raw message; repeated clicks once loaded do nothing (OK) but there’s no manual refresh; autoLoad effect lacks auctionId dependency leading to stale data when ID changes. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/components/ui/__tests__/CopyButton.test.tsx` — **Type:** Test. **Summary:** RTL suite mocking clipboard to verify CopyButton variants, copy invocation, timeout reset, custom labels, and size classes. **Dependencies:** React Testing Library, jest fake timers. **Risks/TODOs:** Mutates global `navigator.clipboard` which may leak between suites; doesn’t test tooltip or error fallback; coverage limited to default button markup (no inline variant accessible text). **Evidence:** Reviewed 2025‑11‑14.
- `console/src/components/ui/__tests__/Spinner.test.tsx` — **Type:** Test. **Summary:** Combined tests for Tooltip, Spinner, and Skeleton verifying tooltip show/hide, spinner sizes/labels, and skeleton variants/dimensions. **Dependencies:** RTL, lucide icon DOM output, jest timers (implicit). **Risks/TODOs:** Tooltip timing tests rely on `delay={0}` but still asynchronous; skeleton dimension test queries class string `'w-32.h-4'` which depends on class order; spinner tests don’t assert aria attributes beyond sr-only text. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/components/ui/__tests__/VerifyBadge.test.tsx` — **Type:** Test. **Summary:** RTL tests mocking `transparencyApi` to cover not-signed state, manual verify button, auto-load spinner, PASS/FAIL/N/A/UNKNOWN KEY statuses, error handling, compact mode, and verifying single fetch. **Dependencies:** React Testing Library, jest mocks. **Risks/TODOs:** Doesn’t test tooltip text content or manual retry after error; uses timers/timeouts implicitly; test double doesn’t cover `autoLoad` false + repeated clicks. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/components/ui/index.ts` — **Type:** Source (barrel). **Summary:** Client-only barrel re-exporting Tooltip, Spinner/Skeleton, VerifyBadge, CopyButton for simpler imports. **Dependencies:** Underlying UI components. **Risks/TODOs:** Because of `'use client'` directive, importing from this barrel forces client bundling even for server components needing only non-interactive exports; consider splitting server-safe exports. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/lib/api-client.ts` — **Type:** Source (utility). **Summary:** Central Axios clients for core, fraud, and analytics APIs with 10s timeout, credentialed cookies, CSRF token injection on mutating requests, and global 401 redirect to `/login`. **Dependencies:** `axios`, local `getCsrfToken`/`readXsrfCookie`. **Risks/TODOs:** Interceptor pulls CSRF token via `fetch` on every mutating call which can double-trigger network traffic; direct `window.location` assignment from any 401 can clobber routers or in-flight actions; no server-side guard so importing client config in RSCs will reference `window`. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/lib/api.ts` — **Type:** Source (utility). **Summary:** Monolithic REST wrapper exposing publisher, placement, adapter, revenue, analytics, fraud, migration (experiments/imports/guardrails/share links), payout, settings, and team clients with mock-mode fallbacks. **Dependencies:** `apiClient`, `fraudApiClient`, `analyticsApiClient`, shared TypeScript DTOs. **Risks/TODOs:** 500+ lines mixing unrelated concerns and embedding mock data builders, making tree-shaking and testing difficult; many helpers return `{ data }` wrappers while others unwrap bodies leading to inconsistent calling conventions; `createImport` streams raw `File` but doesn’t validate size/type before posting; missing pagination defaults for some list calls. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/lib/admin.ts` — **Type:** Source (utility). **Summary:** Thin helper that fetches billing audit entries with query params and pipes API errors through `handleApiError`. **Dependencies:** `apiClient`. **Risks/TODOs:** `metadata` typed as `any` so callers must cast; no caching or React Query integration so UI must manage state manually. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/lib/billing.ts` — **Type:** Source (utility). **Summary:** Dedicated billing client providing usage/invoice CRUD, PDF download with in-memory ETag cache, admin reconciliation post, and feature-flag probe. **Dependencies:** `apiClient`, `handleApiError`, browser `URL` APIs. **Risks/TODOs:** PDF cache never clears on logout or TTL expiry which can leak blobs; assumes `window.URL` exists so running inside Node tests requires mocks; `getFeatureFlags` swallows network errors and silently reports disabled, hiding backend regressions. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/lib/transparency.ts` — **Type:** Source (utility). **Summary:** Wraps transparency endpoints to list auctions with filters, fetch a single auction, verify signatures, and list active keys. **Dependencies:** `apiClient`. **Risks/TODOs:** No error handling/logging—callers must catch; responses can be large (auction payload + canonical) yet there’s no streaming/cancellation. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/lib/csrf.ts` — **Type:** Source (utility). **Summary:** Reads CSRF cookie and fetches `/auth/csrf` to seed `XSRF-TOKEN`, defaulting env names. **Dependencies:** Browser `document`, fetch. **Risks/TODOs:** Fetches over HTTP default (`localhost`) unless env overrides; errors are swallowed so callers cannot differentiate network vs auth failures; server-side usage returns null silently. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/lib/rbac.ts` — **Type:** Source (utility). **Summary:** Minimal helpers for role checks/enforcement via `hasRole`/`assertRole`. **Dependencies:** None. **Risks/TODOs:** Defaults undefined role to `'publisher'`, meaning unauthenticated callers may pass publisher-only guards; thrown errors are generic strings (no HTTP status metadata). **Evidence:** Reviewed 2025‑11‑14.
- `console/src/lib/utils.ts` — **Type:** Source (utility). **Summary:** Collection of formatting helpers (classnames, currency/number/percentage/date helpers, KPI calculations, badge colors). **Dependencies:** `clsx`, Intl APIs. **Risks/TODOs:** Everything hardcodes `en-US` locale + USD and multiples percentages by 100, so calling code must pass decimals; formatting logic duplicated with `i18n` module leading to drift. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/lib/hooks.ts` — **Type:** Source (client hooks). **Summary:** Provides `useDebouncedValue`, `useQueryParams` (URL manipulator), and `useLoadingState` with minimum duration tracking. **Dependencies:** React hooks, Next navigation. **Risks/TODOs:** Exported `useQueryParams` name collides with the more advanced hook in `lib/hooks/useQueryState.ts`, causing import ambiguity; router pushes on every param update so rapid changes spam history; `useLoadingState` schedules `setTimeout` without cleanup when component unmounts during pending delay. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/lib/hooks/useQueryState.ts` — **Type:** Source (client hooks). **Summary:** URL-state toolkit exposing `useQueryState`, `useQueryParams(defaults)`, and `useAllQueryParams` to synchronize filters with search params via `router.replace`. **Dependencies:** Next App Router navigation hooks. **Risks/TODOs:** Duplicates `useQueryParams` naming with different signatures; hook always reads browser `URLSearchParams`, so importing in RSC or SSR contexts will throw; no memoization for returned `values` object, so any change forces re-renders even when param unchanged. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/lib/__tests__/hooks.test.ts` — **Type:** Test. **Summary:** RTL hook tests for `useDebouncedValue` and `useLoadingState`, covering timer handling and minimum-duration guards via fake timers. **Dependencies:** `@testing-library/react` hooks API, Jest timers. **Risks/TODOs:** Doesn’t exercise either `useQueryParams` variant, so URL-sync regressions go untested; relies on global fake timers per suite (must reset carefully). **Evidence:** Reviewed 2025‑11‑14.
- `console/src/lib/useSession.ts` — **Type:** Source (client hook). **Summary:** React Query wrapper calling `/auth/me` (no retries) and exposing logout mutation that POSTs `/auth/logout`. **Dependencies:** `@tanstack/react-query`, `apiClient`. **Risks/TODOs:** Query keys aren’t namespaced per tenant/session so cross-tab invalidations collide; errors bubble as exceptions rather than redirecting to login; logout mutation doesn’t invalidate the session query automatically. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/lib/useFeatures.ts` — **Type:** Source (client hook). **Summary:** Client-side feature flag fetcher hitting `/api/v1/meta/features`, seeding fallback flags, and tracking loading/error state. **Dependencies:** `fetch`. **Risks/TODOs:** Hard-coded path ignores `NEXT_PUBLIC_API_URL`, so self-hosted environments with different prefixes will fail; lacks abort/cancellation leading to state updates on unmounted components; errors suppressed aside from console-level state. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/lib/useAdminGate.ts` — **Type:** Source (client hook). **Summary:** Protects admin routes by checking `useSession` and redirecting unauthenticated users to `/login` or non-admins to `/403`. **Dependencies:** Next router/pathname hooks, `useSession`. **Risks/TODOs:** Effect runs on every render and calls `router.replace`, which can thrash history when user hovers between allowed/blocked pages; there’s no SSR guard so admin routes briefly render before redirect. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/lib/__tests__/billing.test.ts` — **Type:** Test. **Summary:** Jest suite mocking `apiClient` to cover billing client methods (usage, invoices, PDF download, reconciliation, feature flag fallback) including error cases. **Dependencies:** Jest, `axios` types. **Risks/TODOs:** Uses manual object URLs but never restores originals, risking leaks into other suites; doesn’t exercise caching eviction or concurrent downloads. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/lib/__tests__/billing.pdf.msw.test.ts` — **Type:** Test. **Summary:** Validates `downloadInvoicePDF`’s ETag cache by simulating 200 + 304 responses and asserting re-use of blob URLs. **Dependencies:** Jest mocks for `apiClient`, browser `URL` APIs. **Risks/TODOs:** File name suggests MSW but no service worker configured; only covers happy-path caching (no error/etag miss). **Evidence:** Reviewed 2025‑11‑14.
- `console/src/i18n/index.ts` — **Type:** Source (utility). **Summary:** Lightweight localization helper exposing `t`, `formatNumber`, `formatCurrency`, `formatDate`, and unit helpers built on Intl APIs with singleton export initialized to English messages. **Dependencies:** `./messages/en.json`, Intl APIs. **Risks/TODOs:** Only `en` locale available; translation lookup silently returns key on miss; currency formatter divides cents by 100 assuming all values are minor units, so passing major units will half results. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/i18n/messages/en.json` — **Type:** Asset (JSON). **Summary:** Centralized English copy for migration studio, billing, adapters, navigation, guardrails, fraud guidance, etc. **Dependencies:** Consumed by `i18n/index.ts`. **Risks/TODOs:** Single-language file with no namespace separation, making conflicts likely; values include long Markdown-ish strings that aren’t validated at runtime; additions require manual rebuild to bake into bundle. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/llm/budget.ts` — **Type:** Source (utility). **Summary:** Stub “budget tracker” maintaining in-memory cumulative tokens/costs per provider with helpers to record usage, reset budgets, and check remaining allowance before LLM calls. **Dependencies:** None beyond standard library. **Risks/TODOs:** State isn’t persisted or scoped per user/session so data resets on reload and can mix tenants; no synchronization guards making concurrent updates race; cost math hard-codes $ per 1K tokens which may drift. **Evidence:** Reviewed 2025‑11‑14.
- `console/src/llm/providers.ts` — **Type:** Source (utility). **Summary:** Experimental LLM provider registry defining provider metadata (costs, capabilities), a fake execution interface, and a `selectProvider` helper that picks cheapest eligible provider given use case + budget. **Dependencies:** None (pure TS). **Risks/TODOs:** Providers are placeholders with stubbed `generate` implementations returning canned strings—no real API integration; selection algorithm ignores concurrency, rate limits, or latency; module unused elsewhere, so bundle may include dead code. **Evidence:** Reviewed 2025‑11‑14.
- Need add entries for `console/src/lib/admin.ts` already included.

### data/ & ML Data/
> _Pending detailed review._

### docs/
> _Pending detailed review._

### infrastructure/, monitoring/, logs/
> _Pending detailed review._

### ML/
> _Pending detailed review._

### models/
> _Pending detailed review._

### packages/ & Packages/
> _Pending detailed review._

### quality/
> _Pending detailed review._

### scripts/
> _Pending detailed review._

### sdk/ & sdks/
> _Pending detailed review._

### services/
> _Pending detailed review._

### website/
> _Pending detailed review._

### Remaining folders / verification
> _Pending detailed review._
