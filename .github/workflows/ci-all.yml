name: ci-all

on:
  pull_request:
    branches: [ main, master ]
  push:
    branches: [ main, master ]

jobs:
  shellcheck:
    name: Scripts — Shellcheck validation
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      
      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
          shellcheck --version
      
      - name: Lint all shell scripts
        run: |
          echo "Checking shell scripts for issues..."
          find scripts -name "*.sh" -type f -print0 | xargs -0 shellcheck --severity=warning
          echo "✅ All shell scripts passed shellcheck"

  openapi-contract:
    name: Backend — OpenAPI lint (Billing)
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.20.4'
      - name: Install Redocly CLI
        run: npm install -g @redocly/cli@latest
      - name: Lint OpenAPI spec (billing.yaml)
        run: redocly lint backend/src/openapi/billing.yaml

  backend:
    name: Backend — lint, test, migrations verify
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: apexmediation
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres -d apexmediation"
          --health-interval=10s --health-timeout=5s --health-retries=10
      clickhouse:
        image: clickhouse/clickhouse-server:23.9
        env:
          CLICKHOUSE_DB: apexmediation
          CLICKHOUSE_USER: default
          CLICKHOUSE_PASSWORD: ""
        ports:
          - 8123:8123
        options: >-
          --health-cmd="wget -qO- http://localhost:8123/ping || exit 1"
          --health-interval=10s --health-timeout=5s --health-retries=15
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js 18.x
        uses: actions/setup-node@v4
        with:
          node-version: '18.20.4'
      - name: Cache npm (deterministic with package-lock.json)
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
            backend/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-
      - name: Install root deps
        run: npm ci
      - name: Install backend deps
        working-directory: backend
        run: npm ci
      - name: Env schema check
        working-directory: backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/apexmediation
          CLICKHOUSE_URL: http://localhost:8123
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test-secret-key-123456
          NODE_ENV: test
        run: |
          npx ts-node -e "require('./src/config/env'); console.log('Env OK')"
      - name: Lint backend
        working-directory: backend
        run: npm run lint
      - name: Unit tests
        working-directory: backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/apexmediation_test
          TEST_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/apexmediation_test
          CLICKHOUSE_URL: http://localhost:8123
          SKIP_DB_SETUP: 'false'
          JWT_SECRET: test-access-secret
          JWT_REFRESH_SECRET: test-refresh-secret
        run: npm test --silent
      - name: Verify migrations (PG + ClickHouse)
        working-directory: backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/apexmediation
          CLICKHOUSE_URL: http://localhost:8123
          ALLOW_MIGRATION_DOWN: '1'
        run: node scripts/verifyMigrations.js

  console:
    name: Console — type-check, unit/a11y, e2e
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js 18.x
        uses: actions/setup-node@v4
        with:
          node-version: '18.20.4'
      - name: Cache npm (deterministic with package-lock.json)
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            console/node_modules
          key: ${{ runner.os }}-npm-console-${{ hashFiles('console/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-console-
      - name: Install console deps
        working-directory: console
        run: npm ci
      - name: Install Playwright browsers
        working-directory: console
        run: npx playwright install --with-deps chromium
      - name: Lint (ESLint with a11y rules)
        working-directory: console
        run: npm run lint
      - name: Type-check
        working-directory: console
        run: npm run type-check
      - name: Unit/a11y tests
        working-directory: console
        run: npm run test:a11y --silent
      - name: Build Next.js app
        working-directory: console
        run: npm run build
      - name: Check bundle sizes
        working-directory: console
        run: npm run bundle-size
      - name: Upload bundle size report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bundle-size-report
          path: console/bundle-size-report.json
          retention-days: 90
      - name: Start Next.js server in background
        working-directory: console
        run: |
          npm run start &
          sleep 10
          curl -f http://localhost:3000 || exit 1
      - name: Run Playwright e2e tests
        working-directory: console
        run: npm run e2e
      - name: Upload Playwright screenshots on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-screenshots
          path: console/test-results/
          retention-days: 30

  console-a11y-perf:
    name: Console — a11y and Lighthouse budgets
    runs-on: ubuntu-22.04
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js 18.x
        uses: actions/setup-node@v4
        with:
          node-version: '18.20.4'
      - name: Cache npm (console)
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            console/node_modules
          key: ${{ runner.os }}-npm-console-${{ hashFiles('console/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-console-
      - name: Install console deps
        working-directory: console
        run: npm ci
      - name: Build Next.js app
        working-directory: console
        run: npm run build
      - name: Start Next.js server in background
        working-directory: console
        run: |
          npm run start &
          sleep 10
          curl -f http://localhost:3000 || exit 1
      - name: Run jest-axe tests (a11y)
        working-directory: console
        run: npm run test:a11y --silent
      - name: Run Lighthouse with budgets
        working-directory: console
        run: npx @lhci/cli autorun --config=./lighthouse.config.cjs || true
      - name: Upload Lighthouse reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: console-lighthouse-reports
          path: console/.lighthouse/
          retention-days: 14

  billing-e2e-smoke:
    name: Billing — E2E smoke
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js 18.x
        uses: actions/setup-node@v4
        with:
          node-version: '18.20.4'
      - name: Cache npm (console)
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            console/node_modules
            quality/node_modules
          key: ${{ runner.os }}-npm-billing-e2e-${{ hashFiles('console/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-billing-e2e-
      - name: Install deps
        run: |
          npm ci
          cd console && npm ci && npx playwright install --with-deps chromium && cd ..
      - name: Build Console
        working-directory: console
        run: npm run build
      - name: Start Console
        working-directory: console
        run: |
          npm run start &
          sleep 10
          curl -f http://localhost:3000 || exit 1
      - name: Run billing E2E smoke
        working-directory: quality
        run: npx playwright test e2e/billing/usage-to-invoice.spec.ts --reporter=list || true
      - name: Upload E2E artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: billing-e2e-artifacts
          path: |
            console/test-results/
            console/playwright-report/
          retention-days: 14

  openapi-drift:
    name: Backend — OpenAPI drift guard (billing)
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.20.4'
      - name: Install openapi-diff
        run: npm install -g @redocly/openapi-core@latest openapi-diff@3
      - name: Compare current spec to baseline (if present)
        run: |
          if [ -f backend/src/openapi/.baselines/billing.yaml ]; then
            npx openapi-diff backend/src/openapi/.baselines/billing.yaml backend/src/openapi/billing.yaml || exit 1
          else
            echo "No OpenAPI baseline found. Skipping drift guard."
          fi
      - name: Upload Playwright videos on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-videos
          path: console/playwright-report/
          retention-days: 30

  website-a11y-perf:
    name: Website — a11y and Lighthouse budgets + token lint
    runs-on: ubuntu-22.04
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js 18.x
        uses: actions/setup-node@v4
        with:
          node-version: '18.20.4'
      - name: Cache npm (website)
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            website/node_modules
          key: ${{ runner.os }}-npm-website-${{ hashFiles('website/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-website-
      - name: Install website deps
        working-directory: website
        run: npm ci
      - name: Build Website
        working-directory: website
        run: npm run build
      - name: Start Website server in background
        working-directory: website
        run: |
          npm run start &
          sleep 10
          curl -f http://localhost:3000 || exit 1
      - name: Run Lighthouse with budgets (website)
        working-directory: .
        run: npx @lhci/cli autorun --config=quality/lighthouse/website.config.cjs || true
      - name: Upload Lighthouse reports (website)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: website-lighthouse-reports
          path: ./.lighthouse-website/
          retention-days: 14
      - name: Token lint — forbid hard-coded hex in website components
        run: node quality/lint/no-hardcoded-hex.js website/src

      - name: Generate bundle analyzer reports (client and server)
        run: |
          cd website
          ANALYZE=true npm run build || true
          cd ..
      - name: Upload bundle analyzer reports (website)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: website-bundle-analyzer
          path: website/analyze/**
          retention-days: 14

  website-visual-regression:
    name: Website — visual regression (light/dark across 3 widths)
    runs-on: ubuntu-22.04
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.20.4'
      - name: Cache npm (console)
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            quality/node_modules
          key: ${{ runner.os }}-npm-website-vr-${{ hashFiles('quality/package-lock.json', 'website/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-website-vr-
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
      - name: Install repo deps (root + quality)
        run: |
          npm ci
          cd quality && npm ci || true
      - name: Start Website
        working-directory: website
        run: |
          npm ci
          npm run build
          npm run start &
          sleep 10
          curl -f http://localhost:3000 || exit 1
      - name: Run visual regression for website (Playwright)
        working-directory: quality
        run: npx playwright test e2e/website/visual.spec.ts --reporter=list || true
      - name: Upload visual regression artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: website-visual-regression
          path: |
            quality/playwright-report/
          retention-days: 14

  android:
    name: Android SDK — unit tests and size gate
    runs-on: ubuntu-22.04
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
      - name: Cache Gradle (deterministic with lockfiles)
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/gradle.lockfile', '**/*.gradle*', '**/gradle-wrapper.properties', '**/gradle.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      - name: Run tests
        working-directory: sdk/core/android
        run: ./gradlew testDebugUnitTest --no-daemon
      - name: Assemble release (size gate)
        working-directory: sdk/core/android
        run: ./gradlew assembleRelease checkSdkSize validateSdkConfig --no-daemon
      
      - name: Generate Dokka HTML documentation
        working-directory: sdk/core/android
        run: ./gradlew dokkaHtml --no-daemon
      
      - name: Upload size report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-sdk-size-report
          path: sdk/core/android/build/reports/sdk-size/size-report.json
          retention-days: 90
      
      - name: Upload Dokka HTML docs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-sdk-api-docs
          path: sdk/core/android/build/dokka/html/
          retention-days: 30
      
      - name: Check API compatibility (binary-compatibility-validator)
        working-directory: sdk/core/android
        run: ./gradlew apiCheck --no-daemon

  ios:
    name: iOS SDK — build and test
    runs-on: macos-13
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - name: Cache Swift Package Manager (deterministic with Package.resolved)
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-
      - name: Build and test
        working-directory: sdk/core/ios
        run: |
          swift build
          swift test
      
      - name: Generate DocC documentation
        working-directory: sdk/core/ios
        run: |
          # Generate DocC archive
          swift package --allow-writing-to-directory ./docs \
            generate-documentation --target RivalApexMediationSDK \
            --output-path ./docs --emit-digest
          
          # Convert to static HTML for artifact
          xcrun docc process-archive transform-for-static-hosting \
            ./docs/RivalApexMediationSDK.doccarchive \
            --output-path ./docs/html \
            --hosting-base-path /ios-sdk || true
      
      - name: Upload DocC documentation
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-sdk-docc-docs
          path: sdk/core/ios/docs/
          retention-days: 30
      - name: Check API compatibility (swift-api-digester)
        working-directory: sdk/core/ios
        run: |
          set -euo pipefail
          # Ensure build
          swift build -c release
          MOD="RivalApexMediationSDK"
          BASELINE_DIR=".api-baseline"
          if [ -f "$BASELINE_DIR/${MOD}.public.json" ]; then
            sdk_path=$(xcrun --show-sdk-path --sdk iphoneos)
            xcrun swift-api-digester \
              -sdk "$sdk_path" \
              -diagnose-sdk \
              -module "$MOD" \
              -target arm64-apple-ios14.0 \
              -input-paths "$BASELINE_DIR/${MOD}.public.json" \
              -o api-diff.txt || true
            if grep -qi "breaking" api-diff.txt; then
              echo "Detected potential breaking API changes:" >&2
              cat api-diff.txt >&2
              exit 1
            else
              echo "No breaking API changes detected."
            fi
          else
            echo "No baseline found at $BASELINE_DIR/${MOD}.public.json — skipping digester check."
            echo "Run scripts/generate-api-baseline.sh to create and commit a baseline."
            echo "(This step will be enforced once baseline exists.)"
            echo "No baseline present" > api-diff.txt
          fi
      - name: Upload iOS API diff
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-api-diff
          path: sdk/core/ios/api-diff.txt
          retention-days: 14

  prom-rules-validate:
    name: Monitoring — Prometheus rules validation
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - name: Validate alerts.yml with promtool
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/monitoring:/mon \
            prom/prometheus:latest \
            promtool check rules /mon/alerts.yml
      - name: Validate recording rules (if present)
        run: |
          if [ -f monitoring/recording-rules.yml ]; then
            docker run --rm \
              -v ${{ github.workspace }}/monitoring:/mon \
              prom/prometheus:latest \
              promtool check rules /mon/recording-rules.yml; \
          else \
            echo "No recording-rules.yml found, skipping."; \
          fi

  website-security-headers:
    name: Website — security headers
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js 18.x
        uses: actions/setup-node@v4
        with:
          node-version: '18.20.4'
      - name: Cache npm (website)
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            website/node_modules
          key: ${{ runner.os }}-npm-website-${{ hashFiles('website/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-website-
      - name: Install dependencies (website)
        working-directory: website
        run: npm ci
      - name: Build website
        working-directory: website
        run: npm run build
      - name: Start website in background
        working-directory: website
        run: |
          npm run start &
          sleep 5
          curl -f http://localhost:3000 || (echo 'Website failed to start' && exit 1)
      - name: Run security headers test
        working-directory: website
        env:
          WEBSITE_BASE_URL: http://localhost:3000
        run: npm test -- src/__tests__/security.headers.test.ts --runInBand --silent

  ctv:
    name: CTV/OTT — Android TV + tvOS
    runs-on: ubuntu-22.04
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
      - name: Cache Gradle (deterministic with lockfiles)
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/gradle.lockfile', '**/*.gradle*', '**/gradle-wrapper.properties', '**/gradle.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      - name: Android TV — unit tests and size check
        working-directory: sdk/ctv/android-tv
        run: ./gradlew testDebugUnitTest assembleRelease checkCtvSdkSize --no-daemon

  tvos:
    name: CTV tvOS — build, test, and size check
    runs-on: macos-13
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - name: Cache Swift Package Manager (deterministic with Package.resolved)
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-
      - name: Xcode info
        run: xcodebuild -version
      - name: Swift build (debug)
        working-directory: sdk/ctv/tvos
        run: swift build -c debug
      - name: Swift test
        working-directory: sdk/ctv/tvos
        run: swift test -c debug
      
      - name: Swift build (release for size check)
        working-directory: sdk/ctv/tvos
        run: swift build -c release
      
      - name: Check tvOS SDK size
        working-directory: sdk/ctv/tvos
        run: |
          # Find the compiled framework binary
          FRAMEWORK_PATH=$(find .build/release -name "RivalApexMediationSDK" -type f | head -1)
          
          if [ -z "$FRAMEWORK_PATH" ]; then
            echo "ERROR: Framework binary not found"
            exit 1
          fi
          
          SIZE_BYTES=$(stat -f%z "$FRAMEWORK_PATH")
          SIZE_KB=$(echo "scale=2; $SIZE_BYTES / 1024" | bc)
          MAX_SIZE_BYTES=$((150 * 1024))  # 150 KB budget
          WARN_SIZE_BYTES=$((120 * 1024))  # 120 KB warning
          
          echo "=== tvOS SDK Size Report ==="
          echo "Framework: $FRAMEWORK_PATH"
          echo "Size: $SIZE_BYTES bytes ($SIZE_KB KB)"
          
          # Generate JSON report
          mkdir -p build/reports
          cat > build/reports/size-report.json <<EOF
          {
            "platform": "tvOS",
            "architecture": "arm64",
            "buildConfig": "release",
            "frameworkSizeBytes": $SIZE_BYTES,
            "frameworkSizeKB": $SIZE_KB,
            "maxSizeBytes": $MAX_SIZE_BYTES,
            "maxSizeKB": 150,
            "passed": $([ $SIZE_BYTES -le $MAX_SIZE_BYTES ] && echo "true" || echo "false"),
            "warning": $([ $SIZE_BYTES -gt $WARN_SIZE_BYTES ] && echo "true" || echo "false"),
            "percentOfBudget": $(echo "scale=2; ($SIZE_BYTES / $MAX_SIZE_BYTES) * 100" | bc),
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF
          
          cat build/reports/size-report.json
          
          if [ $SIZE_BYTES -gt $WARN_SIZE_BYTES ]; then
            echo "⚠️ WARNING: Framework size exceeds 120 KB warning threshold"
          fi
          
          if [ $SIZE_BYTES -gt $MAX_SIZE_BYTES ]; then
            echo "❌ ERROR: Framework size $SIZE_BYTES bytes exceeds 150 KB budget"
            exit 1
          fi
          
          echo "✅ Size gate passed: $SIZE_KB KB / 150 KB budget"
      
      - name: Upload tvOS size report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tvos-sdk-size-report
          path: sdk/ctv/tvos/build/reports/size-report.json
          retention-days: 90

  promtool-validate:
    name: Monitoring — Validate Prometheus rules
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Prometheus
        run: |
          wget https://github.com/prometheus/prometheus/releases/download/v2.53.0/prometheus-2.53.0.linux-amd64.tar.gz
          tar xzf prometheus-2.53.0.linux-amd64.tar.gz
          sudo mv prometheus-2.53.0.linux-amd64/promtool /usr/local/bin/
          promtool --version
      
      - name: Validate alert rules
        run: promtool check rules monitoring/alerts.yml
      
      - name: Validate recording rules
        run: promtool check rules monitoring/recording-rules.yml
      
      - name: Test alert rules
        run: |
          if [ -f monitoring/alerts.test.yml ]; then
            promtool test rules monitoring/alerts.test.yml
          else
            echo "No alert rule tests found (monitoring/alerts.test.yml)"
          fi

  security-trivy:
    name: Security — Trivy container scanning
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    strategy:
      matrix:
        image:
          - { name: backend, dockerfile: backend/Dockerfile, context: backend }
          - { name: console, dockerfile: console/Dockerfile, context: console }
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Docker image
        run: |
          docker build -t ${{ matrix.image.name }}:ci -f ${{ matrix.image.dockerfile }} ${{ matrix.image.context }}
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.image.name }}:ci
          format: 'sarif'
          output: 'trivy-results-${{ matrix.image.name }}.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'
      
      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results-${{ matrix.image.name }}.sarif'
          category: 'trivy-${{ matrix.image.name }}'
      
      - name: Run Trivy (CRITICAL blocker with SBOM)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.image.name }}:ci
          format: 'table'
          severity: 'CRITICAL'
          exit-code: '1'
          vuln-type: 'os,library'
      
      - name: Generate and upload SBOM
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.image.name }}:ci
          format: 'cyclonedx'
          output: 'sbom-${{ matrix.image.name }}.json'
      
      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sbom-${{ matrix.image.name }}
          path: sbom-${{ matrix.image.name }}.json
          retention-days: 90
