name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'
  POSTGRES_VERSION: '15'
  CLICKHOUSE_VERSION: '23.8'
  REDIS_VERSION: '7'

jobs:
  # Backend testing with real databases
  backend-test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: apexmediation_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      clickhouse:
        image: clickhouse/clickhouse-server:23.8
        ports:
          - 8123:8123
          - 9000:9000
        options: >-
          --health-cmd "clickhouse-client --query 'SELECT 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Lint backend
        run: npm run lint --workspace=backend

      - name: Run backend unit tests
        working-directory: backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/apexmediation_test
          CLICKHOUSE_URL: http://localhost:8123
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test-secret-key
          NODE_ENV: test
        run: npm test -- --coverage

      - name: Upload backend coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./backend/coverage/coverage-final.json
          flags: backend
          name: backend-coverage

      - name: Build backend
        run: npm run build --workspace=backend

  # Console testing and build
  console-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint console
        run: npm run lint --workspace=console

      - name: Type check console
        run: npm run type-check --workspace=console

      - name: Run console unit tests
        env:
          NEXT_PUBLIC_TRANSPARENCY_ENABLED: 'true'
        run: npm run test --workspace=console -- --runInBand

      - name: Build console
        run: npm run build --workspace=console
        env:
          NEXT_PUBLIC_USE_MOCK_API: false
          NEXT_PUBLIC_API_URL: http://localhost:4000/api/v1

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: console-build
          path: console/.next
          retention-days: 7

  # SDK tests (Android)
  sdk-android-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v2

      - name: Cache Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Run Android unit tests (Robolectric)
        working-directory: sdk/core/android
        run: |
          chmod +x ./gradlew
          ./gradlew --no-daemon testDebugUnitTest

      - name: Run StrictMode smoke gate
        working-directory: sdk/core/android
        run: |
          chmod +x ./gradlew
          ./gradlew --no-daemon strictmodeSmoke

      - name: Generate API docs (Dokka)
        working-directory: sdk/core/android
        run: |
          chmod +x ./gradlew
          ./gradlew --no-daemon generateApiDocs

      - name: Upload Dokka artifacts
        uses: actions/upload-artifact@v3
        with:
          name: android-sdk-api-docs
          path: sdk/core/android/build/dokka/html
          retention-days: 30

  # ML pipeline tests
  ml-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install ML dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r ML/requirements.txt
          pip install -e ML

      - name: Run ML unit tests
        run: pytest ML/scripts/tests

  # SDK tests (iOS) - Section 3.4
  sdk-ios-test:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.0'

      - name: Build iOS SDK
        working-directory: sdk/core/ios
        run: swift build

      - name: Run iOS unit tests
        working-directory: sdk/core/ios
        run: |
          swift test --enable-code-coverage --parallel

      - name: Generate code coverage report
        working-directory: sdk/core/ios
        run: |
          xcrun llvm-cov export -format="lcov" \
            .build/debug/RivalApexMediationSDKPackageTests.xctest/Contents/MacOS/RivalApexMediationSDKPackageTests \
            -instr-profile .build/debug/codecov/default.profdata > coverage.lcov

      - name: Upload iOS coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./sdk/core/ios/coverage.lcov
          flags: ios-sdk
          name: ios-sdk-coverage

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ios-test-results
          path: sdk/core/ios/.build/debug/*.xctest
          retention-days: 7

  # Integration tests
  integration-test:
    runs-on: ubuntu-latest
    needs: [backend-test, console-test]
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: apexmediation_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      clickhouse:
        image: clickhouse/clickhouse-server:23.8
        ports:
          - 8123:8123
        options: >-
          --health-cmd "clickhouse-client --query 'SELECT 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run database migrations
        working-directory: backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/apexmediation_test
        run: npm run migrate

      - name: Start backend server
        working-directory: backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/apexmediation_test
          CLICKHOUSE_URL: http://localhost:8123
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test-secret-key
          PORT: 4000
          NODE_ENV: test
        run: |
          npm run dev &
          echo $! > backend.pid
          echo "Waiting for backend /health..."
          for i in {1..30}; do
            if curl -sSf http://localhost:4000/health >/dev/null 2>&1; then echo "Backend is healthy"; break; fi; sleep 2; done

      - name: Run integration tests
        working-directory: backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/apexmediation_test
          CLICKHOUSE_URL: http://localhost:8123
          REDIS_URL: redis://localhost:6379
          API_URL: http://localhost:4000
        run: npm run test:integration

      - name: Stop backend server
        if: always()
        run: |
          if [ -f backend/backend.pid ]; then
            kill $(cat backend/backend.pid) || true
          fi

  # Security scanning
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run npm audit
        run: npm audit --audit-level=moderate

  # Code quality checks
  code-quality:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for SonarQube

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint with output
        run: npm run lint -- --format json --output-file eslint-report.json || true

      - name: Upload ESLint report
        uses: actions/upload-artifact@v3
        with:
          name: eslint-report
          path: eslint-report.json

  # Status check
  ci-success:
    runs-on: ubuntu-latest
    needs:
      - backend-test
      - console-test
      - sdk-android-test
      - sdk-ios-test
      - integration-test
      - security-scan
      - code-quality
      - ml-test
    if: ${{ always() }}
    steps:
      - name: Check all jobs status
        run: |
          if [[ "${{ needs.backend-test.result }}" == "success" ]] && \
             [[ "${{ needs.console-test.result }}" == "success" ]] && \
             [[ "${{ needs.sdk-android-test.result }}" == "success" ]] && \
             [[ "${{ needs.sdk-ios-test.result }}" == "success" ]] && \
             [[ "${{ needs.integration-test.result }}" == "success" ]] && \
             [[ "${{ needs.security-scan.result }}" == "success" ]] && \
             [[ "${{ needs.code-quality.result }}" == "success" ]] && \
             [[ "${{ needs.ml-test.result }}" == "success" ]]; then
            echo "All CI checks passed!"
            exit 0
          else
            echo "Some CI checks failed"
            echo "backend-test: ${{ needs.backend-test.result }}"
            echo "console-test: ${{ needs.console-test.result }}"
            echo "sdk-android-test: ${{ needs.sdk-android-test.result }}"
            echo "sdk-ios-test: ${{ needs.sdk-ios-test.result }}"
            echo "integration-test: ${{ needs.integration-test.result }}"
            echo "security-scan: ${{ needs.security-scan.result }}"
            echo "code-quality: ${{ needs.code-quality.result }}"
            echo "ml-test: ${{ needs.ml-test.result }}"
            exit 1
          fi



  # Go Auction adapter conformance
  auction-go-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend/auction
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true
      - name: Download dependencies
        run: go mod download
      - name: Run adapter conformance tests
        run: go test ./... -v
      - name: Upload test results (logs)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: auction-go-test-logs
          path: backend/auction
          retention-days: 7

  admin-api-smoke:
    runs-on: ubuntu-latest
    needs: [auction-go-test]
    defaults:
      run:
        working-directory: backend/auction
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true
      - name: Download dependencies
        run: go mod download
      - name: Run admin API contract tests
        env:
          ADMIN_API_BEARER: smoke-token
          ADMIN_IP_ALLOWLIST: 127.0.0.1/32
          ADMIN_RATELIMIT_WINDOW: 1s
          ADMIN_RATELIMIT_BURST: '3'
        run: go test ./internal/api -run TestAdminAPI_Contracts -v
      - name: Upload admin smoke logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: admin-api-smoke-logs
          path: backend/auction/internal/api
          retention-days: 7
