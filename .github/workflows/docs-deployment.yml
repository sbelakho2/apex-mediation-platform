name: Documentation Auto-Deployment

on:
  push:
    branches: [main]
    paths:
      - 'backend/**/*.ts'
      - 'sdks/**'
      - 'docs/**'
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., 1.0.0)'
        required: false

env:
  NODE_VERSION: '18'
  RUBY_VERSION: '3.2'

jobs:
  generate-backend-docs:
    name: Generate Backend API Docs (TypeDoc)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        working-directory: backend
        run: npm ci

      - name: Generate TypeDoc
        working-directory: backend
        run: |
          npx typedoc \
            --out docs \
            --entryPoints src/index.ts \
            --entryPointStrategy expand \
            --exclude "**/*+(test|spec).ts" \
            --readme README.md \
            --name "ApexMediation Backend API" \
            --includeVersion \
            --sort source-order \
            --theme default

      - name: Upload backend docs
        uses: actions/upload-artifact@v3
        with:
          name: backend-docs
          path: backend/docs/

  generate-ios-docs:
    name: Generate iOS SDK Docs (Jazzy)
    runs-on: macos-13
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}

      - name: Install Jazzy
        run: gem install jazzy

      - name: Generate Jazzy docs
        working-directory: sdks/ios
        run: |
          jazzy \
            --clean \
            --author "ApexMediation" \
            --author_url https://apexmediation.ee \
            --github_url https://github.com/apexmediation/platform \
            --module ApexMediation \
            --output docs \
            --theme fullwidth \
            --readme README.md

      - name: Upload iOS docs
        uses: actions/upload-artifact@v3
        with:
          name: ios-docs
          path: sdks/ios/docs/

  generate-android-docs:
    name: Generate Android SDK Docs (Dokka)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v3

      - name: Generate Dokka docs
        working-directory: sdks/android
        run: ./gradlew dokkaHtml

      - name: Upload Android docs
        uses: actions/upload-artifact@v3
        with:
          name: android-docs
          path: sdks/android/build/dokka/html/

  generate-unity-docs:
    name: Generate Unity SDK Docs (JSDoc)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install JSDoc
        run: npm install -g jsdoc

      - name: Generate JSDoc
        working-directory: sdks/unity
        run: |
          jsdoc \
            -c jsdoc.json \
            -r Runtime/ \
            -d docs \
            -R README.md \
            --template node_modules/docdash

      - name: Upload Unity docs
        uses: actions/upload-artifact@v3
        with:
          name: unity-docs
          path: sdks/unity/docs/

  build-docs-site:
    name: Build Documentation Site
    runs-on: ubuntu-latest
    needs:
      - generate-backend-docs
      - generate-ios-docs
      - generate-android-docs
      - generate-unity-docs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download all docs
        uses: actions/download-artifact@v3

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.ref_type }}" = "tag" ]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION=${{ github.event.inputs.version }}
          else
            VERSION="latest"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Deploying docs for version: $VERSION"

      - name: Setup docs structure
        run: |
          VERSION=${{ steps.version.outputs.version }}
          
          mkdir -p dist/$VERSION/backend
          mkdir -p dist/$VERSION/ios
          mkdir -p dist/$VERSION/android
          mkdir -p dist/$VERSION/unity
          
          # Copy generated docs
          cp -r backend-docs/* dist/$VERSION/backend/
          cp -r ios-docs/* dist/$VERSION/ios/
          cp -r android-docs/* dist/$VERSION/android/
          cp -r unity-docs/* dist/$VERSION/unity/
          
          # Copy guide docs
          cp -r docs/* dist/$VERSION/
          
          # Create latest symlink
          if [ "$VERSION" != "latest" ]; then
            ln -s $VERSION dist/latest
          fi

      - name: Generate version switcher
        run: |
          cat > dist/versions.json << EOF
          {
            "versions": [
              {"name": "${{ steps.version.outputs.version }}", "path": "/${{ steps.version.outputs.version }}"}
            ],
            "latest": "${{ steps.version.outputs.version }}"
          }
          EOF

      - name: Create index page
        run: |
          cat > dist/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ApexMediation Documentation</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
              }
              .container {
                background: white;
                border-radius: 16px;
                padding: 48px;
                max-width: 1200px;
                width: 100%;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
              }
              h1 {
                font-size: 48px;
                margin-bottom: 16px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
              }
              .subtitle {
                font-size: 20px;
                color: #666;
                margin-bottom: 48px;
              }
              .docs-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 24px;
                margin-top: 32px;
              }
              .doc-card {
                background: #f8f9fa;
                border-radius: 12px;
                padding: 24px;
                text-decoration: none;
                color: #333;
                transition: all 0.3s ease;
                border: 2px solid transparent;
              }
              .doc-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 8px 24px rgba(0,0,0,0.1);
                border-color: #667eea;
              }
              .doc-card h3 {
                font-size: 24px;
                margin-bottom: 8px;
                color: #667eea;
              }
              .doc-card p {
                color: #666;
                line-height: 1.6;
              }
              .version-selector {
                position: absolute;
                top: 20px;
                right: 20px;
                background: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
              }
              select {
                padding: 8px 12px;
                border-radius: 6px;
                border: 1px solid #ddd;
                font-size: 14px;
                cursor: pointer;
              }
            </style>
          </head>
          <body>
            <div class="version-selector">
              <label for="version">Version:</label>
              <select id="version" onchange="switchVersion(this.value)">
                <!-- Populated by JS -->
              </select>
            </div>
            
            <div class="container">
              <h1>ApexMediation Documentation</h1>
              <p class="subtitle">Unity-rival ad mediation platform with OTA-proof configs, transparent bidding, and reliable payments</p>
              
              <div class="docs-grid">
                <a href="./latest/ios/" class="doc-card">
                  <h3>üì± iOS SDK</h3>
                  <p>Native Swift SDK with CocoaPods integration</p>
                </a>
                
                <a href="./latest/android/" class="doc-card">
                  <h3>ü§ñ Android SDK</h3>
                  <p>Kotlin/Java SDK with Maven Central distribution</p>
                </a>
                
                <a href="./latest/unity/" class="doc-card">
                  <h3>üéÆ Unity SDK</h3>
                  <p>Cross-platform Unity plugin for mobile games</p>
                </a>
                
                <a href="./latest/backend/" class="doc-card">
                  <h3>‚öôÔ∏è Backend API</h3>
                  <p>REST API reference and integration guides</p>
                </a>
                
                <a href="https://github.com/apexmediation/platform" class="doc-card">
                  <h3>üíª GitHub</h3>
                  <p>View source code and contribute</p>
                </a>
                
                <a href="https://discord.gg/apexmediation" class="doc-card">
                  <h3>üí¨ Discord</h3>
                  <p>Get help from the community</p>
                </a>
              </div>
            </div>
            
            <script>
              // Load versions and populate selector
              fetch('./versions.json')
                .then(r => r.json())
                .then(data => {
                  const select = document.getElementById('version');
                  data.versions.forEach(v => {
                    const option = document.createElement('option');
                    option.value = v.path;
                    option.textContent = v.name;
                    if (v.name === data.latest) option.selected = true;
                    select.appendChild(option);
                  });
                });
              
              function switchVersion(path) {
                window.location.href = path;
              }
            </script>
          </body>
          </html>
          EOF

      - name: Upload docs site
        uses: actions/upload-artifact@v3
        with:
          name: docs-site
          path: dist/

  deploy-to-cloudflare-pages:
    name: Deploy to Cloudflare Pages
    runs-on: ubuntu-latest
    needs: build-docs-site
    if: github.ref == 'refs/heads/main' || github.ref_type == 'tag'
    steps:
      - name: Download docs site
        uses: actions/download-artifact@v3
        with:
          name: docs-site
          path: dist

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: apexmediation-docs
          directory: dist
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment deployment URL on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üìö Documentation preview deployed to Cloudflare Pages!\n\nView at: https://apexmediation-docs.pages.dev'
            })

  deploy-to-github-pages:
    name: Deploy to GitHub Pages (Fallback)
    runs-on: ubuntu-latest
    needs: build-docs-site
    if: github.ref == 'refs/heads/main' && !secrets.CLOUDFLARE_API_TOKEN
    steps:
      - name: Download docs site
        uses: actions/download-artifact@v3
        with:
          name: docs-site
          path: dist

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          cname: docs.apexmediation.ee

  update-search-index:
    name: Update Documentation Search Index
    runs-on: ubuntu-latest
    needs: [deploy-to-cloudflare-pages, deploy-to-github-pages]
    if: always() && (needs.deploy-to-cloudflare-pages.result == 'success' || needs.deploy-to-github-pages.result == 'success')
    steps:
      - name: Trigger Algolia crawler
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.ALGOLIA_API_KEY }}" \
            -d '{"siteUrl": "https://docs.apexmediation.ee"}' \
            https://crawler.algolia.com/api/1/crawlers/${{ secrets.ALGOLIA_CRAWLER_ID }}/reindex

      - name: Summary
        run: |
          echo "‚úÖ Documentation deployed successfully"
          echo "üìö View at: https://docs.apexmediation.ee"
          echo "üîç Search index updated"
