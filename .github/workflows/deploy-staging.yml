name: Deploy to Staging

on:
  push:
    branches:
      - develop
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (leave empty for latest)'
        required: false

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/rivalapexmediation
  ENVIRONMENT: staging
  AWS_REGION: us-east-1
  CLUSTER_NAME: rival-staging

jobs:
  # Pre-deployment checks
  pre-deploy-checks:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Check Docker images exist
        run: |
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:${{ github.sha }} || \
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:develop

  # Deploy backend to staging
  deploy-backend:
    runs-on: ubuntu-latest
    needs: pre-deploy-checks
    environment:
      name: staging
      url: https://api-staging.rivalapexmediation.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --name ${{ env.CLUSTER_NAME }} --region ${{ env.AWS_REGION }}

      - name: Create namespace if not exists
        run: |
          kubectl create namespace ${{ env.ENVIRONMENT }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy backend with Helm
        run: |
          helm upgrade --install rivalapexmediation-backend \
            ./infrastructure/helm/backend \
            --namespace ${{ env.ENVIRONMENT }} \
            --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend \
            --set image.tag=${{ github.sha }} \
            --set environment=${{ env.ENVIRONMENT }} \
            --set ingress.host=api-staging.rivalapexmediation.com \
            --set database.url=${{ secrets.STAGING_DATABASE_URL }} \
            --set clickhouse.url=${{ secrets.STAGING_CLICKHOUSE_URL }} \
            --set redis.url=${{ secrets.STAGING_REDIS_URL }} \
            --set jwt.secret=${{ secrets.STAGING_JWT_SECRET }} \
            --wait \
            --timeout 10m

      - name: Verify deployment
        run: |
          kubectl rollout status deployment/rivalapexmediation-backend -n ${{ env.ENVIRONMENT }}
          kubectl get pods -n ${{ env.ENVIRONMENT }} -l app=rivalapexmediation-backend

      - name: Run smoke tests
        run: |
          sleep 30  # Wait for service to be fully ready
          curl -f https://api-staging.rivalapexmediation.com/health || exit 1

  # Deploy console to staging
  deploy-console:
    runs-on: ubuntu-latest
    needs: deploy-backend
    environment:
      name: staging
      url: https://console-staging.rivalapexmediation.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --name ${{ env.CLUSTER_NAME }} --region ${{ env.AWS_REGION }}

      - name: Deploy console with Helm
        run: |
          helm upgrade --install rivalapexmediation-console \
            ./infrastructure/helm/console \
            --namespace ${{ env.ENVIRONMENT }} \
            --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-console \
            --set image.tag=${{ github.sha }} \
            --set environment=${{ env.ENVIRONMENT }} \
            --set ingress.host=console-staging.rivalapexmediation.com \
            --set api.url=https://api-staging.rivalapexmediation.com \
            --set nextauth.secret=${{ secrets.STAGING_NEXTAUTH_SECRET }} \
            --wait \
            --timeout 10m

      - name: Verify deployment
        run: |
          kubectl rollout status deployment/rivalapexmediation-console -n ${{ env.ENVIRONMENT }}
          kubectl get pods -n ${{ env.ENVIRONMENT }} -l app=rivalapexmediation-console

      - name: Run smoke tests
        run: |
          sleep 30
          curl -f https://console-staging.rivalapexmediation.com || exit 1

  # Run post-deployment tests
  post-deploy-tests:
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-console]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Run E2E tests against staging
        env:
          API_URL: https://api-staging.rivalapexmediation.com
          CONSOLE_URL: https://console-staging.rivalapexmediation.com
          TEST_USER_EMAIL: ${{ secrets.STAGING_TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.STAGING_TEST_USER_PASSWORD }}
        run: |
          # E2E tests would run here
          echo "E2E tests against staging environment"
          # npm run test:e2e

      - name: Run API health checks
        run: |
          # Check all critical endpoints
          curl -f https://api-staging.rivalapexmediation.com/health
          curl -f https://api-staging.rivalapexmediation.com/api/v1/health

  # Database migrations
  run-migrations:
    runs-on: ubuntu-latest
    needs: pre-deploy-checks
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: backend
        run: npm ci

      - name: Run migrations
        working-directory: backend
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
        run: npm run migrate

  # Rollback capability
  rollback:
    runs-on: ubuntu-latest
    if: failure()
    needs: [deploy-backend, deploy-console, post-deploy-tests]
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --name ${{ env.CLUSTER_NAME }} --region ${{ env.AWS_REGION }}

      - name: Rollback backend
        run: |
          helm rollback rivalapexmediation-backend -n ${{ env.ENVIRONMENT }}

      - name: Rollback console
        run: |
          helm rollback rivalapexmediation-console -n ${{ env.ENVIRONMENT }}

  # Notify team
  notify:
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-console, post-deploy-tests]
    if: always()
    
    steps:
      - name: Determine status
        id: status
        run: |
          if [[ "${{ needs.deploy-backend.result }}" == "success" ]] && \
             [[ "${{ needs.deploy-console.result }}" == "success" ]] && \
             [[ "${{ needs.post-deploy-tests.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=Staging deployment successful" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=Staging deployment failed" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification
        if: always()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "Staging Deployment",
              "attachments": [{
                "color": "${{ steps.status.outputs.color }}",
                "fields": [
                  {
                    "title": "Status",
                    "value": "${{ steps.status.outputs.message }}",
                    "short": true
                  },
                  {
                    "title": "Environment",
                    "value": "Staging",
                    "short": true
                  },
                  {
                    "title": "Commit",
                    "value": "${{ github.sha }}",
                    "short": true
                  },
                  {
                    "title": "Author",
                    "value": "${{ github.actor }}",
                    "short": true
                  }
                ]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      
      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/router -n staging --timeout=5m
          kubectl rollout status deployment/analytics -n staging --timeout=5m
          kubectl rollout status deployment/config -n staging --timeout=5m
          kubectl rollout status deployment/fraud -n staging --timeout=5m
          kubectl rollout status deployment/payments -n staging --timeout=5m
          kubectl rollout status deployment/reporting -n staging --timeout=5m
      
      - name: Run smoke tests
        run: |
          curl -f https://staging-api.rivalapexmediation.com/health || exit 1
          npm run test:smoke -- --env=staging
      
      - name: Notify Slack
        if: always()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "Staging deployment ${{ job.status }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Staging Deployment*\nStatus: ${{ job.status }}\nCommit: ${{ github.sha }}\nAuthor: ${{ github.actor }}"
                  }
                }
              ]
            }
