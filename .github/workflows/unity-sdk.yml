name: Unity SDK CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'Packages/com.rivalapexmediation.sdk/**'
      - '.github/workflows/unity-sdk.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'Packages/com.rivalapexmediation.sdk/**'
      - '.github/workflows/unity-sdk.yml'

jobs:
  unity-gate:
    name: Unity Footprint Gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Enforce runtime size + .NET tests
        run: |
          cd sdk/core/unity
          ./scripts/check_package_constraints.sh

  test:
    name: Test Unity SDK (${{ matrix.unityVersion }})
    needs: unity-gate
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        unityVersion:
          - 2020.3.48f1
          - 2021.3.31f1
          - 2022.3.12f1
          - 2023.3.0f1
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          lfs: true
      
      - name: Cache Unity Library
        uses: actions/cache@v3
        with:
          path: Library
          key: Library-${{ matrix.unityVersion }}-${{ hashFiles('Packages/**') }}
          restore-keys: |
            Library-${{ matrix.unityVersion }}-
            Library-
      
      - name: Run Edit Mode Tests
        uses: game-ci/unity-test-runner@v2
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          unityVersion: ${{ matrix.unityVersion }}
          testMode: EditMode
          artifactsPath: test-results-editmode
          githubToken: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Run Play Mode Tests
        uses: game-ci/unity-test-runner@v2
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          unityVersion: ${{ matrix.unityVersion }}
          testMode: PlayMode
          artifactsPath: test-results-playmode
          githubToken: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.unityVersion }}
          path: |
            test-results-editmode
            test-results-playmode
  
  build:
    name: Build Unity SDK (${{ matrix.targetPlatform }})
    runs-on: ubuntu-latest
    needs: test
    strategy:
      fail-fast: false
      matrix:
        targetPlatform:
          - StandaloneLinux64
          - iOS
          - Android
          - WebGL
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
      
      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-build-${{ matrix.targetPlatform }}-${{ hashFiles('Packages/**') }}
          restore-keys: |
            Library-build-${{ matrix.targetPlatform }}-
            Library-build-
      
      - name: Build Unity Project
        uses: game-ci/unity-builder@v2
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          targetPlatform: ${{ matrix.targetPlatform }}
          buildName: ApexMediationSDK
          buildsPath: builds
      
      - name: Check Build Size (iOS/Android)
        if: matrix.targetPlatform == 'iOS' || matrix.targetPlatform == 'Android'
        run: |
          echo "Checking build size..."
          # Find the SDK DLL and check size
          find builds -name "*.dll" -o -name "*.so" | while read file; do
            size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file")
            size_kb=$((size / 1024))
            echo "$file: ${size_kb}KB"
            if [ $size_kb -gt 300 ]; then
              echo "ERROR: File exceeds 300KB budget"
              exit 1
            fi
          done
      
      - name: Upload Build
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.targetPlatform }}
          path: builds

      - name: Validate WebGL headless build
        if: matrix.targetPlatform == 'WebGL'
        run: |
          echo "Validating WebGL headless build contents..."
          BUILD_NAME="${BUILD_NAME:-ApexMediationSDK}"
          # Common output paths for WebGL builds created by game-ci/unity-builder
          WEBGL_DIR=""
          if [ -d "builds/WebGL/${BUILD_NAME}" ]; then
            WEBGL_DIR="builds/WebGL/${BUILD_NAME}"
          elif [ -d "builds/WebGL" ]; then
            WEBGL_DIR="builds/WebGL"
          fi
          if [ -z "$WEBGL_DIR" ]; then
            echo "::error::WebGL build directory not found under builds/"
            ls -la builds || true
            exit 1
          fi
          echo "Using WebGL directory: $WEBGL_DIR"
          ls -la "$WEBGL_DIR"
          if [ ! -f "$WEBGL_DIR/index.html" ]; then
            echo "::error::index.html not found in WebGL build output ($WEBGL_DIR)"
            exit 1
          fi
          if ! ls "$WEBGL_DIR" | grep -E '\.(data|wasm)'; then
            echo "::error::Expected .data/.wasm payloads not found in WebGL build output"
            exit 1
          fi
          echo "WebGL headless build validation passed."
  
  package:
    name: Package Unity SDK
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Create Package
        run: |
          cd Packages/com.rivalapexmediation.sdk
          tar -czf ../../apex-mediation-sdk-${{ github.sha }}.tgz \
            --exclude='*.meta' \
            --exclude='.git*' \
            .
      
      - name: Upload Package Artifact
        uses: actions/upload-artifact@v4
        with:
          name: unity-package
          path: apex-mediation-sdk-*.tgz
      
      - name: Validate Package
        run: |
          echo "Validating package structure..."
          tar -tzf apex-mediation-sdk-*.tgz | grep -E "(package.json|Runtime/|Editor/|Tests/)"
          echo "Package validation successful"
  
  documentation:
    name: Build Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Generate API Documentation
        run: |
          # Placeholder for DocFX or similar tool
          echo "Documentation generation would run here"
      
      - name: Upload Documentation
        uses: actions/upload-artifact@v4
        with:
          name: api-documentation
          path: Documentation~/*.md
