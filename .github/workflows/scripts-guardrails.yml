name: scripts-guardrails

on:
  pull_request:
  push:
    branches: [ main, master ]

jobs:
  shell-sanity:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck
      - name: Syntax check (bash -n)
        shell: bash
        run: |
          shopt -s nullglob || true
          files=(scripts/*.sh website/scripts/*.sh scripts/**/*.sh)
          for f in "${files[@]}"; do
            echo "bash -n $f"; bash -n "$f"; done
      - name: Shellcheck (warnings)
        run: |
          shopt -s nullglob || true
          shellcheck -S warning scripts/*.sh || true
          shellcheck -S warning website/scripts/*.sh || true
          # best-effort for nested dirs
          find scripts -type f -name "*.sh" -print0 | xargs -0 -I{} shellcheck -S warning {} || true

  script-dry-runs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Prepare Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Dry-run representative scripts
        env:
          WEBSITE_BASE_URL: http://localhost:3000
          PORT: 3000
        run: |
          chmod +x scripts/*.sh || true
          ./scripts/capture-website.sh --dry-run
          ./scripts/verify-console-connection.sh --dry-run || true
          ./scripts/run-billing-migrations.sh --plan || true
          ./scripts/setup-s3-accounting.sh --dry-run || true

  optional-staging-smoke:
    if: ${{ secrets.API_TOKEN != '' && vars.API_BASE_URL != '' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Verify billing wiring (staging)
        env:
          API_BASE_URL: ${{ vars.API_BASE_URL }}
          API_TOKEN: ${{ secrets.API_TOKEN }}
        run: |
          ./scripts/verify-billing-wiring.sh || true
