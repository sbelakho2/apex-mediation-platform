name: Backward Compatibility Testing

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'backend/**'
      - 'sdks/**'
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - 'sdks/**'

env:
  NODE_VERSION: '18'
  JAVA_VERSION: '17'

jobs:
  detect-api-changes:
    name: Detect API Changes
    runs-on: ubuntu-latest
    outputs:
      has_breaking_changes: ${{ steps.analyze.outputs.has_breaking_changes }}
      changes_summary: ${{ steps.analyze.outputs.changes_summary }}
    steps:
      - name: Checkout current branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install API diff tools
        run: |
          npm install -g @microsoft/api-extractor
          npm install -g openapi-diff

      - name: Extract current API surface
        working-directory: backend
        run: |
          npm ci
          npm run build
          npx @microsoft/api-extractor run --local
          cp api-report.md current-api.md

      - name: Extract previous API surface
        run: |
          # Get previous version
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            echo "No previous tag found, skipping comparison"
            echo "has_breaking_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Checkout previous version
          git checkout $PREV_TAG
          cd backend
          npm ci
          npm run build
          npx @microsoft/api-extractor run --local
          cp api-report.md ../previous-api.md
          
          # Return to current branch
          git checkout -

      - name: Compare API surfaces
        id: analyze
        run: |
          if [ ! -f previous-api.md ]; then
            echo "No previous API to compare"
            echo "has_breaking_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Compare APIs
          diff -u previous-api.md backend/current-api.md > api-diff.txt || true
          
          # Analyze breaking changes
          BREAKING_CHANGES=$(cat api-diff.txt | grep -E "^-\s+(export|public|interface|class|function)" || true)
          
          if [ -n "$BREAKING_CHANGES" ]; then
            echo "has_breaking_changes=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Breaking changes detected!"
          else
            echo "has_breaking_changes=false" >> $GITHUB_OUTPUT
            echo "âœ… No breaking changes"
          fi
          
          # Create summary
          SUMMARY=$(cat api-diff.txt | head -50)
          echo "changes_summary<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload API diff
        uses: actions/upload-artifact@v3
        with:
          name: api-diff
          path: |
            api-diff.txt
            backend/current-api.md
            previous-api.md

      - name: Comment on PR
        if: github.event_name == 'pull_request' && steps.analyze.outputs.has_breaking_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## âš ï¸ Breaking API Changes Detected\n\nThis PR introduces breaking changes to the public API. Please:\n\n1. Review the API diff artifact\n2. Update the version (major bump)\n3. Create a migration guide\n4. Document breaking changes in commit message\n\n```\n${{ steps.analyze.outputs.changes_summary }}\n```'
            })

  matrix-compatibility-test:
    name: Matrix Compatibility Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        sdk_version: ['1.0.0', '1.1.0', '2.0.0']
        backend_version: ['1.0.0', '1.1.0', '2.0.0']
      fail-fast: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Start backend (version ${{ matrix.backend_version }})
        run: |
          git checkout v${{ matrix.backend_version }} -- backend/ || echo "Backend version not found"
          cd backend
          npm ci
          npm run build
          npm start &
          
          # Wait for backend to start
          for i in {1..30}; do
            if curl -f http://localhost:3000/health 2>/dev/null; then
              echo "âœ… Backend started"
              break
            fi
            echo "Waiting for backend..."
            sleep 2
          done

      - name: Run SDK compatibility tests (SDK ${{ matrix.sdk_version }})
        run: |
          git checkout v${{ matrix.sdk_version }} -- sdks/ || echo "SDK version not found"
          
          # Run integration tests
          cd sdks/integration-tests
          npm ci
          npm test -- --backend=http://localhost:3000
          
          echo "âœ… SDK v${{ matrix.sdk_version }} compatible with Backend v${{ matrix.backend_version }}"

      - name: Report compatibility
        if: always()
        run: |
          STATUS=${{ job.status }}
          echo "SDK v${{ matrix.sdk_version }} + Backend v${{ matrix.backend_version }}: $STATUS" >> compatibility-matrix.txt

      - name: Upload compatibility results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: compatibility-matrix
          path: compatibility-matrix.txt

  integration-test-previous-sdk:
    name: Test with Previous SDK Version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Get previous SDK version
        id: prev_version
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "none")
          echo "version=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "Previous SDK version: $PREV_TAG"

      - name: Start current backend
        run: |
          cd backend
          npm ci
          npm run build
          npm start &
          
          # Wait for backend
          for i in {1..30}; do
            if curl -f http://localhost:3000/health 2>/dev/null; then
              echo "âœ… Backend started"
              break
            fi
            sleep 2
          done

      - name: Test previous SDK against current backend
        if: steps.prev_version.outputs.version != 'none'
        run: |
          # Checkout previous SDK
          git checkout ${{ steps.prev_version.outputs.version }} -- sdks/
          
          # Run integration tests
          cd sdks/integration-tests
          npm ci
          npm test -- --backend=http://localhost:3000
          
          echo "âœ… Previous SDK (${{ steps.prev_version.outputs.version }}) works with current backend"

      - name: Report result
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Backward compatibility maintained"
          else
            echo "âŒ Backward compatibility broken!"
            echo "This is a BREAKING CHANGE - bump major version"
          fi

  deprecation-check:
    name: Check for Deprecated API Usage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Scan for deprecated APIs
        run: |
          # Search for @deprecated annotations
          echo "ðŸ“ Scanning for deprecated APIs..."
          
          DEPRECATED=$(grep -r "@deprecated" backend/src --include="*.ts" || true)
          
          if [ -n "$DEPRECATED" ]; then
            echo "âš ï¸ Deprecated APIs found:"
            echo "$DEPRECATED"
            
            # Check if deprecation notice is in CHANGELOG
            if ! grep -q "deprecated" CHANGELOG.md 2>/dev/null; then
              echo "âŒ Deprecated APIs not documented in CHANGELOG.md"
              exit 1
            fi
          else
            echo "âœ… No deprecated APIs"
          fi

      - name: Validate deprecation timeline
        run: |
          # Check that deprecated APIs have removal version
          MISSING_REMOVAL=$(grep -A 3 "@deprecated" backend/src --include="*.ts" | grep -v "Will be removed in" || true)
          
          if [ -n "$MISSING_REMOVAL" ]; then
            echo "âŒ Some deprecated APIs missing removal version"
            echo "$MISSING_REMOVAL"
            exit 1
          fi
          
          echo "âœ… All deprecated APIs have removal timeline"

  sdk-contract-test:
    name: SDK Contract Testing
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Pact tools
        run: npm install -g @pact-foundation/pact

      - name: Run contract tests
        working-directory: sdks/integration-tests
        run: |
          npm ci
          npm run test:contract
          
          echo "âœ… Contract tests passed"

      - name: Publish contracts
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        working-directory: sdks/integration-tests
        env:
          PACT_BROKER_BASE_URL: ${{ secrets.PACT_BROKER_BASE_URL }}
          PACT_BROKER_TOKEN: ${{ secrets.PACT_BROKER_TOKEN }}
        run: |
          npm run pact:publish
          echo "âœ… Contracts published to broker"

  generate-compatibility-report:
    name: Generate Compatibility Report
    runs-on: ubuntu-latest
    needs: 
      - detect-api-changes
      - matrix-compatibility-test
      - integration-test-previous-sdk
      - deprecation-check
      - sdk-contract-test
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Generate report
        run: |
          cat > compatibility-report.md << EOF
          # Backward Compatibility Report
          
          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Branch:** ${{ github.ref }}
          **Commit:** ${{ github.sha }}
          
          ## API Changes
          
          Breaking Changes: ${{ needs.detect-api-changes.outputs.has_breaking_changes }}
          
          \`\`\`diff
          ${{ needs.detect-api-changes.outputs.changes_summary }}
          \`\`\`
          
          ## Compatibility Matrix
          
          EOF
          
          # Add matrix results
          if [ -f compatibility-matrix/compatibility-matrix.txt ]; then
            cat compatibility-matrix/compatibility-matrix.txt >> compatibility-report.md
          fi
          
          cat >> compatibility-report.md << EOF
          
          ## Test Results
          
          - API Changes: ${{ needs.detect-api-changes.result }}
          - Matrix Tests: ${{ needs.matrix-compatibility-test.result }}
          - Previous SDK Test: ${{ needs.integration-test-previous-sdk.result }}
          - Deprecation Check: ${{ needs.deprecation-check.result }}
          - Contract Tests: ${{ needs.sdk-contract-test.result }}
          
          EOF

      - name: Upload report
        uses: actions/upload-artifact@v3
        with:
          name: compatibility-report
          path: compatibility-report.md

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('compatibility-report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

  enforce-semver:
    name: Enforce Semantic Versioning
    runs-on: ubuntu-latest
    needs: detect-api-changes
    if: github.event_name == 'pull_request' && needs.detect-api-changes.outputs.has_breaking_changes == 'true'
    steps:
      - name: Check version bump
        run: |
          echo "âš ï¸ Breaking changes detected"
          echo "This PR MUST include a major version bump"
          echo ""
          echo "Action required:"
          echo "1. Update package.json version (major bump)"
          echo "2. Add BREAKING CHANGE to commit message"
          echo "3. Create migration guide in docs/migration/"
          echo ""
          echo "Example commit:"
          echo "feat!: redesign API authentication"
          echo ""
          echo "BREAKING CHANGE: Authentication now requires API keys instead of JWT tokens."
          exit 1
