name: nightly-quality

on:
  schedule:
    # Run every night at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  load-tests:
    name: Load Testing ‚Äî RTB, Tracking, Fraud
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        test:
          - { name: auction, file: auction-load-test.js, vus: 50, duration: 5m, p95_threshold: 120 }
          - { name: tracking, file: tracking-load-test.js, vus: 100, duration: 5m, p95_threshold: 50 }
          - { name: fraud, file: fraud-smoke-test.js, vus: 20, duration: 3m, p95_threshold: 200 }
    steps:
      - uses: actions/checkout@v4
      
      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6
      
      - name: Run ${{ matrix.test.name }} load test
        env:
          BASE_URL: ${{ secrets.STAGING_BASE_URL || 'https://apexmediation-backend.fly.dev' }}
          TOKEN: ${{ secrets.STAGING_API_TOKEN }}
          VUS: ${{ matrix.test.vus }}
          DURATION: ${{ matrix.test.duration }}
        run: |
          k6 run --out json=load-test-${{ matrix.test.name }}.json \
            quality/load-tests/${{ matrix.test.file }}
      
      - name: Parse results and check thresholds
        id: check_results
        run: |
          # Extract p95 latency from k6 JSON output
          P95=$(jq -r '.metrics.http_req_duration.values.p95' load-test-${{ matrix.test.name }}.json)
          THRESHOLD=${{ matrix.test.p95_threshold }}
          
          echo "p95_latency=$P95" >> $GITHUB_OUTPUT
          echo "threshold=$THRESHOLD" >> $GITHUB_OUTPUT
          
          echo "üìä ${{ matrix.test.name }} p95 latency: ${P95}ms (threshold: ${THRESHOLD}ms)"
          
          if (( $(echo "$P95 > $THRESHOLD" | bc -l) )); then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "‚ùå FAILED: p95 latency $P95ms exceeds threshold $THRESHOLD ms"
            exit 1
          else
            echo "status=passed" >> $GITHUB_OUTPUT
            echo "‚úÖ PASSED: p95 latency within threshold"
          fi
      
      - name: Upload load test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: load-test-results-${{ matrix.test.name }}
          path: load-test-${{ matrix.test.name }}.json
          retention-days: 90
      
      - name: Send Slack notification on failure
        if: failure()
        uses: slackapi/slack-github-action@v1.26.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          payload: |
            {
              "text": "üö® Nightly Load Test Failed",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üö® Nightly Load Test Failed: ${{ matrix.test.name }}"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Test:*\n${{ matrix.test.name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\n‚ùå FAILED"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*p95 Latency:*\n${{ steps.check_results.outputs.p95_latency }}ms"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Threshold:*\n${{ steps.check_results.outputs.threshold }}ms"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
                  }
                }
              ]
            }

  chaos-tests:
    name: Chaos Engineering ‚Äî Resilience Testing
    runs-on: ubuntu-22.04
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        scenario:
          - { name: pod-failure, command: "pod-failure", target: "backend", duration: 2m }
          - { name: network-latency, command: "network-latency", target: "backend", duration: 3m, latency: 500ms }
          - { name: cpu-stress, command: "cpu-stress", target: "analytics", duration: 2m, cpu: 80 }
          - { name: memory-stress, command: "memory-stress", target: "backend", duration: 2m, memory: 300Mi }
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.29.0'
      
      - name: Configure kubeconfig for staging
        env:
          KUBECONFIG_DATA: ${{ secrets.STAGING_KUBECONFIG }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_DATA" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
      
      - name: Install Chaos Mesh CLI
        run: |
          curl -sSL https://mirrors.chaos-mesh.org/latest/install.sh | bash -s -- --local
          sudo mv chaos-mesh /usr/local/bin/
      
      - name: Run chaos experiment - ${{ matrix.scenario.name }}
        id: chaos
        run: |
          cat <<EOF | kubectl apply -f -
          apiVersion: chaos-mesh.org/v1alpha1
          kind: PodChaos
          metadata:
            name: ${{ matrix.scenario.name }}-${{ github.run_id }}
            namespace: staging
          spec:
            action: ${{ matrix.scenario.command }}
            mode: one
            duration: ${{ matrix.scenario.duration }}
            selector:
              namespaces:
                - staging
              labelSelectors:
                app: ${{ matrix.scenario.target }}
          EOF
          
          # Wait for experiment to complete
          sleep $(echo "${{ matrix.scenario.duration }}" | sed 's/m/*60/' | bc)
          
          # Check pod status after chaos
          kubectl get pods -n staging -l app=${{ matrix.scenario.target }} -o json > chaos-results-${{ matrix.scenario.name }}.json
          
          # Verify pods recovered
          READY_PODS=$(kubectl get pods -n staging -l app=${{ matrix.scenario.target }} -o json | jq '[.items[] | select(.status.phase=="Running")] | length')
          echo "ready_pods=$READY_PODS" >> $GITHUB_OUTPUT
          
          if [ "$READY_PODS" -eq 0 ]; then
            echo "‚ùå FAILED: No pods recovered after chaos experiment"
            exit 1
          fi
          
          echo "‚úÖ PASSED: $READY_PODS pods recovered successfully"
      
      - name: Check application health after chaos
        run: |
          # Wait for pods to stabilize
          sleep 30
          
          # Check health endpoint
          HEALTH_URL="${{ secrets.STAGING_BASE_URL }}/health"
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL")
          
          if [ "$RESPONSE" != "200" ]; then
            echo "‚ùå FAILED: Health check returned $RESPONSE"
            exit 1
          fi
          
          echo "‚úÖ Health check passed: $RESPONSE"
      
      - name: Upload chaos test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: chaos-results-${{ matrix.scenario.name }}
          path: chaos-results-${{ matrix.scenario.name }}.json
          retention-days: 30
      
      - name: Cleanup chaos experiment
        if: always()
        run: |
          kubectl delete podchaos ${{ matrix.scenario.name }}-${{ github.run_id }} -n staging --ignore-not-found=true
      
      - name: Send Slack notification on failure
        if: failure()
        uses: slackapi/slack-github-action@v1.26.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          payload: |
            {
              "text": "üî• Nightly Chaos Test Failed",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üî• Nightly Chaos Test Failed: ${{ matrix.scenario.name }}"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Scenario:*\n${{ matrix.scenario.name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Target:*\n${{ matrix.scenario.target }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\n‚ùå FAILED"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Pods Recovered:*\n${{ steps.chaos.outputs.ready_pods || 'Unknown' }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
                  }
                }
              ]
            }

  summary:
    name: Send Nightly Test Summary
    runs-on: ubuntu-22.04
    needs: [load-tests, chaos-tests]
    if: always()
    steps:
      - name: Send summary notification
        uses: slackapi/slack-github-action@v1.26.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          payload: |
            {
              "text": "üìä Nightly Quality Tests Complete",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üìä Nightly Quality Tests ‚Äî ${{ github.run_id }}"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Load Tests:*\n${{ needs.load-tests.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Chaos Tests:*\n${{ needs.chaos-tests.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Full Report>"
                  }
                }
              ]
            }
