name: Deploy to Production

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to deploy (e.g., 1.0.0)"
        required: true
        type: string
      skip_approval:
        description: "Skip manual approval"
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/rivalapexmediation
  ENVIRONMENT: production
  AWS_REGION: us-east-1
  CLUSTER_NAME: rival-production

jobs:
  # Pre-production validation
  validate-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      staging_healthy: ${{ steps.health.outputs.healthy }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Validate staging environment
        id: health
        run: |
          # Ensure staging is healthy
          if curl -f https://api-staging.rivalapexmediation.ee/health; then
            echo "healthy=true" >> $GITHUB_OUTPUT
          else
            echo "healthy=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Verify Docker images exist
        run: |
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:v${{ steps.version.outputs.version }}
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-console:v${{ steps.version.outputs.version }}

      - name: Run security scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:v${{ steps.version.outputs.version }}
          severity: "CRITICAL,HIGH"
          exit-code: "1"

  # Manual approval gate
  approval:
    runs-on: ubuntu-latest
    needs: validate-release
    if: github.event.inputs.skip_approval != 'true'
    environment:
      name: production-approval

    steps:
      - name: Wait for approval
        run: echo "Deployment to production approved"

  # Blue-Green Deployment - Deploy to Green environment
  deploy-green:
    runs-on: ubuntu-latest
    needs: [validate-release, approval]
    if: always() && (needs.approval.result == 'success' || needs.approval.result == 'skipped')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          role-duration-seconds: 3600

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --name ${{ env.CLUSTER_NAME }} --region ${{ env.AWS_REGION }}

      - name: Deploy backend to green
        run: |
          helm upgrade --install rivalapexmediation-backend-green \
            ./infrastructure/helm/backend \
            --namespace ${{ env.ENVIRONMENT }} \
            --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend \
            --set image.tag=v${{ needs.validate-release.outputs.version }} \
            --set environment=${{ env.ENVIRONMENT }} \
            --set deployment.color=green \
            --set service.selector.color=green \
            --set database.url=${{ secrets.PROD_DATABASE_URL }} \
            --set redis.url=${{ secrets.PROD_REDIS_URL }} \
            --set jwt.secret=${{ secrets.PROD_JWT_SECRET }} \
            --set replicas=3 \
            --set autoscaling.enabled=true \
            --set autoscaling.minReplicas=3 \
            --set autoscaling.maxReplicas=20 \
            --wait \
            --timeout 15m

      - name: Deploy console to green
        run: |
          helm upgrade --install rivalapexmediation-console-green \
            ./infrastructure/helm/console \
            --namespace ${{ env.ENVIRONMENT }} \
            --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-console \
            --set image.tag=v${{ needs.validate-release.outputs.version }} \
            --set environment=${{ env.ENVIRONMENT }} \
            --set deployment.color=green \
            --set service.selector.color=green \
            --set api.url=https://api.rivalapexmediation.ee \
            --set nextauth.secret=${{ secrets.PROD_NEXTAUTH_SECRET }} \
            --set replicas=2 \
            --set autoscaling.enabled=true \
            --set autoscaling.minReplicas=2 \
            --set autoscaling.maxReplicas=10 \
            --wait \
            --timeout 15m

      - name: Verify green deployment
        run: |
          kubectl rollout status deployment/rivalapexmediation-backend-green -n ${{ env.ENVIRONMENT }}
          kubectl rollout status deployment/rivalapexmediation-console-green -n ${{ env.ENVIRONMENT }}

  # Canary testing on green environment
  canary-tests:
    runs-on: ubuntu-latest
    needs: deploy-green

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "18"

      - name: Install dependencies
        run: npm ci

      - name: Run smoke tests against green
        env:
          API_URL: https://api-green.rivalapexmediation.ee
          TEST_USER_EMAIL: ${{ secrets.PROD_TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.PROD_TEST_USER_PASSWORD }}
        run: |
          # Smoke tests
          curl -f $API_URL/health
          curl -f $API_URL/api/v1/health

          # API functionality tests
          # npm run test:smoke

      - name: Run load test on green (10% traffic)
        run: |
          # K6 load test with 10% of expected production traffic
          echo "Running canary load test"
          # k6 run --vus 10 --duration 5m quality/load-tests/canary-test.js

      - name: Monitor error rates
        run: |
          # Check CloudWatch or monitoring system
          echo "Monitoring green environment metrics"
          sleep 60
          # Query metrics and alert if error rate > 1%

  # Switch traffic to green (Blue-Green cutover)
  cutover:
    runs-on: ubuntu-latest
    needs: canary-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --name ${{ env.CLUSTER_NAME }} --region ${{ env.AWS_REGION }}

      - name: Switch traffic to green
        run: |
          # Update service selectors to point to green
          kubectl patch service rivalapexmediation-backend -n ${{ env.ENVIRONMENT }} \
            -p '{"spec":{"selector":{"color":"green"}}}'

          kubectl patch service rivalapexmediation-console -n ${{ env.ENVIRONMENT }} \
            -p '{"spec":{"selector":{"color":"green"}}}'

      - name: Wait and monitor
        run: |
          echo "Traffic switched to green. Monitoring for 5 minutes..."
          sleep 300

  # Post-deployment verification
  verify-production:
    runs-on: ubuntu-latest
    needs: cutover

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run production health checks
        run: |
          curl -f https://api.rivalapexmediation.ee/health
          curl -f https://console.rivalapexmediation.ee

      - name: Run E2E tests against production
        env:
          API_URL: https://api.rivalapexmediation.ee
          CONSOLE_URL: https://console.rivalapexmediation.ee
          TEST_USER_EMAIL: ${{ secrets.PROD_TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.PROD_TEST_USER_PASSWORD }}
        run: |
          # Critical path E2E tests
          echo "Running production E2E tests"
          # npm run test:e2e:critical

      - name: Monitor metrics for 10 minutes
        run: |
          echo "Monitoring production metrics..."
          sleep 600
          # Check error rates, latency, throughput

  # Cleanup old blue deployment
  cleanup-blue:
    runs-on: ubuntu-latest
    needs: verify-production

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --name ${{ env.CLUSTER_NAME }} --region ${{ env.AWS_REGION }}

      - name: Scale down blue deployment
        run: |
          kubectl scale deployment rivalapexmediation-backend-blue --replicas=0 -n ${{ env.ENVIRONMENT }} || true
          kubectl scale deployment rivalapexmediation-console-blue --replicas=0 -n ${{ env.ENVIRONMENT }} || true

      - name: Keep blue for 24h rollback window
        run: |
          echo "Blue deployment kept at 0 replicas for 24h rollback capability"

  # Create release notes
  create-release:
    runs-on: ubuntu-latest
    needs: verify-production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate release notes
        id: notes
        run: |
          # Generate changelog from commits
          PREVIOUS_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")
          if [ -n "$PREVIOUS_TAG" ]; then
            CHANGES=$(git log $PREVIOUS_TAG..HEAD --pretty=format:"- %s (%an)" --no-merges)
          else
            CHANGES=$(git log --pretty=format:"- %s (%an)" --no-merges | head -20)
          fi
          echo "changes<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.validate-release.outputs.version }}
          release_name: Release v${{ needs.validate-release.outputs.version }}
          body: |
            ## What's Changed

            ${{ steps.notes.outputs.changes }}

            ## Deployment Details
            - Environment: Production
            - Deployed: ${{ github.event.head_commit.timestamp }}
            - Commit: ${{ github.sha }}
            - Deployed by: ${{ github.actor }}

            ## Verification
            - API: https://api.rivalapexmediation.ee
            - Console: https://console.rivalapexmediation.ee
          draft: false
          prerelease: false

  # Notify team
  notify:
    runs-on: ubuntu-latest
    needs: [deploy-green, canary-tests, cutover, verify-production]
    if: always()

    steps:
      - name: Determine status
        id: status
        run: |
          if [[ "${{ needs.deploy-green.result }}" == "success" ]] && \
             [[ "${{ needs.canary-tests.result }}" == "success" ]] && \
             [[ "${{ needs.cutover.result }}" == "success" ]] && \
             [[ "${{ needs.verify-production.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=âœ… Production deployment successful" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=âŒ Production deployment failed" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "Production Deployment",
              "attachments": [{
                "color": "${{ steps.status.outputs.color }}",
                "fields": [
                  {
                    "title": "Status",
                    "value": "${{ steps.status.outputs.message }}",
                    "short": true
                  },
                  {
                    "title": "Version",
                    "value": "v${{ needs.validate-release.outputs.version }}",
                    "short": true
                  },
                  {
                    "title": "Commit",
                    "value": "${{ github.sha }}",
                    "short": true
                  },
                  {
                    "title": "Deployed by",
                    "value": "${{ github.actor }}",
                    "short": true
                  }
                ],
                "actions": [
                  {
                    "type": "button",
                    "text": "View API",
                    "url": "https://api.rivalapexmediation.ee"
                  },
                  {
                    "type": "button",
                    "text": "View Console",
                    "url": "https://console.rivalapexmediation.ee"
                  }
                ]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --name rival-production --region us-east-1

      - name: Deploy stage - ${{ matrix.stage.name }}
        run: |
          # Update deployment with traffic splitting
          kubectl set image deployment/router router=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-router:v${{ needs.validate-release.outputs.version }} -n production

          # Apply traffic split using Istio
          cat <<EOF | kubectl apply -f -
          apiVersion: networking.istio.io/v1beta1
          kind: VirtualService
          metadata:
            name: router-vs
            namespace: production
          spec:
            hosts:
            - router
            http:
            - match:
              - headers:
                  canary:
                    exact: "true"
              route:
              - destination:
                  host: router
                  subset: canary
                weight: ${{ matrix.stage.percentage }}
              - destination:
                  host: router
                  subset: stable
                weight: ${{ 100 - matrix.stage.percentage }}
          EOF

      - name: Monitor SLOs - ${{ matrix.stage.name }}
        if: ${{ matrix.stage.duration > 0 }}
        run: |
          START_TIME=$(date +%s)
          DURATION_SECONDS=$((  ${{ matrix.stage.duration }} * 60 ))

          while [ $(($(date +%s) - START_TIME)) -lt $DURATION_SECONDS ]; do
            # Check crash-free rate
            CRASH_RATE=$(curl -s https://api.rivalapexmediation.ee/metrics/crash_rate)
            if (( $(echo "$CRASH_RATE > 0.002" | bc -l) )); then
              echo "Crash rate exceeded threshold: $CRASH_RATE"
              exit 1
            fi

            # Check ANR rate
            ANR_RATE=$(curl -s https://api.rivalapexmediation.ee/metrics/anr_rate)
            if (( $(echo "$ANR_RATE > 0.0002" | bc -l) )); then
              echo "ANR rate exceeded threshold: $ANR_RATE"
              exit 1
            fi

            # Check P99 latency
            P99_LATENCY=$(curl -s https://api.rivalapexmediation.ee/metrics/p99_latency)
            if (( $(echo "$P99_LATENCY > 150" | bc -l) )); then
              echo "P99 latency exceeded threshold: $P99_LATENCY ms"
              exit 1
            fi

            # Check error rate
            ERROR_RATE=$(curl -s https://api.rivalapexmediation.ee/metrics/error_rate)
            if (( $(echo "$ERROR_RATE > 0.01" | bc -l) )); then
              echo "Error rate exceeded threshold: $ERROR_RATE"
              exit 1
            fi

            echo "Stage ${{ matrix.stage.name }}: All SLOs healthy"
            sleep 60
          done

      - name: Rollback on failure
        if: failure()
        run: |
          echo "SLO breach detected - rolling back"
          kubectl rollout undo deployment/router -n production
          kubectl rollout status deployment/router -n production --timeout=5m

          # Notify team
          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
            -H 'Content-Type: application/json' \
            -d '{"text":"ðŸš¨ Production rollback triggered at stage ${{ matrix.stage.name }}"}'

      - name: Complete stage
        run: |
          echo "Stage ${{ matrix.stage.name }} completed successfully"

  post-deployment:
    needs: staged-rollout
    runs-on: ubuntu-latest

    steps:
      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.validate-release.outputs.version }}
          release_name: Release v${{ needs.validate-release.outputs.version }}
          draft: false
          prerelease: false

      - name: Notify success
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "âœ… Production deployment v${{ needs.validate-release.outputs.version }} completed successfully",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Production Deployment Complete*\nVersion: v${{ needs.validate-release.outputs.version }}\nDashboard: https://console.rivalapexmediation.ee"
                  }
                }
              ]
            }
