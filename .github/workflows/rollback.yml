name: Emergency Rollback

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
          - staging
          - production
      reason:
        description: 'Reason for rollback'
        required: true
        type: string

jobs:
  rollback:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Update kubeconfig
        run: |
          CLUSTER_NAME="rival-${{ inputs.environment }}"
          aws eks update-kubeconfig --name $CLUSTER_NAME --region us-east-1
      
      - name: Execute rollback
        run: |
          NAMESPACE="${{ inputs.environment }}"
          
          echo "ðŸ”„ Rolling back all deployments in $NAMESPACE"
          
          for deployment in router analytics config fraud payments reporting; do
            echo "Rolling back $deployment..."
            kubectl rollout undo deployment/$deployment -n $NAMESPACE
            kubectl rollout status deployment/$deployment -n $NAMESPACE --timeout=5m
          done
      
      - name: Verify rollback
        run: |
          NAMESPACE="${{ inputs.environment }}"
          
          # Check all pods are running
          kubectl get pods -n $NAMESPACE
          
          # Verify health endpoints
          if [ "${{ inputs.environment }}" == "production" ]; then
            BASE_URL="https://api.rivalapexmediation.com"
          else
            BASE_URL="https://staging-api.rivalapexmediation.com"
          fi
          
          curl -f $BASE_URL/health || exit 1
          
          echo "âœ… Rollback verified - all services healthy"
      
      - name: Create incident record
        run: |
          cat > incident-${{ github.run_id }}.json <<EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "environment": "${{ inputs.environment }}",
            "reason": "${{ inputs.reason }}",
            "triggered_by": "${{ github.actor }}",
            "run_id": "${{ github.run_id }}"
          }
          EOF
          
          # Upload to S3 for incident tracking
          aws s3 cp incident-${{ github.run_id }}.json s3://rival-incidents/
      
      - name: Notify team
        if: always()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "âš ï¸ Emergency Rollback Executed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Emergency Rollback*\nEnvironment: ${{ inputs.environment }}\nReason: ${{ inputs.reason }}\nTriggered by: ${{ github.actor }}\nStatus: ${{ job.status }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run>"
                  }
                }
              ]
            }
      
      - name: Create PagerDuty incident
        if: inputs.environment == 'production'
        run: |
          curl -X POST https://api.pagerduty.com/incidents \
            -H 'Authorization: Token token=${{ secrets.PAGERDUTY_TOKEN }}' \
            -H 'Content-Type: application/json' \
            -H 'From: devops@rivalapexmediation.com' \
            -d '{
              "incident": {
                "type": "incident",
                "title": "Production Rollback: ${{ inputs.reason }}",
                "service": {
                  "id": "${{ secrets.PAGERDUTY_SERVICE_ID }}",
                  "type": "service_reference"
                },
                "urgency": "high",
                "body": {
                  "type": "incident_body",
                  "details": "Emergency rollback executed in production. Reason: ${{ inputs.reason }}"
                }
              }
            }'
