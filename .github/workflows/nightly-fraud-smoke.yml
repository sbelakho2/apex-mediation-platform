name: Nightly Fraud Inference Smoke Tests

on:
  schedule:
    # Run at 2 AM UTC daily
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    env:
      ENVIRONMENT: ${{ github.event.inputs.environment || 'staging' }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6
      
      - name: Set environment URL
        id: env_url
        run: |
          if [ "$ENVIRONMENT" = "staging" ]; then
            echo "base_url=https://fraud-staging.apexmediation.ee" >> $GITHUB_OUTPUT
          else
            echo "base_url=https://fraud.apexmediation.ee" >> $GITHUB_OUTPUT
          fi
      
      - name: Run k6 smoke test
        id: k6_test
        continue-on-error: true
        run: |
          k6 run \
            --out json=/tmp/k6-fraud-smoke-results.json \
            --env BASE_URL=${{ steps.env_url.outputs.base_url }} \
            quality/load-tests/fraud-smoke-test.js \
            | tee /tmp/k6-output.log
      
      - name: Parse test results
        id: parse_results
        run: |
          if [ -f /tmp/k6-fraud-smoke-results.json ]; then
            # Extract summary metrics
            p95=$(jq -r '.metrics.fraud_score_latency_ms.values["p(95)"] // "null"' /tmp/k6-fraud-smoke-results.json)
            error_rate=$(jq -r '.metrics.fraud_score_errors.values.rate // "0"' /tmp/k6-fraud-smoke-results.json)
            
            echo "p95_latency=$p95" >> $GITHUB_OUTPUT
            echo "error_rate=$error_rate" >> $GITHUB_OUTPUT
            
            # Check thresholds
            if (( $(echo "$p95 > 50" | bc -l) )); then
              echo "threshold_failed=true" >> $GITHUB_OUTPUT
              echo "::warning::p95 latency $p95ms exceeds 50ms threshold"
            else
              echo "threshold_failed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "No results file found"
            echo "threshold_failed=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: fraud-smoke-test-${{ env.ENVIRONMENT }}-${{ github.run_number }}
          path: |
            /tmp/k6-fraud-smoke-results.json
            /tmp/k6-output.log
          retention-days: 90
      
      - name: Store results in repository
        if: always()
        run: |
          mkdir -p quality/test-results/nightly
          RESULTS_FILE="quality/test-results/nightly/fraud-smoke-$(date +%Y%m%d-%H%M%S).json"
          cp /tmp/k6-fraud-smoke-results.json "$RESULTS_FILE"
          
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add "$RESULTS_FILE"
          git commit -m "Add nightly smoke test results for $ENVIRONMENT" || echo "No changes to commit"
          git push || echo "Push failed (expected on forks)"
      
      - name: Check for regressions
        id: regression_check
        run: |
          BASELINE_P95=45.0  # Baseline p95 latency in ms
          TOLERANCE_PCT=10   # 10% tolerance
          
          if [ -f /tmp/k6-fraud-smoke-results.json ]; then
            CURRENT_P95=$(jq -r '.metrics.fraud_score_latency_ms.values["p(95)"] // "0"' /tmp/k6-fraud-smoke-results.json)
            THRESHOLD=$(echo "$BASELINE_P95 * (1 + $TOLERANCE_PCT / 100)" | bc -l)
            
            if (( $(echo "$CURRENT_P95 > $THRESHOLD" | bc -l) )); then
              echo "regression_detected=true" >> $GITHUB_OUTPUT
              echo "::error::Performance regression detected: p95 $CURRENT_P95ms exceeds threshold $THRESHOLD ms"
            else
              echo "regression_detected=false" >> $GITHUB_OUTPUT
              echo "::notice::Performance within acceptable range: p95 $CURRENT_P95ms"
            fi
          fi
      
      - name: Send Slack notification on regression
        if: steps.regression_check.outputs.regression_detected == 'true'
        continue-on-error: true
        run: |
          echo "Slack notification would be sent here (configure SLACK_WEBHOOK_URL secret)"
          # Uncomment when secret is configured:
          # curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
          #   -H 'Content-Type: application/json' \
          #   -d '{
          #     "text": "ðŸš¨ Fraud Inference Performance Regression Detected",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ðŸš¨ Performance Regression Alert"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\n${{ env.ENVIRONMENT }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*p95 Latency:*\n${{ steps.parse_results.outputs.p95_latency }}ms"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Error Rate:*\n${{ steps.parse_results.outputs.error_rate }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Run:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"
                    }
                  ]
                }
              ]
            }'
      
      - name: Create GitHub Issue on regression
        if: steps.regression_check.outputs.regression_detected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `âš ï¸ Fraud Inference Performance Regression Detected - ${process.env.ENVIRONMENT}`,
              body: `## Performance Regression Alert
              
              **Environment:** ${process.env.ENVIRONMENT}
              **Date:** ${new Date().toISOString()}
              
              ### Metrics
              - **p95 Latency:** ${{ steps.parse_results.outputs.p95_latency }}ms (threshold: 50ms)
              - **Error Rate:** ${{ steps.parse_results.outputs.error_rate }}
              
              ### Action Required
              1. Review recent deployments
              2. Check infrastructure metrics
              3. Analyze test artifacts
              
              [View Test Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
              `,
              labels: ['performance', 'regression', 'ml-inference']
            });
            console.log('Created issue:', issue.data.html_url);
      
      - name: Summary
        if: always()
        run: |
          echo "## Smoke Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "**p95 Latency:** ${{ steps.parse_results.outputs.p95_latency }}ms" >> $GITHUB_STEP_SUMMARY
          echo "**Error Rate:** ${{ steps.parse_results.outputs.error_rate }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.regression_check.outputs.regression_detected }}" = "true" ]; then
            echo "âŒ **Performance regression detected**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Performance within acceptable range**" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Fail workflow on regression
        if: steps.regression_check.outputs.regression_detected == 'true'
        run: exit 1
