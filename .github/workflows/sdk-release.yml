name: SDK Release Automation

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'  # Semantic versioning: v1.0.0, v2.1.3, etc.
      - 'v[0-9]+.[0-9]+.[0-9]+-*' # Pre-releases: v1.0.0-beta.1, v1.0.0-rc.2

env:
  NODE_VERSION: '18'
  JAVA_VERSION: '17'
  RUBY_VERSION: '3.2'
  XCODE_VERSION: '15.0'

jobs:
  validate-version:
    name: Validate Semantic Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract.outputs.version }}
      is_prerelease: ${{ steps.extract.outputs.is_prerelease }}
    steps:
      - name: Extract version from tag
        id: extract
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # Check if pre-release (contains -, alpha, beta, rc)
          if [[ $VERSION =~ - ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi
          
          echo "üì¶ Release version: $VERSION"
          echo "üîñ Pre-release: $([[ $VERSION =~ - ]] && echo 'yes' || echo 'no')"

      - name: Validate semantic versioning
        run: |
          VERSION=${{ steps.extract.outputs.version }}
          # Regex: X.Y.Z or X.Y.Z-prerelease
          if ! [[ $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9\.]+)?$ ]]; then
            echo "‚ùå Invalid semantic version: $VERSION"
            echo "Expected format: X.Y.Z or X.Y.Z-prerelease"
            exit 1
          fi
          echo "‚úÖ Valid semantic version"

  generate-changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    needs: validate-version
    outputs:
      changelog: ${{ steps.generate.outputs.changelog }}
      breaking_changes: ${{ steps.analyze.outputs.breaking_changes }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install changelog generator
        run: npm install -g conventional-changelog-cli

      - name: Generate changelog
        id: generate
        run: |
          # Generate changelog from conventional commits
          conventional-changelog -p angular -i CHANGELOG.md -s -r 0
          
          # Extract latest version section
          CHANGELOG=$(awk '/^## \[/{if(++count==2) exit} count==1' CHANGELOG.md)
          
          # Save to output (escape newlines)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Analyze breaking changes
        id: analyze
        run: |
          # Check for BREAKING CHANGE in commit messages
          if git log --format=%B $(git describe --tags --abbrev=0 @^)..@ | grep -q "BREAKING CHANGE"; then
            echo "breaking_changes=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Breaking changes detected"
          else
            echo "breaking_changes=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No breaking changes"
          fi

      - name: Upload changelog artifact
        uses: actions/upload-artifact@v3
        with:
          name: changelog
          path: CHANGELOG.md

  build-ios-sdk:
    name: Build iOS SDK
    runs-on: macos-13
    needs: validate-version
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Install CocoaPods
        run: sudo gem install cocoapods

      - name: Update version in podspec
        working-directory: sdks/ios
        run: |
          VERSION=${{ needs.validate-version.outputs.version }}
          sed -i.bak "s/s.version *= *\".*\"/s.version = \"$VERSION\"/" ApexMediation.podspec
          rm ApexMediation.podspec.bak

      - name: Validate podspec
        working-directory: sdks/ios
        run: pod lib lint ApexMediation.podspec --allow-warnings

      - name: Build framework
        working-directory: sdks/ios
        run: |
          xcodebuild archive \
            -scheme ApexMediation \
            -destination "generic/platform=iOS" \
            -archivePath build/ApexMediation-iOS.xcarchive \
            SKIP_INSTALL=NO \
            BUILD_LIBRARY_FOR_DISTRIBUTION=YES

      - name: Create XCFramework
        working-directory: sdks/ios
        run: |
          xcodebuild -create-xcframework \
            -archive build/ApexMediation-iOS.xcarchive -framework ApexMediation.framework \
            -output build/ApexMediation.xcframework

      - name: Upload iOS artifact
        uses: actions/upload-artifact@v3
        with:
          name: ios-sdk
          path: sdks/ios/build/ApexMediation.xcframework

  build-android-sdk:
    name: Build Android SDK
    runs-on: ubuntu-latest
    needs: validate-version
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: Update version in build.gradle
        working-directory: sdks/android
        run: |
          VERSION=${{ needs.validate-version.outputs.version }}
          sed -i "s/version = \".*\"/version = \"$VERSION\"/" build.gradle.kts

      - name: Build AAR
        working-directory: sdks/android
        run: ./gradlew assembleRelease

      - name: Run tests
        working-directory: sdks/android
        run: ./gradlew test

      - name: Upload Android artifact
        uses: actions/upload-artifact@v3
        with:
          name: android-sdk
          path: sdks/android/build/outputs/aar/*.aar

  build-unity-sdk:
    name: Build Unity SDK
    runs-on: ubuntu-latest
    needs: validate-version
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Update package.json version
        working-directory: sdks/unity
        run: |
          VERSION=${{ needs.validate-version.outputs.version }}
          npm version $VERSION --no-git-tag-version

      - name: Create Unity package
        working-directory: sdks/unity
        run: |
          mkdir -p build
          # Unity packages are just folders with package.json
          cp -r package.json Runtime Editor build/
          cd build && tar -czf ../ApexMediation-Unity-${{ needs.validate-version.outputs.version }}.tgz .

      - name: Upload Unity artifact
        uses: actions/upload-artifact@v3
        with:
          name: unity-sdk
          path: sdks/unity/ApexMediation-Unity-*.tgz

  publish-cocoapods:
    name: Publish to CocoaPods
    runs-on: macos-13
    needs: [validate-version, generate-changelog, build-ios-sdk]
    if: needs.validate-version.outputs.is_prerelease == 'false'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download iOS artifact
        uses: actions/download-artifact@v3
        with:
          name: ios-sdk
          path: sdks/ios/build

      - name: Setup CocoaPods trunk
        env:
          COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
        run: |
          # CocoaPods trunk authentication
          mkdir -p ~/.cocoapods
          echo "$COCOAPODS_TRUNK_TOKEN" > ~/.cocoapods/trunk_token

      - name: Publish to CocoaPods
        working-directory: sdks/ios
        run: |
          pod trunk push ApexMediation.podspec --allow-warnings
          echo "‚úÖ Published to CocoaPods"

  publish-maven-central:
    name: Publish to Maven Central
    runs-on: ubuntu-latest
    needs: [validate-version, generate-changelog, build-android-sdk]
    if: needs.validate-version.outputs.is_prerelease == 'false'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Download Android artifact
        uses: actions/download-artifact@v3
        with:
          name: android-sdk
          path: sdks/android/build/outputs/aar

      - name: Setup GPG
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          # Import GPG key for signing
          echo "$GPG_PRIVATE_KEY" | base64 -d | gpg --batch --import
          echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
          gpgconf --kill gpg-agent

      - name: Publish to Maven Central
        working-directory: sdks/android
        env:
          OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          ./gradlew publishToMavenCentral --no-daemon
          echo "‚úÖ Published to Maven Central"

  publish-npm:
    name: Publish to NPM
    runs-on: ubuntu-latest
    needs: [validate-version, generate-changelog, build-unity-sdk]
    if: needs.validate-version.outputs.is_prerelease == 'false'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: Download Unity artifact
        uses: actions/download-artifact@v3
        with:
          name: unity-sdk
          path: sdks/unity

      - name: Publish to NPM
        working-directory: sdks/unity
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          npm publish --access public
          echo "‚úÖ Published to NPM"

  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: 
      - validate-version
      - generate-changelog
      - build-ios-sdk
      - build-android-sdk
      - build-unity-sdk
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Create release notes
        id: release_notes
        run: |
          VERSION=${{ needs.validate-version.outputs.version }}
          BREAKING=${{ needs.generate-changelog.outputs.breaking_changes }}
          
          cat > release_notes.md << EOF
          # ApexMediation SDK v$VERSION
          
          $([[ $BREAKING == "true" ]] && echo "‚ö†Ô∏è **BREAKING CHANGES** - See migration guide below")
          
          ## What's Changed
          
          ${{ needs.generate-changelog.outputs.changelog }}
          
          ## Installation
          
          ### iOS (CocoaPods)
          \`\`\`ruby
          pod 'ApexMediation', '~> $VERSION'
          \`\`\`
          
          ### Android (Gradle)
          \`\`\`groovy
          implementation 'com.apexmediation:sdk:$VERSION'
          \`\`\`
          
          ### Unity (NPM)
          \`\`\`bash
          npm install @apexmediation/unity-sdk@$VERSION
          \`\`\`
          
          ## Documentation
          
          - [iOS Integration Guide](https://docs.apexmediation.com/ios)
          - [Android Integration Guide](https://docs.apexmediation.com/android)
          - [Unity Integration Guide](https://docs.apexmediation.com/unity)
          $([[ $BREAKING == "true" ]] && echo "- [Migration Guide v$VERSION](https://docs.apexmediation.com/migration/v$VERSION)")
          
          ## Support
          
          - Discord: https://discord.gg/apexmediation
          - Email: support@apexmediation.com
          - Docs: https://docs.apexmediation.com
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: v${{ needs.validate-version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ needs.validate-version.outputs.is_prerelease }}
          files: |
            ios-sdk/**/*
            android-sdk/**/*.aar
            unity-sdk/**/*.tgz
            changelog/CHANGELOG.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-customers:
    name: Notify Customers
    runs-on: ubuntu-latest
    needs:
      - validate-version
      - generate-changelog
      - create-github-release
      - publish-cocoapods
      - publish-maven-central
      - publish-npm
    if: always() && needs.validate-version.outputs.is_prerelease == 'false'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        working-directory: backend
        run: npm ci

      - name: Trigger customer notification
        working-directory: backend
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
        run: |
          # Emit SDK update event to email service
          node -e "
          const { Pool } = require('pg');
          const pool = new Pool({ connectionString: process.env.DATABASE_URL });
          
          const eventData = {
            version: '${{ needs.validate-version.outputs.version }}',
            changelog: \`${{ needs.generate-changelog.outputs.changelog }}\`,
            breaking_changes: ${{ needs.generate-changelog.outputs.breaking_changes }},
            release_url: 'https://github.com/${{ github.repository }}/releases/tag/v${{ needs.validate-version.outputs.version }}'
          };
          
          pool.query(
            'INSERT INTO events (event_type, data, created_at) VALUES (\$1, \$2, NOW())',
            ['email.sdk_update', JSON.stringify(eventData)]
          ).then(() => {
            console.log('‚úÖ Customer notification event emitted');
            process.exit(0);
          }).catch(err => {
            console.error('‚ùå Failed to emit notification:', err);
            process.exit(1);
          });
          "

  rollback-on-failure:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs:
      - validate-version
      - publish-cocoapods
      - publish-maven-central
      - publish-npm
    if: failure()
    steps:
      - name: Alert on failure
        run: |
          echo "‚ùå SDK release failed for v${{ needs.validate-version.outputs.version }}"
          echo "Manual intervention required:"
          echo "1. Check failed job logs"
          echo "2. Verify package manager credentials"
          echo "3. Delete git tag if needed: git push --delete origin v${{ needs.validate-version.outputs.version }}"
          echo "4. Fix issues and re-tag"

      - name: Create issue for failed release
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Failed SDK Release: v${{ needs.validate-version.outputs.version }}',
              body: `## Release Failure\n\n**Version:** v${{ needs.validate-version.outputs.version }}\n**Workflow:** ${context.workflow}\n**Run:** ${context.runNumber}\n\n[View failed workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId})\n\n### Action Required\n1. Review failed jobs\n2. Fix credentials/configuration\n3. Delete tag: \`git push --delete origin v${{ needs.validate-version.outputs.version }}\`\n4. Re-release after fixes`,
              labels: ['release', 'critical', 'automation']
            })
