name: Kill Switch Smoke Test

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
  schedule:
    # Run weekly on Sunday at 2 AM UTC
    - cron: '0 2 * * 0'

env:
  STAGING_API: ${{ secrets.STAGING_API_URL || 'https://api-staging.apexmediation.ee' }}
  PRODUCTION_API: ${{ secrets.PRODUCTION_API_URL || 'https://api.apexmediation.ee' }}

jobs:
  kill-switch-smoke-test:
    name: Kill Switch Smoke Test
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Determine API endpoint
        id: api
        run: |
          if [ "${{ github.event.inputs.environment }}" = "production" ]; then
            echo "url=${{ env.PRODUCTION_API }}" >> $GITHUB_OUTPUT
            echo "Using production API"
          else
            echo "url=${{ env.STAGING_API }}" >> $GITHUB_OUTPUT
            echo "Using staging API"
          fi

      - name: Run kill switch smoke test
        id: smoke_test
        env:
          STAGING_API: ${{ steps.api.outputs.url }}
          TEST_API_KEY: ${{ secrets.SDK_TEST_API_KEY }}
          ADMIN_API_KEY: ${{ secrets.ADMIN_API_KEY }}
          TEST_PLACEMENT_ID: ${{ vars.TEST_PLACEMENT_ID || 'test_banner_1' }}
        run: |
          chmod +x scripts/smoke-tests/kill-switch-smoke-test.sh
          
          # Run the smoke test and capture output
          set +e
          ./scripts/smoke-tests/kill-switch-smoke-test.sh 2>&1 | tee smoke-test-output.txt
          EXIT_CODE=$?
          set -e
          
          # Parse results
          PASSED=$(grep -c "\[PASS\]" smoke-test-output.txt || echo "0")
          FAILED=$(grep -c "\[FAIL\]" smoke-test-output.txt || echo "0")
          
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          exit $EXIT_CODE

      - name: Generate test report
        if: always()
        run: |
          cat > smoke-test-report.md << EOF
          # Kill Switch Smoke Test Report
          
          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Environment:** ${{ github.event.inputs.environment || 'staging' }}
          **Commit:** ${{ github.sha }}
          **Run ID:** ${{ github.run_id }}
          
          ## Results
          
          - ‚úÖ Passed: ${{ steps.smoke_test.outputs.passed }}
          - ‚ùå Failed: ${{ steps.smoke_test.outputs.failed }}
          
          ## Test Output
          
          \`\`\`
          $(cat smoke-test-output.txt)
          \`\`\`
          
          ## Kill Switch Verification
          
          | Test | Status |
          |------|--------|
          | Global kill switch | $(grep -q "Global kill switch returned" smoke-test-output.txt && echo "‚úÖ" || echo "‚ùå") |
          | Adapter kill switch | $(grep -q "Adapter.*excluded" smoke-test-output.txt && echo "‚úÖ" || echo "‚ùå") |
          | Placement kill switch | $(grep -q "Placement kill switch returned" smoke-test-output.txt && echo "‚úÖ" || echo "‚ùå") |
          | Response timing | $(grep -q "p50 latency acceptable" smoke-test-output.txt && echo "‚úÖ" || echo "‚ùå") |
          | SDK recovery | $(grep -q "recovered after kill switch" smoke-test-output.txt && echo "‚úÖ" || echo "‚ùå") |
          
          EOF

      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kill-switch-smoke-test-report
          path: |
            smoke-test-report.md
            smoke-test-output.txt

      - name: Post summary to PR/Release
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('smoke-test-report.md', 'utf8');
            
            // Add to job summary
            await core.summary
              .addRaw(report)
              .write();
            
            // If this is a release, add comment
            if (context.eventName === 'release') {
              await github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: context.sha,
                body: `## üîß Kill Switch Smoke Test Results\n\n` +
                      `**Passed:** ${{ steps.smoke_test.outputs.passed }}\n` +
                      `**Failed:** ${{ steps.smoke_test.outputs.failed }}\n\n` +
                      `See full report in [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
              });
            }

      - name: Alert on failure
        if: failure()
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "channel": "#sdk-alerts",
              "text": "üö® Kill Switch Smoke Test FAILED",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*üö® Kill Switch Smoke Test FAILED*\n\nThe kill switch functionality is not working correctly.\n\n*Environment:* ${{ github.event.inputs.environment || 'staging' }}\n*Commit:* `${{ github.sha }}`\n*Run:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Passed:* ${{ steps.smoke_test.outputs.passed }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Failed:* ${{ steps.smoke_test.outputs.failed }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "‚ö†Ô∏è *DO NOT RELEASE* until kill switch is verified working!"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_SDK_ALERTS_WEBHOOK }}

  sdk-kill-switch-unit-tests:
    name: SDK Kill Switch Unit Tests
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            sdk: android
          - os: macos-latest
            sdk: ios
          - os: ubuntu-latest
            sdk: web

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java (Android)
        if: matrix.sdk == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Xcode (iOS)
        if: matrix.sdk == 'ios'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Setup Node.js (Web)
        if: matrix.sdk == 'web'
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Run Android kill switch tests
        if: matrix.sdk == 'android'
        working-directory: sdk/core/android
        run: |
          chmod +x ./gradlew
          ./gradlew testDebugUnitTest --tests "*KillSwitch*" --tests "*killSwitch*"

      - name: Run iOS kill switch tests
        if: matrix.sdk == 'ios'
        working-directory: sdk/core/ios
        run: |
          xcodebuild test \
            -scheme ApexMediationSDK \
            -destination 'platform=iOS Simulator,name=iPhone 15' \
            -only-testing:ApexMediationSDKTests/KillSwitchTests \
            -resultBundlePath TestResults \
            | xcpretty

      - name: Run Web SDK kill switch tests
        if: matrix.sdk == 'web'
        working-directory: Packages/web-sdk
        run: |
          npm ci
          npm test -- --testPathPattern="killSwitch" --forceExit

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kill-switch-tests-${{ matrix.sdk }}
          path: |
            **/build/reports/**
            **/TestResults/**
            **/coverage/**

  verify-kill-switch-in-release:
    name: Verify Kill Switch in Release
    runs-on: ubuntu-latest
    needs: [kill-switch-smoke-test, sdk-kill-switch-unit-tests]
    if: github.event_name == 'release'

    steps:
      - name: Check all tests passed
        run: |
          echo "Kill switch smoke test: ${{ needs.kill-switch-smoke-test.result }}"
          echo "SDK unit tests: ${{ needs.sdk-kill-switch-unit-tests.result }}"
          
          if [ "${{ needs.kill-switch-smoke-test.result }}" != "success" ]; then
            echo "‚ùå Kill switch smoke test failed"
            exit 1
          fi
          
          if [ "${{ needs.sdk-kill-switch-unit-tests.result }}" != "success" ]; then
            echo "‚ùå SDK kill switch unit tests failed"
            exit 1
          fi
          
          echo "‚úÖ All kill switch tests passed"
          echo "Safe to release!"

      - name: Add release check
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: 'success',
              context: 'kill-switch-verified',
              description: 'Kill switch functionality verified'
            });
