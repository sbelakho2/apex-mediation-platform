name: iOS SDK CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'sdk/core/ios/**'
      - 'sdk/ctv/tvos/**'
      - '.github/workflows/ios-sdk.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'sdk/core/ios/**'
      - 'sdk/ctv/tvos/**'
      - '.github/workflows/ios-sdk.yml'

jobs:
  ios-tests:
    name: iOS/tvOS Tests
    runs-on: macos-14
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: ios
            destination: "platform=iOS Simulator,name=iPhone 15"
            sdk: iphonesimulator
          - platform: tvos
            destination: "platform=tvOS Simulator,name=Apple TV"
            sdk: appletvsimulator
    defaults:
      run:
        working-directory: sdk/core/ios
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install xcpretty
        run: |
          gem install xcpretty --no-document

      - name: Xcode version
        run: |
          xcodebuild -version
          sw_vers

      - name: Resolve SwiftPM dependencies
        run: |
          swift package resolve

      - name: Determine Xcode schemes
        id: scheme
        shell: bash
        run: |
          set -euo pipefail
          # Try to find an auto-generated package scheme first, then fall back to target name
          SCHEME=""
          if xcodebuild -list -json 2>/dev/null | grep -q '"RivalApexMediationSDK-Package"'; then
            SCHEME="RivalApexMediationSDK-Package"
          elif xcodebuild -list -json 2>/dev/null | grep -q '"RivalApexMediationSDK"'; then
            SCHEME="RivalApexMediationSDK"
          else
            echo "Available schemes:" >&2
            xcodebuild -list || true
            echo "::error::Could not find expected Xcode scheme for the package." >&2
            exit 1
          fi
          echo "Using scheme: $SCHEME"
          echo "scheme=$SCHEME" >> "$GITHUB_OUTPUT"

      - name: Build and test (${{ matrix.platform }})
        env:
          SCHEME: ${{ steps.scheme.outputs.scheme }}
        run: |
          set -euo pipefail
          LOG_DIR="./build/logs"
          mkdir -p "$LOG_DIR"
          LOG_FILE="$LOG_DIR/xcodebuild-${{ matrix.platform }}.log"
          RESULT_DIR="./build/xcresults"
          mkdir -p "$RESULT_DIR"
          RESULT_BUNDLE_PATH="$RESULT_DIR/${{ matrix.platform }}.xcresult"
          # Clean then test for the specified simulator destination
          xcodebuild \
            -scheme "$SCHEME" \
            -sdk ${{ matrix.sdk }} \
            -destination '${{ matrix.destination }}' \
            -resultBundlePath "$RESULT_BUNDLE_PATH" \
            clean test \
            -enableCodeCoverage YES \
            -quiet \
            | tee "$LOG_FILE" \
            | xcpretty || {
              echo "xcodebuild failed; raw log at $LOG_FILE" >&2
              exit 1
            }

      - name: Upload xcodebuild log (${{ matrix.platform }})
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ios-xcodebuild-logs-${{ matrix.platform }}
          path: sdk/core/ios/build/logs/xcodebuild-${{ matrix.platform }}.log
          if-no-files-found: error

      - name: Upload xcresult bundle (${{ matrix.platform }})
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ios-xcresult-${{ matrix.platform }}
          path: sdk/core/ios/build/xcresults/${{ matrix.platform }}.xcresult
          if-no-files-found: warn

  ios-docs:
    name: iOS Docs
    runs-on: macos-14
    needs: ios-tests
    defaults:
      run:
        working-directory: sdk/core/ios
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Jazzy
        run: |
          gem install jazzy --no-document

      - name: Generate docs (DocC/Jazzy)
        working-directory: .
        run: |
          bash ../../../scripts/ios-docs.sh

      - name: Upload iOS docs archive
        uses: actions/upload-artifact@v4
        with:
          name: ios-sdk-docs
          path: sdk/core/ios/build/ios-docs.zip
          if-no-files-found: error
