name: Website â€” Full-page Screenshot Capture (manual)

on:
  workflow_dispatch:
    inputs:
      browsers:
        description: "Browsers to use (chromium|all)"
        required: false
        default: "chromium"
      baseUrl:
        description: "Base URL (override to capture against a deployed site)"
        required: false
        default: "http://localhost:3000"

jobs:
  capture:
    name: Capture full-page screenshots
    timeout-minutes: 30
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18.20.4'

      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
            website/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install root deps
        run: npm ci

      - name: Install website deps
        working-directory: website
        run: npm ci

      - name: Build website
        working-directory: website
        run: npm run build

      - name: Start website (background)
        working-directory: website
        run: |
          npm run start &
          echo $! > ../website.pid
        shell: bash

      - name: Wait for website to be ready
        run: |
          for i in {1..60}; do
            if curl -fsS ${{ github.event.inputs.baseUrl || 'http://localhost:3000' }} >/dev/null; then
              echo "Website is up"; exit 0; fi; sleep 1; done; echo "Site did not start"; exit 1

      - name: Install Playwright browsers
        run: npx playwright install --with-deps ${{ github.event.inputs.browsers == 'all' && '' || 'chromium' }}

      - name: Capture screenshots
        env:
          WEBSITE_BASE_URL: ${{ github.event.inputs.baseUrl || 'http://localhost:3000' }}
          BROWSERS: ${{ github.event.inputs.browsers == 'all' && 'all' || '' }}
        run: node quality/tools/capture-website-screenshots.js

      - name: Upload screenshots artifact
        uses: actions/upload-artifact@v4
        with:
          name: website-screenshots
          path: artifacts/website-screenshots/**
          retention-days: 30

      - name: Stop website
        if: always()
        run: |
          if [ -f website.pid ]; then kill $(cat website.pid) || true; fi
