# Prometheus recording rules for precomputing common aggregations
# These rules improve dashboard performance and simplify alert expressions
groups:
  # API Request metrics - precompute rate calculations
  - name: api_request_rates
    interval: 30s
    rules:
      # Total request rate by route and method
      - record: job:http_requests:rate5m
        expr: sum(rate(http_requests_total[5m])) by (job, route, method)

      # Total request rate by job only
      - record: job:http_requests:rate5m_total
        expr: sum(rate(http_requests_total[5m])) by (job)

      # Error rate (5xx) by route
      - record: job:http_requests_5xx:rate5m
        expr: sum(rate(http_requests_total{status=~"5.."}[5m])) by (job, route, method)

      # Error rate percentage by route
      - record: job:http_requests_5xx:rate5m_percentage
        expr: |
          (
            sum(rate(http_requests_total{status=~"5.."}[5m])) by (job, route)
            / 
            sum(rate(http_requests_total[5m])) by (job, route)
          ) * 100

      # 4xx client error rate
      - record: job:http_requests_4xx:rate5m
        expr: sum(rate(http_requests_total{status=~"4.."}[5m])) by (job, route, method)

  # API Latency metrics - precompute histogram quantiles
  - name: api_latency_quantiles
    interval: 30s
    rules:
      # p50 latency by route
      - record: job:http_request_duration_seconds:p50
        expr: histogram_quantile(0.50, sum(rate(http_request_duration_seconds_bucket[5m])) by (job, route, le))

      # p95 latency by route
      - record: job:http_request_duration_seconds:p95
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (job, route, le))

      # p99 latency by route
      - record: job:http_request_duration_seconds:p99
        expr: histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket[5m])) by (job, route, le))

      # p95 latency aggregated across all routes
      - record: job:http_request_duration_seconds:p95_total
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (job, le))

  # RTB Auction metrics
  - name: rtb_aggregates
    interval: 30s
    rules:
      # Total auction rate
      - record: job:rtb_auctions:rate5m
        expr: sum(rate(auction_latency_seconds_count[5m])) by (job)

      # Win rate by adapter
      - record: job:rtb_wins:rate5m_by_adapter
        expr: sum(rate(rtb_wins_total[5m])) by (job, adapter)

      # No-fill rate
      - record: job:rtb_no_fill:rate5m
        expr: sum(rate(rtb_no_fill_total[5m])) by (job)

      # No-fill percentage
      - record: job:rtb_no_fill:rate5m_percentage
        expr: |
          (
            sum(rate(rtb_no_fill_total[5m])) by (job)
            /
            sum(rate(auction_latency_seconds_count[5m])) by (job)
          ) * 100

      # Adapter timeout rate
      - record: job:rtb_adapter_timeouts:rate5m_by_adapter
        expr: sum(rate(rtb_adapter_timeouts_total[5m])) by (job, adapter)

      # Auction latency p50
      - record: job:auction_latency_seconds:p50
        expr: histogram_quantile(0.50, sum(rate(auction_latency_seconds_bucket[5m])) by (job, le))

      # Auction latency p95
      - record: job:auction_latency_seconds:p95
        expr: histogram_quantile(0.95, sum(rate(auction_latency_seconds_bucket[5m])) by (job, le))

      # Auction latency p99
      - record: job:auction_latency_seconds:p99
        expr: histogram_quantile(0.99, sum(rate(auction_latency_seconds_bucket[5m])) by (job, le))

      # Adapter latency p95 by adapter
      - record: job:rtb_adapter_latency_seconds:p95_by_adapter
        expr: histogram_quantile(0.95, sum(rate(rtb_adapter_latency_seconds_bucket[5m])) by (job, adapter, le))

  # Analytics/Tracking metrics
  - name: analytics_aggregates
    interval: 30s
    rules:
      # Event enqueue rate
      - record: job:analytics_events_enqueued:rate5m
        expr: sum(rate(analytics_events_enqueued_total[5m])) by (job)

      # Event write rate
      - record: job:analytics_events_written:rate5m
        expr: sum(rate(analytics_events_written_total[5m])) by (job)

      # Event failure rate
      - record: job:analytics_events_failed:rate5m
        expr: sum(rate(analytics_events_failed_total[5m])) by (job)

      # Event failure percentage
      - record: job:analytics_events_failed:rate5m_percentage
        expr: |
          (
            sum(rate(analytics_events_failed_total[5m])) by (job)
            /
            sum(rate(analytics_events_enqueued_total[5m])) by (job)
          ) * 100

      # Event processing lag (enqueued - written)
      - record: job:analytics_events:processing_lag
        expr: |
          clamp_min(
            sum(rate(analytics_events_enqueued_total[5m])) by (job)
            -
            sum(rate(analytics_events_written_total[5m])) by (job),
            0
          )

      # Rate limiting rate
      - record: job:tracking_rate_limited:rate5m
        expr: sum(rate(tracking_rate_limited_total[5m])) by (job)

      # Blocking rate
      - record: job:tracking_blocked:rate5m
        expr: sum(rate(tracking_blocked_total[5m])) by (job)

  # Database and Queue health
  - name: db_queue_aggregates
    interval: 30s
    rules:
      # DB query latency p50
      - record: job:db_query_duration_seconds:p50
        expr: histogram_quantile(0.50, sum(rate(db_query_duration_seconds_bucket[5m])) by (job, le))

      # DB query latency p95
      - record: job:db_query_duration_seconds:p95
        expr: histogram_quantile(0.95, sum(rate(db_query_duration_seconds_bucket[5m])) by (job, le))

      # DB query latency p99
      - record: job:db_query_duration_seconds:p99
        expr: histogram_quantile(0.99, sum(rate(db_query_duration_seconds_bucket[5m])) by (job, le))

      # DB query rate
      - record: job:db_queries:rate5m
        expr: sum(rate(db_query_duration_seconds_count[5m])) by (job)

      # Slow query count (>1s)
      - record: job:db_queries_slow:rate5m
        expr: sum(rate(db_query_duration_seconds_bucket{le="1.0"}[5m])) by (job)

      # Total queue depth across all queues
      - record: job:queue_depth:sum
        expr: sum(queue_depth) by (job)

      # Queue depth by queue name
      - record: job:queue_depth:sum_by_queue
        expr: sum(queue_depth) by (job, queue)

      # Queue job completion rate
      - record: job:queue_jobs_completed:rate5m
        expr: sum(rate(queue_jobs_completed_total[5m])) by (job, queue)

      # Queue job failure rate
      - record: job:queue_jobs_failed:rate5m
        expr: sum(rate(queue_jobs_failed_total[5m])) by (job, queue)

      # Queue job failure percentage
      - record: job:queue_jobs_failed:rate5m_percentage
        expr: |
          (
            sum(rate(queue_jobs_failed_total[5m])) by (job, queue)
            /
            (sum(rate(queue_jobs_completed_total[5m])) by (job, queue) + sum(rate(queue_jobs_failed_total[5m])) by (job, queue))
          ) * 100

      # Queue backlog age (time since oldest job)
      - record: job:queue_backlog_age_seconds:max
        expr: max(time() - queue_oldest_job_timestamp) by (job, queue)

  # System resource metrics
  - name: system_resources
    interval: 30s
    rules:
      # CPU usage percentage
      - record: instance:cpu_usage:percentage
        expr: 100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)

      # Memory usage percentage
      - record: instance:memory_usage:percentage
        expr: |
          (
            (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes)
            /
            node_memory_MemTotal_bytes
          ) * 100

      # Disk usage percentage
      - record: instance:disk_usage:percentage
        expr: |
          (
            (node_filesystem_size_bytes{fstype!~"tmpfs|fuse.lxcfs"} - node_filesystem_avail_bytes{fstype!~"tmpfs|fuse.lxcfs"})
            /
            node_filesystem_size_bytes{fstype!~"tmpfs|fuse.lxcfs"}
          ) * 100

  # Business metrics - hourly aggregates for long-term trends
  - name: business_metrics_hourly
    interval: 5m
    rules:
      # Total revenue (hourly)
      - record: job:revenue_usd:increase1h
        expr: sum(increase(revenue_usd_total[1h])) by (job)

      # Total impressions (hourly)
      - record: job:impressions:increase1h
        expr: sum(increase(impressions_total[1h])) by (job)

      # Fill rate percentage (hourly)
      - record: job:fill_rate:percentage1h
        expr: |
          clamp_min(
            (
              1 - (
                sum(increase(rtb_no_fill_total[1h])) by (job)
                /
                sum(increase(auction_latency_seconds_count[1h])) by (job)
              )
            ) * 100,
            0
          )

      # Average CPM (hourly)
      - record: job:cpm_usd:avg1h
        expr: |
          (
            sum(increase(revenue_usd_total[1h])) by (job)
            /
            sum(increase(impressions_total[1h])) by (job)
          ) * 1000
