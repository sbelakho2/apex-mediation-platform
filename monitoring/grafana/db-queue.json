{
  "annotations": { "list": [] },
  "editable": true,
  "gnetId": null,
  "graphTooltip": 1,
  "id": null,
  "links": [],
  "panels": [
    {
      "type": "stat",
      "title": "DB Query p95 Latency",
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum by (le) (rate(db_query_duration_seconds_bucket[5m])))",
          "legendFormat": "p95"
        }
      ],
      "gridPos": { "w": 6, "h": 4, "x": 0, "y": 0 },
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "decimals": 3,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "value": null, "color": "green" },
              { "value": 0.5, "color": "yellow" },
              { "value": 1.0, "color": "red" }
            ]
          }
        }
      }
    },
    {
      "type": "stat",
      "title": "DB Query p99 Latency",
      "targets": [
        {
          "expr": "histogram_quantile(0.99, sum by (le) (rate(db_query_duration_seconds_bucket[5m])))",
          "legendFormat": "p99"
        }
      ],
      "gridPos": { "w": 6, "h": 4, "x": 6, "y": 0 },
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "decimals": 3,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "value": null, "color": "green" },
              { "value": 1.0, "color": "yellow" },
              { "value": 2.0, "color": "red" }
            ]
          }
        }
      }
    },
    {
      "type": "stat",
      "title": "Queue Depth",
      "targets": [
        {
          "expr": "sum(queue_depth{queue=~\"$queue\"})",
          "legendFormat": "depth"
        }
      ],
      "gridPos": { "w": 6, "h": 4, "x": 12, "y": 0 },
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "value": null, "color": "green" },
              { "value": 1000, "color": "yellow" },
              { "value": 5000, "color": "red" }
            ]
          }
        }
      }
    },
    {
      "type": "stat",
      "title": "Queue Backlog Age",
      "targets": [
        {
          "expr": "max(time() - queue_oldest_job_timestamp{queue=~\"$queue\"})",
          "legendFormat": "age"
        }
      ],
      "gridPos": { "w": 6, "h": 4, "x": 18, "y": 0 },
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "value": null, "color": "green" },
              { "value": 300, "color": "yellow" },
              { "value": 900, "color": "red" }
            ]
          }
        }
      }
    },
    {
      "type": "stat",
      "title": "Replica Replay Lag (ms)",
      "targets": [
        {
          "expr": "(max(pg_stat_replication_replay_lag) * 1000) or vector(0)",
          "legendFormat": "replay"
        }
      ],
      "gridPos": { "w": 6, "h": 4, "x": 0, "y": 4 },
      "fieldConfig": {
        "defaults": {
          "unit": "ms",
          "decimals": 0,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "value": null, "color": "green" },
              { "value": 1000, "color": "yellow" },
              { "value": 5000, "color": "red" }
            ]
          }
        }
      }
    },
    {
      "type": "stat",
      "title": "Replica Write Lag (ms)",
      "targets": [
        {
          "expr": "(max(pg_stat_replication_write_lag) * 1000) or vector(0)",
          "legendFormat": "write"
        }
      ],
      "gridPos": { "w": 6, "h": 4, "x": 6, "y": 4 },
      "fieldConfig": {
        "defaults": {
          "unit": "ms",
          "decimals": 0,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "value": null, "color": "green" },
              { "value": 1000, "color": "yellow" },
              { "value": 5000, "color": "red" }
            ]
          }
        }
      }
    },
    {
      "type": "stat",
      "title": "Buffer Cache Hit (%)",
      "targets": [
        {
          "expr": "clamp_max(clamp_min(100 * sum(pg_stat_database_blks_hit{datname!~\"template.*\"}) / sum(pg_stat_database_blks_hit{datname!~\"template.*\"} + pg_stat_database_blks_read{datname!~\"template.*\"}), 0), 100)",
          "legendFormat": "hit%"
        }
      ],
      "gridPos": { "w": 6, "h": 4, "x": 12, "y": 4 },
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "decimals": 2,
          "max": 100,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "value": null, "color": "red" },
              { "value": 95, "color": "yellow" },
              { "value": 98, "color": "green" }
            ]
          }
        }
      }
    },
    {
      "type": "stat",
      "title": "Staging Rows Pending",
      "targets": [
        {
          "expr": "(sum(pg_stat_user_tables_n_live_tup{relname=~\"analytics_.*_stage|transparency_.*_stage\"})) or vector(0)",
          "legendFormat": "rows"
        }
      ],
      "gridPos": { "w": 6, "h": 4, "x": 18, "y": 4 },
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "value": null, "color": "green" },
              { "value": 250000, "color": "yellow" },
              { "value": 500000, "color": "red" }
            ]
          }
        }
      }
    },
    {
      "type": "timeseries",
      "title": "DB Query Duration Percentiles",
      "targets": [
        {
          "expr": "histogram_quantile(0.50, sum by (le) (rate(db_query_duration_seconds_bucket[5m])))",
          "legendFormat": "p50"
        },
        {
          "expr": "histogram_quantile(0.95, sum by (le) (rate(db_query_duration_seconds_bucket[5m])))",
          "legendFormat": "p95"
        },
        {
          "expr": "histogram_quantile(0.99, sum by (le) (rate(db_query_duration_seconds_bucket[5m])))",
          "legendFormat": "p99"
        }
      ],
      "gridPos": { "w": 12, "h": 8, "x": 0, "y": 8 },
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10
          }
        }
      }
    },
    {
      "type": "timeseries",
      "title": "DB Query Duration by Operation",
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum by (le, operation) (rate(db_query_duration_seconds_bucket[5m])))",
          "legendFormat": "{{operation}} p95"
        }
      ],
      "gridPos": { "w": 12, "h": 8, "x": 12, "y": 8 },
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 0
          }
        }
      }
    },
    {
      "type": "timeseries",
      "title": "Replica Lag by Replica (ms)",
      "targets": [
        {
          "expr": "sum by (application_name) (pg_stat_replication_replay_lag * 1000)",
          "legendFormat": "{{application_name}}"
        }
      ],
      "gridPos": { "w": 12, "h": 8, "x": 0, "y": 16 },
      "fieldConfig": {
        "defaults": {
          "unit": "ms",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10
          }
        }
      }
    },
    {
      "type": "timeseries",
      "title": "Staging Rows by Table",
      "targets": [
        {
          "expr": "sum by (relname) (pg_stat_user_tables_n_live_tup{relname=~\"analytics_.*_stage|transparency_.*_stage\"})",
          "legendFormat": "{{relname}}"
        }
      ],
      "gridPos": { "w": 12, "h": 8, "x": 12, "y": 16 },
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 20
          }
        }
      }
    },
    {
      "type": "table",
      "title": "Slow Queries (>1s, 5m window)",
      "targets": [
        {
          "expr": "topk(10, sum by (query_name, operation) (rate(db_query_duration_seconds_bucket{le=\"+Inf\"}[5m])) > 1)",
          "legendFormat": "{{query_name}}",
          "format": "table",
          "instant": true
        }
      ],
      "gridPos": { "w": 12, "h": 8, "x": 0, "y": 24 },
      "transformations": [
        {
          "id": "organize",
          "options": {
            "renameByName": {
              "query_name": "Query",
              "operation": "Operation",
              "Value": "Rate (qps)"
            }
          }
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "DB Connection Pool Utilization",
      "targets": [
        {
          "expr": "db_pool_active_connections / db_pool_max_connections * 100",
          "legendFormat": "utilization %"
        }
      ],
      "gridPos": { "w": 12, "h": 8, "x": 12, "y": 24 },
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "max": 100,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "value": null, "color": "green" },
              { "value": 70, "color": "yellow" },
              { "value": 90, "color": "red" }
            ]
          }
        }
      }
    },
    {
      "type": "timeseries",
      "title": "Queue Depth by Queue",
      "targets": [
        {
          "expr": "sum by (queue) (queue_depth{queue=~\"$queue\"})",
          "legendFormat": "{{queue}}"
        }
      ],
      "gridPos": { "w": 12, "h": 8, "x": 0, "y": 32 },
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10
          }
        }
      }
    },
    {
      "type": "timeseries",
      "title": "Queue Processing Rate",
      "targets": [
        {
          "expr": "sum by (queue) (rate(queue_jobs_completed_total{queue=~\"$queue\"}[5m]))",
          "legendFormat": "{{queue}} completed"
        },
        {
          "expr": "sum by (queue) (rate(queue_jobs_failed_total{queue=~\"$queue\"}[5m]))",
          "legendFormat": "{{queue}} failed"
        }
      ],
      "gridPos": { "w": 12, "h": 8, "x": 12, "y": 32 },
      "fieldConfig": {
        "defaults": {
          "unit": "reqps",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10
          }
        }
      }
    },
    {
      "type": "timeseries",
      "title": "Queue Backlog Growth Rate",
      "targets": [
        {
          "expr": "deriv(sum by (queue) (queue_depth{queue=~\"$queue\"})[5m:])",
          "legendFormat": "{{queue}} growth rate"
        }
      ],
      "gridPos": { "w": 24, "h": 8, "x": 0, "y": 40 },
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 20
          }
        }
      }
    },
    {
      "type": "table",
      "title": "Queue Summary (5m)",
      "targets": [
        {
          "expr": "sum by (queue) (queue_depth{queue=~\"$queue\"})",
          "legendFormat": "{{queue}}",
          "format": "table",
          "instant": true
        },
        {
          "expr": "sum by (queue) (increase(queue_jobs_completed_total{queue=~\"$queue\"}[5m]))",
          "legendFormat": "{{queue}}",
          "format": "table",
          "instant": true
        },
        {
          "expr": "sum by (queue) (increase(queue_jobs_failed_total{queue=~\"$queue\"}[5m]))",
          "legendFormat": "{{queue}}",
          "format": "table",
          "instant": true
        }
      ],
      "gridPos": { "w": 24, "h": 8, "x": 0, "y": 48 },
      "transformations": [
        {
          "id": "merge",
          "options": {}
        },
        {
          "id": "organize",
          "options": {
            "renameByName": {
              "queue": "Queue",
              "Value #A": "Depth",
              "Value #B": "Completed (5m)",
              "Value #C": "Failed (5m)"
            }
          }
        }
      ]
    }
  ],
  "refresh": "30s",
  "schemaVersion": 36,
  "style": "dark",
  "tags": ["database", "queue", "performance"],
  "templating": {
    "list": [
      {
        "name": "queue_filter",
        "type": "query",
        "label": "Queue",
        "datasource": "Prometheus",
        "definition": "label_values(queue_depth, queue)",
        "query": "label_values(queue_depth, queue)",
        "refresh": 2,
        "includeAll": true,
        "allValue": ".*",
        "multi": true,
        "current": {
          "selected": true,
          "text": "All queues",
          "value": ".*"
        },
        "sort": 1,
        "description": "Regex queue selector applied to every panel so large installs can focus on one or more queues."
      }
    ]
  },
  "timezone": "",
  "title": "Database & Queue Health",
  "uid": "db-queue",
  "version": 2
}
