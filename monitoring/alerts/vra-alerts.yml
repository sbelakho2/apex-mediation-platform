groups:
  - name: vra-alerts
    rules:
      # Coverage drop > 5pp DoD (requires an external coverage metric; placeholder shown)
      - alert: VRA_Coverage_Drop_DoD
        expr: |
          (vra_coverage_percent{scope="pilot"} - (vra_coverage_percent{scope="pilot"} offset 1d)) < -5
        for: 30m
        labels:
          severity: warning
          service: vra
        annotations:
          summary: "VRA coverage dropped by more than 5pp day-over-day"
          description: "Coverage fell from {{ $value | printf "%.2f" }} pp DoD. Investigate ingestion/matching."
          runbook_url: "/-/blob/main/docs/Internal/VRA/RUNBOOK.md#coverage"

      # Variance > 1% for two consecutive days (placeholder metric)
      - alert: VRA_Unexplained_Variance_Sustained
        expr: vra_variance_percent{scope="pilot"} > 1
        for: 48h
        labels:
          severity: warning
          service: vra
        annotations:
          summary: "VRA unexplained variance exceeds 1% for 48h"
          description: "Variance above threshold for 2 days. Review reconcile rules and FX/IVT windows."
          runbook_url: "/-/blob/main/docs/Internal/VRA/RUNBOOK.md#reconcile"

      # Ingest schema drift spike (proxy by failures labeled reason)
      - alert: VRA_Ingest_Schema_Drift
        expr: increase(vra_statements_load_failures_total{reason="insert_failed"}[30m]) > 50
        for: 15m
        labels:
          severity: warning
          service: vra
        annotations:
          summary: "VRA ingestion failures spiking — possible schema drift"
          description: "Over 50 failures in 30m for writes to recon_statements_*; inspect network normalizers."
          runbook_url: "/-/blob/main/docs/Internal/VRA/RUNBOOK.md#ingestion"

      # FX stale > 48h — placeholder if such a metric exists; otherwise use verify failures on proofs or logs
      - alert: VRA_Proofs_Verify_Failures
        expr: increase(vra_proofs_verify_failures_total[30m]) > 0
        for: 10m
        labels:
          severity: warning
          service: vra
        annotations:
          summary: "VRA proofs verification failures detected"
          description: "One or more proofs failed verification in the last 30m. Inspect proofs_daily_roots and monthly digest."
          runbook_url: "/-/blob/main/docs/Internal/VRA/RUNBOOK.md#proofs"

      # Reconcile delta spike by kind (any kind emits continuously)
      - alert: VRA_Reconcile_Deltas_Spike
        expr: sum(rate(vra_reconcile_rows_total[5m])) > 50
        for: 10m
        labels:
          severity: warning
          service: vra
        annotations:
          summary: "VRA reconcile deltas spiking (>50/5m)"
          description: "Reconcile is emitting more than 50 deltas per 5 minutes across kinds. Check the Reconcile & Deltas dashboard."
          runbook_url: "/-/blob/main/docs/Internal/VRA/RUNBOOK.md#reconcile"

      # Analytics read-model failures for VRA operations elevating
      - alert: VRA_Query_Failures
        expr: sum(rate(vra_query_fail_total[5m])) > 0
        for: 15m
        labels:
          severity: warning
          service: vra
        annotations:
          summary: "VRA analytics read-model failures detected"
          description: "VRA operations are falling back to empty results for >15m. Inspect Postgres replica health and safeQuery logs."
          runbook_url: "/-/blob/main/docs/Internal/VRA/RUNBOOK.md#read-model-troubleshooting"
