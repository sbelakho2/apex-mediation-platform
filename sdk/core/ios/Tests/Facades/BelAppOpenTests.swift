import XCTest
@testable import RivalApexMediationSDK

#if canImport(UIKit)
import UIKit

@MainActor
final class BelAppOpenTests: XCTestCase {
    
    override func tearDown() {
        BelAppOpen.resetShowTimeLimit()
        super.tearDown()
    }
    
    func testIsReadyBeforeLoad() {
        XCTAssertFalse(BelAppOpen.isReady())
    }
    
    func testShowWithoutLoad() {
        let vc = UIViewController()
        let listener = CapturingAppOpenListener()
        
        let shown = BelAppOpen.show(from: vc, placementId: "app_open", listener: listener)
        
        XCTAssertFalse(shown, "Should not show when no ad is loaded")
        XCTAssertEqual(listener.failedPlacement, "app_open")
        XCTAssertEqual(listener.failedError as? SDKError, SDKError.noFill)
    }
    
    func testResetShowTimeLimit() {
        // Should not crash
        BelAppOpen.resetShowTimeLimit()
    }
    
    // Note: Rate limiting test would require time manipulation
    // or dependency injection, which could be added in future
}

private final class CapturingAppOpenListener: BelAdEventListener {
    var failedPlacement: String?
    var failedError: Error?
    func onAdFailedToShow(placementId: String, error: Error) {
        failedPlacement = placementId
        failedError = error
    }
}

#else

final class BelAppOpenTests: XCTestCase {
    func testUIKitUnavailable() throws {
        throw XCTSkip("UIKit not available on this platform")
    }
}

#endif
